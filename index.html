<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Quest Ultimate üåé</title>
    <meta name="description" content="Juego educativo para aprender espa√±ol - Modo historia, batallas 1v1, equipos y m√°s">
    <meta name="author" content="ShieldStack Technologies">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #FF6B35; --secondary: #004E89; --accent: #F7C948;
            --success: #2ECC71; --danger: #E74C3C; --dark: #1A1A2E;
            --darker: #12121f; --light: #FFF8F0; --purple: #9B59B6;
            --cyan: #00D9FF; --pink: #FF6B9D;
        }
        [data-theme="light"] { --dark: #F5F5F5; --darker: #E8E8E8; --light: #1A1A2E; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', sans-serif; background: var(--dark); min-height: 100vh; overflow-x: hidden; transition: background 0.3s; }
        .bg-pattern { position: fixed; inset: 0; background: radial-gradient(circle at 20% 80%, rgba(255,107,53,0.12) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(0,78,137,0.12) 0%, transparent 50%); z-index: 0; pointer-events: none; }
        .stars { position: fixed; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .star { position: absolute; width: 3px; height: 3px; background: white; border-radius: 50%; animation: twinkle 3s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.7; } }
        .confetti-container { position: fixed; inset: 0; pointer-events: none; z-index: 1000; overflow: hidden; }
        .confetti { position: absolute; width: 10px; height: 10px; top: -10px; animation: confetti-fall 3s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        header { position: relative; z-index: 10; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(26,26,46,0.95); backdrop-filter: blur(10px); border-bottom: 3px solid var(--accent); flex-wrap: wrap; gap: 12px; }
        .logo { font-family: 'Fredoka One', cursive; font-size: 1.5rem; background: linear-gradient(135deg, #FF6B35, #F7C948); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .header-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .stats-bar { display: flex; gap: 8px; flex-wrap: wrap; }
        .stat { display: flex; align-items: center; gap: 5px; color: var(--light); font-weight: 600; font-size: 0.8rem; background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .stat:hover { background: rgba(255,255,255,0.1); }
        .stat-value { color: var(--accent); font-weight: 800; }
        .toggle-btn { background: rgba(255,255,255,0.1); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .toggle-btn:hover { background: rgba(255,255,255,0.2); }
        .toggle-btn.playing { animation: pulse-glow 1s infinite; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px var(--accent); } 50% { box-shadow: 0 0 20px var(--accent); } }
        .volume-control { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 18px; }
        .volume-slider { width: 50px; height: 4px; -webkit-appearance: none; background: rgba(255,255,255,0.2); border-radius: 2px; cursor: pointer; }
        .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        .player-profile { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 20px; }
        .player-avatar { font-size: 1.5rem; animation: avatar-bounce 2s infinite; }
        @keyframes avatar-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-2px); } }
        .player-info { display: flex; flex-direction: column; }
        .player-name-header { color: var(--light); font-weight: 700; font-size: 0.75rem; }
        .player-level-header { color: var(--accent); font-size: 0.65rem; }
        .xp-bar { width: 60px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 2px; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--primary)); transition: width 0.5s; }
        .mascot { position: fixed; bottom: 15px; left: 15px; z-index: 50; font-size: 2.5rem; cursor: pointer; transition: 0.3s; filter: drop-shadow(0 3px 10px rgba(0,0,0,0.3)); }
        .mascot:hover { transform: scale(1.1) rotate(-5deg); }
        .mascot.happy { animation: mascot-happy 0.5s; }
        .mascot.sad { animation: mascot-sad 0.5s; }
        .mascot.dancing { animation: mascot-dance 0.5s infinite; }
        @keyframes mascot-happy { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3) rotate(10deg); } }
        @keyframes mascot-sad { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }
        @keyframes mascot-dance { 0%, 100% { transform: rotate(-5deg) translateY(0); } 50% { transform: rotate(5deg) translateY(-8px); } }
        .mascot-speech { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: white; color: var(--dark); padding: 8px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; box-shadow: 0 3px 15px rgba(0,0,0,0.2); opacity: 0; transition: 0.3s; pointer-events: none; }
        .mascot-speech.show { opacity: 1; transform: translateX(-50%) translateY(-8px); }
        .container { position: relative; z-index: 5; max-width: 1200px; margin: 0 auto; padding: 15px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .welcome-container { text-align: center; padding: 30px 25px; background: linear-gradient(180deg, rgba(0,78,137,0.2) 0%, rgba(26,26,46,0.8) 100%); border-radius: 20px; border: 3px solid var(--accent); max-width: 850px; margin: 0 auto; }
        .welcome-icon { font-size: 3.5rem; margin-bottom: 12px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
        .welcome-title { font-family: 'Fredoka One', cursive; font-size: 2.2rem; background: linear-gradient(135deg, #FF6B35, #F7C948); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 12px; }
        .welcome-desc { color: rgba(255,255,255,0.8); font-size: 0.95rem; max-width: 500px; margin: 0 auto 20px; line-height: 1.5; }
        .level-display { background: linear-gradient(135deg, rgba(155,89,182,0.2), rgba(0,217,255,0.2)); border: 2px solid var(--purple); border-radius: 12px; padding: 12px 18px; margin-bottom: 18px; text-align: center; max-width: 300px; margin-left: auto; margin-right: auto; }
        .level-display-title { color: var(--light); font-weight: 600; margin-bottom: 5px; font-size: 0.85rem; }
        .level-display-rank { font-family: 'Fredoka One', cursive; font-size: 1.3rem; color: var(--accent); }
        .level-display-xp { color: rgba(255,255,255,0.6); font-size: 0.75rem; margin-top: 3px; }
        .level-progress { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .level-progress-fill { height: 100%; background: linear-gradient(90deg, var(--purple), var(--cyan)); transition: width 0.5s; }
        .avatar-section { margin-bottom: 18px; }
        .avatar-section h3 { color: var(--light); margin-bottom: 10px; font-size: 0.9rem; }
        .avatar-grid { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .avatar-option { font-size: 2rem; padding: 8px; background: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .avatar-option:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }
        .avatar-option.selected { border-color: var(--accent); background: rgba(247,201,72,0.2); }
        .player-input-section { margin-bottom: 15px; }
        .player-input-section label { display: block; color: var(--light); margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; }
        .player-input { padding: 10px 20px; font-size: 0.95rem; border: 2px solid rgba(255,255,255,0.2); border-radius: 25px; background: rgba(255,255,255,0.05); color: var(--light); width: 100%; max-width: 280px; text-align: center; font-family: 'Nunito', sans-serif; transition: 0.3s; }
        .player-input:focus { outline: none; border-color: var(--accent); background: rgba(255,255,255,0.1); }
        .player-input::placeholder { color: rgba(255,255,255,0.4); }
        .difficulty-section { margin-bottom: 18px; }
        .difficulty-section h3 { color: var(--light); margin-bottom: 8px; font-size: 0.85rem; }
        .difficulty-buttons { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .difficulty-btn { padding: 8px 18px; border: 2px solid rgba(255,255,255,0.2); border-radius: 25px; background: rgba(255,255,255,0.05); color: var(--light); font-size: 0.85rem; font-family: 'Nunito', sans-serif; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .difficulty-btn:hover { border-color: var(--accent); transform: translateY(-2px); }
        .difficulty-btn.selected { background: linear-gradient(135deg, #FF6B35, #F7C948); border-color: transparent; color: white; }
        .difficulty-btn .level-badge { display: block; font-size: 0.65rem; opacity: 0.8; }
        .game-modes { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin: 20px 0; }
        .mode-card { background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 18px 12px; text-align: center; cursor: pointer; transition: 0.3s; }
        .mode-card:hover { border-color: var(--accent); transform: translateY(-4px); background: rgba(255,255,255,0.06); }
        .mode-card.locked { opacity: 0.5; cursor: not-allowed; }
        .mode-card-icon { font-size: 2rem; margin-bottom: 8px; }
        .mode-card-title { color: var(--light); font-weight: 800; font-size: 1rem; margin-bottom: 3px; }
        .mode-card-desc { color: rgba(255,255,255,0.5); font-size: 0.7rem; }
        .mode-card-badge { display: inline-block; padding: 2px 8px; border-radius: 8px; font-size: 0.6rem; font-weight: 700; margin-top: 6px; }
        .mode-card-badge.new { background: var(--success); color: white; }
        .btn { padding: 10px 25px; border: none; border-radius: 25px; font-family: 'Nunito', sans-serif; font-size: 0.9rem; font-weight: 800; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: linear-gradient(135deg, #FF6B35, #F7C948); color: white; box-shadow: 0 4px 20px rgba(255,107,53,0.3); }
        .btn-secondary { background: transparent; border: 2px solid var(--accent); color: var(--accent); }
        .btn-success { background: linear-gradient(135deg, #2ECC71, #27AE60); color: white; }
        .btn-purple { background: linear-gradient(135deg, #9B59B6, #8E44AD); color: white; }
        .btn-cyan { background: linear-gradient(135deg, #00D9FF, #0099CC); color: white; }
        .btn-pink { background: linear-gradient(135deg, #FF6B9D, #FF4777); color: white; }
        .btn-teacher { background: linear-gradient(135deg, #E74C3C, #C0392B); color: white; }
        .btn-danger { background: linear-gradient(135deg, #E74C3C, #C0392B); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.25); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-small { padding: 7px 15px; font-size: 0.8rem; }
        .map-container { background: linear-gradient(180deg, #0077B6 0%, #004E89 50%, #003566 100%); border-radius: 20px; padding: 22px; box-shadow: 0 15px 50px rgba(0,0,0,0.35); }
        .map-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; flex-wrap: wrap; gap: 12px; }
        .map-title { color: white; font-family: 'Fredoka One', cursive; font-size: 1.4rem; }
        .map-subtitle { color: rgba(255,255,255,0.7); font-size: 0.8rem; }
        .category-filter { display: flex; gap: 5px; flex-wrap: wrap; }
        .category-btn { padding: 4px 10px; border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; background: rgba(255,255,255,0.1); color: white; font-size: 0.7rem; font-family: 'Nunito', sans-serif; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .category-btn:hover { background: rgba(255,255,255,0.2); }
        .category-btn.selected { background: var(--accent); border-color: var(--accent); color: var(--dark); }
        .world-map { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-width: 900px; margin: 0 auto; }
        .country-btn { position: relative; aspect-ratio: 1; border: none; border-radius: 12px; cursor: pointer; transition: 0.3s; overflow: hidden; font-family: 'Nunito', sans-serif; }
        .country-btn::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, transparent 50%); z-index: 1; }
        .country-btn:hover { transform: translateY(-6px) scale(1.04); box-shadow: 0 15px 35px rgba(0,0,0,0.35); }
        .country-btn.completed::after { content: '‚úì'; position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.7rem; z-index: 5; }
        .country-btn.perfect::after { content: '‚òÖ'; background: var(--accent); }
        .country-content { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 6px; }
        .country-flag { font-size: 1.8rem; display: block; margin-bottom: 2px; }
        .country-name { font-weight: 700; font-size: 0.7rem; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .country-stars { margin-top: 2px; font-size: 0.6rem; }
        .country-spain { background: linear-gradient(135deg, #C60B1E, #FFC400); }
        .country-mexico { background: linear-gradient(135deg, #006341, #CE1126); }
        .country-argentina { background: linear-gradient(135deg, #74ACDF, #F6B40E); }
        .country-colombia { background: linear-gradient(135deg, #FCD116, #003893); }
        .country-peru { background: linear-gradient(135deg, #D91023, #fff); }
        .country-chile { background: linear-gradient(135deg, #0039A6, #D52B1E); }
        .country-ecuador { background: linear-gradient(135deg, #FFD100, #0033A0); }
        .country-venezuela { background: linear-gradient(135deg, #FFCC00, #00247D); }
        .country-cuba { background: linear-gradient(135deg, #002A8F, #CB1515); }
        .country-costarica { background: linear-gradient(135deg, #002B7F, #CE1126); }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 100; align-items: center; justify-content: center; padding: 15px; overflow-y: auto; }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .modal { background: var(--dark); border-radius: 18px; padding: 22px; max-width: 650px; width: 100%; position: relative; border: 3px solid var(--accent); box-shadow: 0 0 60px rgba(247,201,72,0.15); max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; border: none; border-radius: 50%; background: rgba(255,255,255,0.1); color: var(--light); font-size: 1.2rem; cursor: pointer; transition: 0.3s; z-index: 10; }
        .close-btn:hover { background: var(--danger); transform: rotate(90deg); }
        .country-info-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 12px; }
        .country-info-flag { font-size: 2.5rem; }
        .country-info-details h2 { color: var(--light); font-family: 'Fredoka One', cursive; font-size: 1.2rem; margin-bottom: 2px; }
        .country-info-details p { color: rgba(255,255,255,0.6); font-size: 0.8rem; }
        .country-fun-fact { background: rgba(247,201,72,0.1); border-left: 3px solid var(--accent); padding: 6px 8px; margin-top: 5px; border-radius: 0 6px 6px 0; font-size: 0.75rem; color: rgba(255,255,255,0.85); }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
        .quiz-stats { display: flex; gap: 8px; }
        .quiz-stat { text-align: center; padding: 5px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; }
        .quiz-stat-value { font-family: 'Fredoka One', cursive; font-size: 1.3rem; color: var(--accent); }
        .quiz-stat-value.timer-warning { color: var(--danger); animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .quiz-stat-label { font-size: 0.6rem; color: rgba(255,255,255,0.5); text-transform: uppercase; }
        .hint-btn { padding: 5px 12px; border: 2px solid var(--purple); border-radius: 15px; background: rgba(155,89,182,0.1); color: var(--purple); font-family: 'Nunito', sans-serif; font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 0.8rem; }
        .hint-btn:hover:not(:disabled) { background: var(--purple); color: white; }
        .hint-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .progress-bar { height: 5px; background: rgba(255,255,255,0.1); border-radius: 5px; margin-bottom: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(135deg, #FF6B35, #F7C948); border-radius: 5px; transition: width 0.4s; }
        .question-type-badge { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 0.65rem; font-weight: 700; margin-bottom: 8px; }
        .question-type-badge.multiple { background: var(--secondary); color: white; }
        .question-type-badge.fill { background: var(--purple); color: white; }
        .question-type-badge.audio { background: var(--pink); color: white; }
        .question-type-badge.order { background: var(--cyan); color: var(--dark); }
        .question-category { text-align: center; color: var(--accent); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
        .question-counter { text-align: center; color: rgba(255,255,255,0.5); margin-bottom: 4px; font-size: 0.75rem; }
        .question-text { font-size: 1.1rem; color: var(--light); text-align: center; margin-bottom: 18px; line-height: 1.5; font-weight: 600; }
        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .answer-btn { padding: 12px 14px; border: 2px solid rgba(255,255,255,0.15); border-radius: 10px; background: rgba(255,255,255,0.03); color: var(--light); font-size: 0.9rem; font-family: 'Nunito', sans-serif; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .answer-btn:hover:not(:disabled) { border-color: var(--accent); background: rgba(247,201,72,0.1); }
        .answer-btn:disabled { cursor: not-allowed; }
        .answer-btn.correct { border-color: var(--success); background: rgba(46,204,113,0.25); }
        .answer-btn.incorrect { border-color: var(--danger); background: rgba(231,76,60,0.25); animation: shake 0.5s; }
        .answer-btn.eliminated { opacity: 0.3; text-decoration: line-through; pointer-events: none; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .fill-blank-container { text-align: center; margin-bottom: 18px; }
        .fill-blank-input { padding: 10px 18px; font-size: 1.1rem; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--light); width: 180px; text-align: center; font-family: 'Nunito', sans-serif; }
        .fill-blank-input:focus { outline: none; border-color: var(--accent); }
        .audio-btn { padding: 18px 35px; background: linear-gradient(135deg, var(--pink), #FF4777); border: none; border-radius: 30px; color: white; font-size: 1.3rem; cursor: pointer; transition: 0.3s; margin-bottom: 18px; }
        .audio-btn:hover { transform: scale(1.08); }
        .audio-btn.playing { animation: pulse 0.5s infinite; }
        .explanation-box { margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; border-left: 3px solid var(--accent); display: none; }
        .explanation-box.show { display: block; animation: fadeIn 0.4s; }
        .explanation-title { color: var(--accent); font-weight: 700; margin-bottom: 4px; font-size: 0.85rem; }
        .explanation-text { color: rgba(255,255,255,0.85); line-height: 1.4; font-size: 0.8rem; }
        .results-container { text-align: center; padding: 12px; }
        .results-icon { font-size: 3.5rem; margin-bottom: 8px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .results-title { font-family: 'Fredoka One', cursive; font-size: 1.6rem; color: var(--light); margin-bottom: 5px; }
        .results-score { font-size: 0.95rem; color: rgba(255,255,255,0.75); margin-bottom: 12px; }
        .results-score span { color: var(--accent); font-weight: 800; }
        .stars-earned { display: flex; justify-content: center; gap: 6px; margin-bottom: 12px; }
        .star-icon { font-size: 1.8rem; color: rgba(255,255,255,0.2); }
        .star-icon.earned { color: var(--accent); animation: star-pop 0.5s backwards; }
        @keyframes star-pop { 0% { transform: scale(0) rotate(-180deg); } 100% { transform: scale(1) rotate(0); } }
        .xp-earned { font-family: 'Fredoka One', cursive; font-size: 1.3rem; color: var(--cyan); margin: 12px 0; animation: xp-pulse 1s infinite; }
        @keyframes xp-pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.08); opacity: 0.85; } }
        .review-section { margin-top: 15px; text-align: left; }
        .review-title { color: var(--light); font-weight: 700; margin-bottom: 8px; font-size: 0.9rem; }
        .review-item { background: rgba(231,76,60,0.1); border: 2px solid rgba(231,76,60,0.3); border-radius: 8px; padding: 8px; margin-bottom: 6px; }
        .review-question { color: var(--light); font-weight: 600; margin-bottom: 4px; font-size: 0.8rem; }
        .review-answer { font-size: 0.75rem; }
        .review-answer .wrong { color: var(--danger); text-decoration: line-through; }
        .review-answer .correct { color: var(--success); font-weight: 700; }
        .review-explanation { margin-top: 4px; font-size: 0.7rem; color: rgba(255,255,255,0.6); font-style: italic; }
        .result-buttons { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
        .story-container { max-width: 700px; margin: 0 auto; background: linear-gradient(180deg, rgba(155,89,182,0.12) 0%, rgba(26,26,46,0.9) 100%); border-radius: 20px; border: 3px solid var(--purple); padding: 25px; }
        .story-header { text-align: center; margin-bottom: 20px; }
        .story-chapter { color: var(--purple); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; }
        .story-title { font-family: 'Fredoka One', cursive; font-size: 1.7rem; color: var(--light); }
        .story-scene { background: rgba(0,0,0,0.25); border-radius: 12px; padding: 20px; margin-bottom: 18px; position: relative; overflow: hidden; }
        .story-character { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
        .story-character-avatar { font-size: 2.5rem; }
        .story-character-bubble { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; color: var(--light); line-height: 1.5; position: relative; font-size: 0.9rem; }
        .story-character-bubble::before { content: ''; position: absolute; left: -8px; top: 12px; border: 8px solid transparent; border-right-color: rgba(255,255,255,0.1); }
        .story-character-name { font-weight: 700; color: var(--accent); margin-bottom: 4px; font-size: 0.85rem; }
        .story-narrative { color: rgba(255,255,255,0.75); font-style: italic; text-align: center; margin: 18px 0; line-height: 1.6; font-size: 0.9rem; }
        .story-progress { display: flex; justify-content: center; gap: 6px; margin: 18px 0; }
        .story-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.2); }
        .story-dot.active { background: var(--purple); }
        .story-dot.completed { background: var(--success); }
        .battle-container { max-width: 800px; margin: 0 auto; background: linear-gradient(180deg, rgba(231,76,60,0.12) 0%, rgba(26,26,46,0.9) 100%); border-radius: 20px; border: 3px solid var(--danger); padding: 25px; }
        .battle-header { text-align: center; margin-bottom: 20px; }
        .battle-vs { font-family: 'Fredoka One', cursive; font-size: 2.5rem; color: var(--danger); margin: 12px 0; }
        .battle-players { display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 18px; }
        .battle-player { text-align: center; }
        .battle-player-avatar { font-size: 3.5rem; margin-bottom: 8px; }
        .battle-player-name { color: var(--light); font-weight: 700; font-size: 1.1rem; }
        .battle-player-score { font-family: 'Fredoka One', cursive; font-size: 2.2rem; color: var(--accent); }
        .battle-player.winning .battle-player-avatar { animation: winner-glow 1s infinite; }
        @keyframes winner-glow { 0%, 100% { filter: drop-shadow(0 0 8px var(--accent)); } 50% { filter: drop-shadow(0 0 25px var(--accent)); } }
        .battle-timer { font-family: 'Fredoka One', cursive; font-size: 3.5rem; color: var(--light); text-align: center; margin: 18px 0; }
        .battle-timer.urgent { color: var(--danger); animation: pulse 0.5s infinite; }
        .battle-question { background: rgba(0,0,0,0.25); border-radius: 12px; padding: 20px; margin: 18px 0; }
        .team-selection { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 18px 0; }
        .team-card { padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; border: 3px solid transparent; }
        .team-card:hover { transform: translateY(-4px); }
        .team-card.selected { border-color: white; }
        .team-card.red { background: linear-gradient(135deg, #E74C3C, #C0392B); }
        .team-card.blue { background: linear-gradient(135deg, #3498DB, #2980B9); }
        .team-card.green { background: linear-gradient(135deg, #2ECC71, #27AE60); }
        .team-card.yellow { background: linear-gradient(135deg, #F7C948, #F39C12); }
        .team-card-icon { font-size: 2rem; margin-bottom: 8px; }
        .team-card-name { color: white; font-weight: 800; font-size: 1rem; }
        .team-card-count { color: rgba(255,255,255,0.75); font-size: 0.8rem; margin-top: 4px; }
        .team-scores { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 12px; background: rgba(0,0,0,0.25); border-radius: 12px; padding: 15px; margin: 18px 0; }
        .team-score-item { text-align: center; }
        .team-score-name { font-weight: 700; margin-bottom: 4px; font-size: 0.85rem; }
        .team-score-value { font-family: 'Fredoka One', cursive; font-size: 1.8rem; }
        .team-red .team-score-name, .team-red .team-score-value { color: #E74C3C; }
        .team-blue .team-score-name, .team-blue .team-score-value { color: #3498DB; }
        .team-green .team-score-name, .team-green .team-score-value { color: #2ECC71; }
        .team-yellow .team-score-name, .team-yellow .team-score-value { color: #F7C948; }
        .custom-questions-container { max-width: 700px; margin: 0 auto; background: linear-gradient(180deg, rgba(231,76,60,0.12) 0%, rgba(26,26,46,0.9) 100%); border-radius: 20px; border: 3px solid var(--danger); padding: 25px; }
        .question-form { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 18px; margin-bottom: 18px; }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; color: var(--light); font-weight: 600; margin-bottom: 5px; font-size: 0.85rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--light); font-family: 'Nunito', sans-serif; font-size: 0.9rem; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
        .form-textarea { min-height: 70px; resize: vertical; }
        .form-select option { background: var(--dark); }
        .answers-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .answer-input-group { position: relative; }
        .answer-input-group input { width: 100%; padding-right: 35px; }
        .correct-marker { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 22px; height: 22px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; transition: 0.3s; }
        .correct-marker:hover { border-color: var(--success); }
        .correct-marker.selected { background: var(--success); border-color: var(--success); }
        .saved-questions { margin-top: 20px; }
        .saved-question-item { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .saved-question-text { color: var(--light); font-weight: 600; flex: 1; font-size: 0.85rem; }
        .saved-question-actions { display: flex; gap: 6px; }
        .saved-question-btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
        .saved-question-btn.edit { background: var(--secondary); color: white; }
        .saved-question-btn.delete { background: var(--danger); color: white; }
        .leaderboard-modal { background: var(--dark); border-radius: 18px; padding: 22px; max-width: 450px; width: 100%; border: 3px solid var(--accent); }
        .leaderboard-title { font-family: 'Fredoka One', cursive; font-size: 1.5rem; color: var(--light); text-align: center; margin-bottom: 15px; }
        .leaderboard-list { list-style: none; }
        .leaderboard-item { display: flex; align-items: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 5px; }
        .leaderboard-item.current-player { border: 2px solid var(--accent); background: rgba(247,201,72,0.1); }
        .leaderboard-rank { font-family: 'Fredoka One', cursive; font-size: 1.1rem; width: 35px; color: var(--accent); }
        .leaderboard-rank.gold { color: #FFD700; }
        .leaderboard-rank.silver { color: #C0C0C0; }
        .leaderboard-rank.bronze { color: #CD7F32; }
        .leaderboard-avatar { font-size: 1.3rem; margin-right: 8px; }
        .leaderboard-info { flex: 1; }
        .leaderboard-name { color: var(--light); font-weight: 700; font-size: 0.85rem; }
        .leaderboard-level { font-size: 0.7rem; color: var(--purple); }
        .leaderboard-score { font-family: 'Fredoka One', cursive; font-size: 1rem; color: var(--accent); }
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 12px; }
        .achievement-card { background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 12px; text-align: center; transition: 0.3s; }
        .achievement-card.unlocked { border-color: var(--purple); background: rgba(155,89,182,0.1); }
        .achievement-card.locked { opacity: 0.5; filter: grayscale(1); }
        .achievement-card-icon { font-size: 1.5rem; margin-bottom: 5px; }
        .achievement-card-name { color: var(--light); font-weight: 700; font-size: 0.75rem; }
        .achievement-card-desc { font-size: 0.6rem; color: rgba(255,255,255,0.5); }
        .teacher-container { text-align: center; padding: 30px 22px; background: linear-gradient(180deg, rgba(231,76,60,0.1) 0%, rgba(26,26,46,0.9) 100%); border-radius: 20px; border: 3px solid var(--danger); max-width: 850px; margin: 0 auto; }
        .teacher-title { font-family: 'Fredoka One', cursive; font-size: 2rem; color: var(--light); margin-bottom: 6px; }
        .teacher-subtitle { color: rgba(255,255,255,0.65); margin-bottom: 22px; font-size: 0.9rem; }
        .pin-qr-container { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 22px; }
        .pin-display { background: linear-gradient(135deg, #E74C3C, #C0392B); border-radius: 15px; padding: 18px 30px; text-align: center; }
        .pin-label { color: rgba(255,255,255,0.75); font-size: 0.8rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; }
        .pin-code { font-family: 'Fredoka One', cursive; font-size: 3rem; color: white; letter-spacing: 8px; }
        .pin-hint { color: rgba(255,255,255,0.65); font-size: 0.75rem; margin-top: 5px; }
        .qr-display { background: white; border-radius: 15px; padding: 15px; text-align: center; }
        .qr-display p { color: #333; font-size: 0.75rem; margin-top: 6px; font-weight: 600; }
        .students-section { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; margin-bottom: 18px; }
        .students-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .students-title { color: var(--light); font-weight: 700; font-size: 0.95rem; }
        .students-count { background: var(--accent); color: var(--dark); padding: 3px 12px; border-radius: 15px; font-weight: 800; font-size: 0.85rem; }
        .students-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 6px; }
        .student-card { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 8px 10px; display: flex; align-items: center; gap: 8px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-15px); } to { opacity: 1; transform: translateX(0); } }
        .student-avatar { font-size: 1.2rem; }
        .student-name { color: var(--light); font-weight: 600; font-size: 0.8rem; flex: 1; }
        .student-score { color: var(--accent); font-family: 'Fredoka One', cursive; font-size: 0.9rem; }
        .student-status { padding: 2px 6px; border-radius: 8px; font-size: 0.65rem; font-weight: 600; }
        .student-status.waiting { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
        .student-status.playing { background: rgba(46,204,113,0.2); color: var(--success); }
        .student-status.finished { background: rgba(247,201,72,0.2); color: var(--accent); }
        .teacher-controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .no-students { color: rgba(255,255,255,0.45); text-align: center; padding: 22px; font-size: 0.9rem; }
        .waiting-container { text-align: center; padding: 45px 30px; background: linear-gradient(180deg, rgba(155,89,182,0.1) 0%, rgba(26,26,46,0.9) 100%); border-radius: 20px; border: 3px solid var(--purple); max-width: 500px; margin: 0 auto; }
        .waiting-spinner { font-size: 3.5rem; animation: spin 2s linear infinite; margin-bottom: 15px; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .waiting-title { font-family: 'Fredoka One', cursive; font-size: 1.6rem; color: var(--light); margin-bottom: 6px; }
        .waiting-message { color: rgba(255,255,255,0.65); font-size: 0.95rem; margin-bottom: 15px; }
        .waiting-teacher { color: var(--accent); font-size: 1rem; }
        .waiting-teacher strong { color: var(--light); }
                        <div class="mode-card-icon">üìö</div>
                        <div class="mode-card-title">Estudiar</div>
                        <div class="mode-card-desc">Flashcards</div>
                    </div>
                </div>
                
                <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:12px;">
                    <button class="btn btn-small btn-teacher" onclick="showTeacherSetup()">üë©‚Äçüè´ Profesor</button>
                    <button class="btn btn-small btn-purple" onclick="showJoinClass()">üéì Unirse</button>
                </div>
            </div>
        </div>

        <!-- Map Screen -->
        <div class="screen" id="mapScreen">
            <div class="map-container">
                <div class="map-header">
                    <div>
                        <h1 class="map-title">üó∫Ô∏è Mundo Hispano</h1>
                        <p class="map-subtitle">Elige un pa√≠s</p>
                    </div>
                    <div class="category-filter">
                        <button class="category-btn selected" data-category="all" onclick="filterCategory('all')">Todas</button>
                        <button class="category-btn" data-category="gramatica" onclick="filterCategory('gramatica')">Gram√°tica</button>
                        <button class="category-btn" data-category="vocabulario" onclick="filterCategory('vocabulario')">Vocab</button>
                        <button class="category-btn" data-category="cultura" onclick="filterCategory('cultura')">Cultura</button>
                    </div>
                </div>
                <div class="world-map" id="worldMap"></div>
                <div style="text-align:center;margin-top:18px;">
                    <button class="btn btn-secondary btn-small" onclick="goHome()">‚Üê Men√∫</button>
                </div>
            </div>
        </div>

        <!-- Story Mode Screen -->
        <div class="screen" id="storyScreen">
            <div class="story-container">
                <div class="story-header">
                    <div class="story-chapter" id="storyChapter">Cap√≠tulo 1</div>
                    <h1 class="story-title" id="storyTitle">El Viaje Comienza</h1>
                </div>
                <div class="story-scene" id="storyScene">
                    <div class="story-character">
                        <div class="story-character-avatar" id="storyCharAvatar">üë®‚Äçüè´</div>
                        <div class="story-character-bubble">
                            <div class="story-character-name" id="storyCharName">Profesor Garc√≠a</div>
                            <div id="storyDialogue">¬°Bienvenido, aventurero! Tu misi√≥n es viajar por el mundo hispanohablante y aprender espa√±ol. ¬øEst√°s listo?</div>
                        </div>
                    </div>
                    <div class="story-narrative" id="storyNarrative">El sol brilla mientras comienzas tu aventura...</div>
                </div>
                <div class="story-progress" id="storyProgress"></div>
                <div id="storyQuizContainer" style="display:none;">
                    <div class="question-text" id="storyQuestionText"></div>
                    <div class="answers-grid" id="storyAnswersGrid"></div>
                </div>
                <div style="text-align:center;margin-top:15px;">
                    <button class="btn btn-primary" id="storyContinueBtn" onclick="continueStory()">Continuar ‚Üí</button>
                    <button class="btn btn-secondary btn-small" onclick="goHome()" style="margin-left:8px;">‚Üê Salir</button>
                </div>
            </div>
        </div>

        <!-- Battle Setup Screen -->
        <div class="screen" id="battleSetupScreen">
            <div class="battle-container">
                <div class="battle-header">
                    <h1 class="welcome-title">‚öîÔ∏è Batalla 1v1</h1>
                    <p class="welcome-desc">¬°Reta a un amigo!</p>
                </div>
                
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:25px 0;">
                    <button class="btn btn-primary" onclick="createBattle()">üéØ Crear Batalla</button>
                    <button class="btn btn-secondary" onclick="showJoinBattle()">ü§ù Unirse</button>
                </div>
                
                <div id="battleCodeDisplay" style="display:none;text-align:center;margin:18px 0;">
                    <p style="color:var(--light);margin-bottom:8px;">Comparte este c√≥digo:</p>
                    <div class="pin-display" style="display:inline-block;">
                        <div class="pin-code" id="battleCode">----</div>
                    </div>
                </div>
                
                <div id="joinBattleForm" style="display:none;text-align:center;margin:18px 0;">
                    <p style="color:var(--light);margin-bottom:12px;">C√≥digo de batalla:</p>
                    <input type="text" class="join-input" id="battleCodeInput" maxlength="4" placeholder="----">
                    <p class="join-error" id="battleError">Batalla no encontrada</p>
                    <div style="margin-top:12px;">
                        <button class="btn btn-primary" onclick="joinBattle()">¬°Unirse!</button>
                    </div>
                </div>
                
                <div class="students-section" id="battlePlayers" style="display:none;">
                    <div class="students-header">
                        <span class="students-title">‚öîÔ∏è Jugadores</span>
                        <span class="students-count" id="battlePlayerCount">0/2</span>
                    </div>
                    <div class="students-grid" id="battlePlayersGrid"></div>
                </div>
                
                <div style="text-align:center;margin-top:18px;">
                    <button class="btn btn-success" id="startBattleBtn" onclick="startBattle()" style="display:none;">‚öîÔ∏è ¬°Comenzar!</button>
                    <button class="btn btn-secondary btn-small" onclick="goHome()">‚Üê Volver</button>
                </div>
            </div>
        </div>

        <!-- Battle Game Screen -->
        <div class="screen" id="battleGameScreen">
            <div class="battle-container">
                <div class="battle-players">
                    <div class="battle-player" id="battlePlayer1">
                        <div class="battle-player-avatar" id="battleAvatar1">ü¶ä</div>
                        <div class="battle-player-name" id="battleName1">Jugador 1</div>
                        <div class="battle-player-score" id="battleScore1">0</div>
                    </div>
                    <div class="battle-vs">VS</div>
                    <div class="battle-player" id="battlePlayer2">
                        <div class="battle-player-avatar" id="battleAvatar2">üêº</div>
                        <div class="battle-player-name" id="battleName2">Jugador 2</div>
                        <div class="battle-player-score" id="battleScore2">0</div>
                    </div>
                </div>
                
                <div class="battle-timer" id="battleTimer">30</div>
                
                <div class="battle-question">
                    <div class="question-counter" id="battleQuestionCounter">Pregunta 1 de 5</div>
                    <div class="question-text" id="battleQuestionText">Cargando...</div>
                    <div class="answers-grid" id="battleAnswersGrid"></div>
                </div>
                
                <div class="explanation-box" id="battleExplanation">
                    <div class="explanation-title">üí° Explicaci√≥n</div>
                    <div class="explanation-text" id="battleExplanationText"></div>
                </div>
            </div>
        </div>

        <!-- Battle Results Screen -->
        <div class="screen" id="battleResultsScreen">
            <div class="battle-container" style="text-align:center;">
                <div style="font-size:4.5rem;margin-bottom:12px;" id="battleResultIcon">üèÜ</div>
                <h1 class="welcome-title" id="battleResultTitle">¬°Victoria!</h1>
                <p style="color:rgba(255,255,255,0.65);font-size:1.1rem;" id="battleResultDesc"></p>
                
                <div class="battle-players" style="margin:25px 0;">
                    <div class="battle-player">
                        <div class="battle-player-avatar" id="finalAvatar1">ü¶ä</div>
                        <div class="battle-player-name" id="finalName1">Jugador 1</div>
                        <div class="battle-player-score" id="finalScore1">0</div>
                    </div>
                    <div class="battle-vs">VS</div>
                    <div class="battle-player">
                        <div class="battle-player-avatar" id="finalAvatar2">üêº</div>
                        <div class="battle-player-name" id="finalName2">Jugador 2</div>
                        <div class="battle-player-score" id="finalScore2">0</div>
                    </div>
                </div>
                
                <div class="xp-earned" id="battleXpEarned">+50 XP</div>
                
                <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="showBattleSetup()">üîÑ Nueva</button>
                    <button class="btn btn-secondary" onclick="goHome()">‚Üê Men√∫</button>
                </div>
            </div>
        </div>

        <!-- Teacher Setup Screen -->
        <div class="screen" id="teacherSetupScreen">
            <div class="welcome-container" style="border-color:var(--danger);">
                <h1 class="welcome-title">üë©‚Äçüè´ Configurar Clase</h1>
                
                <div style="max-width:400px;margin:0 auto;">
                    <div class="form-group">
                        <label class="form-label">Tu nombre:</label>
                        <input type="text" id="teacherName" class="form-input" placeholder="Profesor Garc√≠a" maxlength="15" style="width:100%;">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nivel:</label>
                        <select id="teacherDifficulty" class="form-select">
                            <option value="A1">A1 - Principiante</option>
                            <option value="A2" selected>A2 - Elemental</option>
                            <option value="B1">B1 - Intermedio</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Preguntas:</label>
                        <select id="teacherQuestionCount" class="form-select">
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Modo:</label>
                        <select id="teacherGameMode" class="form-select">
                            <option value="individual">üë§ Individual</option>
                            <option value="teams">üë• Equipos</option>
                        </select>
                    </div>
                </div>
                
                <div style="display:flex;gap:10px;justify-content:center;margin-top:18px;flex-wrap:wrap;">
                    <button class="btn btn-secondary btn-small" onclick="goHome()">‚Üê Volver</button>
                    <button class="btn btn-purple btn-small" onclick="showCustomQuestions()">üìù Mis Preguntas</button>
                    <button class="btn btn-teacher" onclick="createClassroom()">üéØ Crear Clase</button>
                </div>
            </div>
        </div>

        <!-- Custom Questions Screen -->
        <div class="screen" id="customQuestionsScreen">
            <div class="custom-questions-container">
                <h1 class="welcome-title">üìù Mis Preguntas</h1>
                
                <div class="question-form">
                    <div class="form-group">
                        <label class="form-label">Categor√≠a:</label>
                        <select id="customCategory" class="form-select">
                            <option value="gramatica">Gram√°tica</option>
                            <option value="vocabulario">Vocabulario</option>
                            <option value="cultura">Cultura</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Pregunta:</label>
                        <input type="text" id="customQuestionText" class="form-input" placeholder="Escribe la pregunta..." style="width:100%;">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Respuestas (marca la correcta ‚úì):</label>
                        <div class="answers-inputs">
                            <div class="answer-input-group">
                                <input type="text" class="form-input custom-answer" placeholder="A">
                                <div class="correct-marker selected" data-index="0" onclick="selectCorrectAnswer(0)">‚úì</div>
                            </div>
                            <div class="answer-input-group">
                                <input type="text" class="form-input custom-answer" placeholder="B">
                                <div class="correct-marker" data-index="1" onclick="selectCorrectAnswer(1)">‚úì</div>
                            </div>
                            <div class="answer-input-group">
                                <input type="text" class="form-input custom-answer" placeholder="C">
                                <div class="correct-marker" data-index="2" onclick="selectCorrectAnswer(2)">‚úì</div>
                            </div>
                            <div class="answer-input-group">
                                <input type="text" class="form-input custom-answer" placeholder="D">
                                <div class="correct-marker" data-index="3" onclick="selectCorrectAnswer(3)">‚úì</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Explicaci√≥n:</label>
                        <textarea id="customExplanation" class="form-textarea" placeholder="¬øPor qu√© es correcta?"></textarea>
                    </div>
                    
                    <button class="btn btn-success" onclick="saveCustomQuestion()" style="width:100%;">üíæ Guardar</button>
                </div>
                
                <div class="saved-questions">
                    <h3 style="color:var(--light);margin-bottom:12px;">Guardadas (<span id="customQuestionCount">0</span>)</h3>
                    <div id="savedQuestionsList"></div>
                </div>
                
                <div style="text-align:center;margin-top:18px;">
                    <button class="btn btn-secondary btn-small" onclick="showScreen('teacherSetupScreen')">‚Üê Volver</button>
                </div>
            </div>
        </div>

        <!-- Teacher Lobby Screen -->
        <div class="screen" id="teacherLobbyScreen">
            <div class="teacher-container">
                <h1 class="teacher-title">üë©‚Äçüè´ Modo Profesor</h1>
                <p class="teacher-subtitle">Estudiantes √∫nanse con el PIN</p>
                
                <div class="pin-qr-container">
                    <div class="pin-display">
                        <div class="pin-label">PIN</div>
                        <div class="pin-code" id="classPin">----</div>
                    </div>
                    <div class="qr-display">
                        <div id="qrcode"></div>
                        <p>Escanear</p>
                    </div>
                </div>
                
                <div id="teamModeSection" style="display:none;">
                    <div class="team-scores">
                        <div class="team-score-item team-red"><div class="team-score-name">üî¥</div><div class="team-score-value" id="teamRedScore">0</div></div>
                        <div class="team-score-item team-blue"><div class="team-score-name">üîµ</div><div class="team-score-value" id="teamBlueScore">0</div></div>
                        <div class="team-score-item team-green"><div class="team-score-name">üü¢</div><div class="team-score-value" id="teamGreenScore">0</div></div>
                        <div class="team-score-item team-yellow"><div class="team-score-name">üü°</div><div class="team-score-value" id="teamYellowScore">0</div></div>
                    </div>
                </div>
                
                <div class="students-section">
                    <div class="students-header">
                        <span class="students-title">üìã Estudiantes</span>
                        <span class="students-count" id="studentCount">0</span>
                    </div>
                    <div class="students-grid" id="studentsGrid">
                        <div class="no-students">Esperando...</div>
                    </div>
                </div>
                
                <div class="teacher-controls">
                    <button class="btn btn-success" onclick="startClassQuiz()" id="startClassBtn" disabled>‚ñ∂Ô∏è Iniciar</button>
                    <button class="btn btn-danger btn-small" onclick="endClassroom()">‚ùå Terminar</button>
                </div>
            </div>
        </div>

        <!-- Teacher Live Quiz Screen -->
        <div class="screen" id="teacherQuizScreen">
            <div class="live-quiz-container">
                <div id="teamScoresLive" style="display:none;">
                    <div class="team-scores">
                        <div class="team-score-item team-red"><div class="team-score-name">üî¥</div><div class="team-score-value" id="liveTeamRed">0</div></div>
                        <div class="team-score-item team-blue"><div class="team-score-name">üîµ</div><div class="team-score-value" id="liveTeamBlue">0</div></div>
                        <div class="team-score-item team-green"><div class="team-score-name">üü¢</div><div class="team-score-value" id="liveTeamGreen">0</div></div>
                        <div class="team-score-item team-yellow"><div class="team-score-name">üü°</div><div class="team-score-value" id="liveTeamYellow">0</div></div>
                    </div>
                </div>
                
                <div class="live-question-display">
                    <div class="live-question-number" id="liveQuestionNumber">Pregunta 1 de 5</div>
                    <div class="live-question-text" id="liveQuestionText">Cargando...</div>
                    <div class="live-timer" id="liveTimer">30</div>
                </div>
                
                <div class="live-answers-grid" id="liveAnswersGrid">
                    <div class="live-answer a" id="liveAnswerA">A</div>
                    <div class="live-answer b" id="liveAnswerB">B</div>
                    <div class="live-answer c" id="liveAnswerC">C</div>
                    <div class="live-answer d" id="liveAnswerD">D</div>
                </div>
                
                <div class="live-responses">
                    <div class="live-responses-title">Respuestas: <span id="responseCount">0</span>/<span id="totalStudents">0</span></div>
                    <div class="responses-bar" id="responsesBar"></div>
                </div>
                
                <div style="margin-top:18px;">
                    <button class="btn btn-primary" onclick="showQuestionResults()" id="showResultsBtn" style="display:none;">Ver</button>
                    <button class="btn btn-primary" onclick="nextLiveQuestion()" id="nextQuestionBtn" style="display:none;">Siguiente ‚Üí</button>
                    <button class="btn btn-success" onclick="showFinalLeaderboard()" id="showFinalBtn" style="display:none;">üèÜ Final</button>
                </div>
            </div>
        </div>

        <!-- Teacher Final Screen -->
        <div class="screen" id="teacherFinalScreen">
            <div class="live-quiz-container">
                <h1 style="font-family:'Fredoka One',cursive;font-size:2rem;color:var(--light);margin-bottom:22px;">üèÜ Clasificaci√≥n</h1>
                <div class="podium" id="podium"></div>
                <div class="leaderboard-modal" id="finalLeaderboard" style="margin:0 auto;"></div>
                <div style="margin-top:22px;">
                    <button class="btn btn-secondary btn-small" onclick="endClassroom()">Terminar</button>
                    <button class="btn btn-primary btn-small" onclick="restartClass()">üîÑ Nueva</button>
                </div>
            </div>
        </div>

        <!-- Student Join Screen -->
        <div class="screen" id="joinClassScreen">
            <div class="welcome-container" style="border-color:var(--purple);">
                <h1 class="welcome-title">üéì Unirse a Clase</h1>
                
                <div class="avatar-section">
                    <h3>Tu avatar:</h3>
                    <div class="avatar-grid">
                        <div class="avatar-option selected" data-avatar="ü¶ä" onclick="selectStudentAvatar('ü¶ä')">ü¶ä</div>
                        <div class="avatar-option" data-avatar="üêº" onclick="selectStudentAvatar('üêº')">üêº</div>
                        <div class="avatar-option" data-avatar="ü¶Å" onclick="selectStudentAvatar('ü¶Å')">ü¶Å</div>
                        <div class="avatar-option" data-avatar="üê∏" onclick="selectStudentAvatar('üê∏')">üê∏</div>
                    </div>
                </div>
                
                <div class="player-input-section">
                    <label>Tu nombre:</label>
                    <input type="text" id="studentName" class="player-input" placeholder="Nombre..." maxlength="15">
                </div>
                
                <div class="player-input-section">
                    <label>PIN:</label>
                    <input type="text" id="classCodeInput" class="join-input" maxlength="4" placeholder="----">
                </div>
                
                <p class="join-error" id="joinError">No encontrada</p>
                
                <div style="display:flex;gap:10px;justify-content:center;margin-top:18px;">
                    <button class="btn btn-secondary btn-small" onclick="goHome()">‚Üê Volver</button>
                    <button class="btn btn-purple" onclick="joinClassroom()">Unirse ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Student Waiting Room -->
        <div class="screen" id="studentWaitingScreen">
            <div class="waiting-container">
                <div class="waiting-spinner">‚è≥</div>
                <h1 class="waiting-title">¬°Conectado!</h1>
                <p class="waiting-message">Esperando al profesor...</p>
                <p class="waiting-teacher">Clase de: <strong id="teacherNameDisplay">Profesor</strong></p>
                
                <div id="studentTeamSelection" style="display:none;margin-top:22px;">
                    <h3 style="color:var(--light);margin-bottom:12px;">Elige equipo:</h3>
                    <div class="team-selection">
                        <div class="team-card red" onclick="selectTeam('red')"><div class="team-card-icon">üî¥</div><div class="team-card-name">Rojo</div></div>
                        <div class="team-card blue" onclick="selectTeam('blue')"><div class="team-card-icon">üîµ</div><div class="team-card-name">Azul</div></div>
                        <div class="team-card green" onclick="selectTeam('green')"><div class="team-card-icon">üü¢</div><div class="team-card-name">Verde</div></div>
                        <div class="team-card yellow" onclick="selectTeam('yellow')"><div class="team-card-icon">üü°</div><div class="team-card-name">Amarillo</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Quiz Screen -->
        <div class="screen" id="studentQuizScreen">
            <div class="modal" style="position:relative;max-width:550px;margin:0 auto;border-color:var(--purple);">
                <div class="question-counter" id="studentQuestionNumber">Pregunta 1 de 5</div>
                <div class="live-timer" id="studentTimer" style="font-size:2.5rem;">30</div>
                <div class="question-text" id="studentQuestionText">Cargando...</div>
                <div class="answers-grid" id="studentAnswersGrid"></div>
                
                <div id="studentFeedback" style="display:none;text-align:center;margin-top:18px;">
                    <div id="feedbackIcon" style="font-size:3rem;"></div>
                    <div id="feedbackText" style="color:var(--light);font-size:1rem;margin-top:6px;"></div>
                </div>
                
                <div id="waitingNext" style="display:none;text-align:center;margin-top:18px;color:rgba(255,255,255,0.5);">
                    Esperando...
                </div>
            </div>
        </div>

        <!-- Student Final Score -->
        <div class="screen" id="studentFinalScreen">
            <div class="waiting-container" style="border-color:var(--accent);">
                <div style="font-size:4rem;margin-bottom:15px;">üéâ</div>
                <h1 class="waiting-title">¬°Terminado!</h1>
                <p style="color:var(--accent);font-family:'Fredoka One',cursive;font-size:2.5rem;" id="studentFinalScore">0</p>
                <p style="color:rgba(255,255,255,0.65);">puntos</p>
                <p style="color:var(--light);margin-top:15px;">Correctas: <span id="studentCorrectCount">0</span>/<span id="studentTotalCount">0</span></p>
                <div class="xp-earned" id="studentXpEarned">+50 XP</div>
            </div>
        </div>

        <!-- Flashcard Screen -->
        <div class="screen" id="flashcardScreen">
            <div class="flashcard-container">
                <h2 style="color:var(--light);text-align:center;margin-bottom:15px;font-family:'Fredoka One',cursive;">üìö Estudiar</h2>
                <div class="flashcard" id="flashcard" onclick="flipFlashcard()">
                    <div class="flashcard-front">
                        <div class="flashcard-word" id="flashcardFront">Cargando...</div>
                        <div class="flashcard-hint" id="flashcardHint">Categor√≠a</div>
                    </div>
                    <div class="flashcard-back">
                        <div class="flashcard-word" id="flashcardBack" style="font-size:1.1rem;">Respuesta</div>
                    </div>
                </div>
                <div class="flashcard-nav">
                    <button class="btn btn-secondary btn-small" onclick="prevFlashcard()">‚Üê</button>
                    <button class="btn btn-primary btn-small" onclick="nextFlashcard()">‚Üí</button>
                </div>
                <div style="text-align:center;margin-top:10px;color:rgba(255,255,255,0.5);font-size:0.85rem;" id="flashcardProgress">1/10</div>
                <div style="text-align:center;margin-top:15px;">
                    <button class="btn btn-success btn-small" onclick="startGame()">üéÆ Jugar</button>
                    <button class="btn btn-secondary btn-small" onclick="goHome()">‚Üê Men√∫</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="modal-overlay" id="quizModal">
        <div class="modal">
            <button class="close-btn" onclick="closeQuiz()">√ó</button>
            <div id="quizContent">
                <div class="country-info-card">
                    <span class="country-info-flag" id="countryFlag">üá™üá∏</span>
                    <div class="country-info-details">
                        <h2 id="countryName">Espa√±a</h2>
                        <p id="countryCapital">Capital: Madrid</p>
                        <div class="country-fun-fact" id="countryFunFact"></div>
                    </div>
                </div>
                <div class="quiz-header">
                    <div class="quiz-stats">
                        <div class="quiz-stat"><div class="quiz-stat-value" id="timerDisplay">30</div><div class="quiz-stat-label">Seg</div></div>
                        <div class="quiz-stat"><div class="quiz-stat-value" id="scoreDisplay">0</div><div class="quiz-stat-label">Pts</div></div>
                    </div>
                    <button class="hint-btn" id="hintBtn" onclick="useHint()">üí° <span id="hintsRemaining">2</span></button>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <span class="question-type-badge multiple" id="questionTypeBadge">Opci√≥n M√∫ltiple</span>
                <div class="question-category" id="questionCategory">Gram√°tica</div>
                <div class="question-counter" id="questionCounter">Pregunta 1 de 5</div>
                <div class="question-text" id="questionText">Cargando...</div>
                <div id="audioQuestionContainer" style="display:none;text-align:center;">
                    <button class="audio-btn" id="playAudioBtn" onclick="playQuestionAudio()">üîä</button>
                </div>
                <div class="answers-grid" id="answersGrid"></div>
                <div class="fill-blank-container" id="fillBlankContainer" style="display:none;">
                    <input type="text" class="fill-blank-input" id="fillBlankInput" placeholder="Respuesta...">
                    <button class="btn btn-primary btn-small" onclick="submitFillBlank()" style="margin-top:12px;">Enviar</button>
                </div>
                <div class="explanation-box" id="explanationBox">
                    <div class="explanation-title">üí° Explicaci√≥n</div>
                    <div class="explanation-text" id="explanationText"></div>
                </div>
            </div>
            <div id="resultsContent" style="display:none;">
                <div class="results-container">
                    <div class="results-icon" id="resultsIcon">üéâ</div>
                    <h2 class="results-title" id="resultsTitle">¬°Excelente!</h2>
                    <p class="results-score" id="resultsScore"></p>
                    <div class="stars-earned" id="starsEarned"></div>
                    <div class="xp-earned" id="quizXpEarned">+50 XP</div>
                    <div class="review-section" id="reviewSection" style="display:none;">
                        <div class="review-title">üìù Repaso:</div>
                        <div id="reviewList"></div>
                    </div>
                    <div class="result-buttons">
                        <button class="btn btn-secondary btn-small" onclick="closeQuiz()">üó∫Ô∏è Mapa</button>
                        <button class="btn btn-primary btn-small" onclick="retryQuiz()">üîÑ Reintentar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div class="modal-overlay" id="leaderboardModal">
        <div class="leaderboard-modal">
            <button class="close-btn" onclick="closeLeaderboard()">√ó</button>
            <h2 class="leaderboard-title">üèÜ Clasificaci√≥n</h2>
            <ul class="leaderboard-list" id="leaderboardList"></ul>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div class="modal-overlay" id="achievementsModal">
        <div class="modal" style="max-width:500px;">
            <button class="close-btn" onclick="closeAchievements()">√ó</button>
            <h2 style="color:var(--light);text-align:center;font-family:'Fredoka One',cursive;">üèÖ Logros</h2>
            <p style="color:rgba(255,255,255,0.5);text-align:center;font-size:0.85rem;" id="achievementProgress">0 de 12</p>
            <div class="achievements-grid" id="achievementsGrid"></div>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div class="modal-overlay" id="levelUpModal">
        <div class="modal" style="max-width:350px;text-align:center;">
            <div style="font-size:4.5rem;margin-bottom:12px;">üéâ</div>
            <h2 style="font-family:'Fredoka One',cursive;color:var(--accent);font-size:1.8rem;">¬°SUBISTE DE NIVEL!</h2>
            <p style="color:var(--light);font-size:1.2rem;margin:12px 0;" id="newLevelName">Aprendiz</p>
            <button class="btn btn-primary" onclick="closeLevelUp()" style="margin-top:15px;">¬°Genial!</button>
        </div>
    </div>

    <script>
        // =====================================================
        // FIREBASE CONFIG - Replace with your credentials
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCyjx25i8U6tP0jxGBpyzmKI1cAKjnsiNc",
            authDomain: "spanish-quest-fa18f.firebaseapp.com",
            databaseURL: "https://spanish-quest-fa18f-default-rtdb.firebaseio.com",
            projectId: "spanish-quest-fa18f",
            storageBucket: "spanish-quest-fa18f.firebasestorage.app",
            messagingSenderId: "113801000060",
            appId: "1:113801000060:web:89432cbbab4406900785f9"
        };
        
        let db = null;
        let firebaseInitialized = false;
        function initFirebase() {
            try {
                if (firebaseConfig.apiKey === "YOUR_API_KEY") return false;
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                firebaseInitialized = true;
                return true;
            } catch (e) { console.error("Firebase error:", e); return false; }
        }

        // =====================================================
        // GAME DATA
        // =====================================================
        const countries = [
            { id: 'spain', name: 'Espa√±a', flag: 'üá™üá∏', capital: 'Madrid', pop: '47M', class: 'country-spain', funFact: 'Espa√±a tiene m√°s bares por habitante que cualquier otro pa√≠s de la UE.' },
            { id: 'mexico', name: 'M√©xico', flag: 'üá≤üáΩ', capital: 'CDMX', pop: '128M', class: 'country-mexico', funFact: 'M√©xico introdujo el chocolate al mundo.' },
            { id: 'argentina', name: 'Argentina', flag: 'üá¶üá∑', capital: 'Buenos Aires', pop: '45M', class: 'country-argentina', funFact: 'Argentina tiene m√°s psic√≥logos per c√°pita del mundo.' },
            { id: 'colombia', name: 'Colombia', flag: 'üá®üá¥', capital: 'Bogot√°', pop: '51M', class: 'country-colombia', funFact: 'Colombia es el segundo pa√≠s m√°s biodiverso.' },
            { id: 'peru', name: 'Per√∫', flag: 'üáµüá™', capital: 'Lima', pop: '33M', class: 'country-peru', funFact: 'Per√∫ tiene m√°s de 3,000 tipos de papas.' },
            { id: 'chile', name: 'Chile', flag: 'üá®üá±', capital: 'Santiago', pop: '19M', class: 'country-chile', funFact: 'Chile tiene el desierto m√°s seco: Atacama.' },
            { id: 'ecuador', name: 'Ecuador', flag: 'üá™üá®', capital: 'Quito', pop: '18M', class: 'country-ecuador', funFact: 'Gal√°pagos inspir√≥ la teor√≠a de la evoluci√≥n.' },
            { id: 'venezuela', name: 'Venezuela', flag: 'üáªüá™', capital: 'Caracas', pop: '28M', class: 'country-venezuela', funFact: 'Venezuela tiene la cascada m√°s alta: Salto √Ångel.' },
            { id: 'cuba', name: 'Cuba', flag: 'üá®üá∫', capital: 'La Habana', pop: '11M', class: 'country-cuba', funFact: 'Cuba tiene excelente sistema de salud.' },
            { id: 'costarica', name: 'Costa Rica', flag: 'üá®üá∑', capital: 'San Jos√©', pop: '5M', class: 'country-costarica', funFact: 'Costa Rica no tiene ej√©rcito desde 1948.' }
        ];

        const questionBank = {
            A1: [
                { q: "¬øArt√≠culo correcto? '___ libro'", a: ["El", "La", "Los", "Las"], c: 0, cat: "gramatica", exp: "'Libro' es masculino singular.", type: "multiple" },
                { q: "Completa: 'Yo ___ estudiante.'", a: ["soy", "eres", "es", "somos"], c: 0, cat: "gramatica", exp: "Con 'yo' usamos 'soy'.", type: "multiple" },
                { q: "'I have' en espa√±ol:", a: ["Yo tengo", "Yo soy", "Yo estoy", "Yo hago"], c: 0, cat: "gramatica", exp: "'Tener' = to have.", type: "multiple" },
                { q: "Ella ___ de M√©xico.", a: ["es", "est√°", "son", "est√°n"], c: 0, cat: "gramatica", exp: "'Ser' para origen.", type: "multiple" },
                { q: "Plural de 'casa':", a: ["casas", "casaes", "casis", "casa"], c: 0, cat: "gramatica", exp: "A√±adimos -s.", type: "multiple" },
                { q: "'Buenos d√≠as' se usa por la:", a: ["ma√±ana", "noche", "tarde", "siempre"], c: 0, cat: "vocabulario", exp: "Por la ma√±ana.", type: "multiple" },
                { q: "'Water' en espa√±ol:", a: ["agua", "leche", "jugo", "caf√©"], c: 0, cat: "vocabulario", exp: "Agua = water.", type: "multiple" },
                { q: "Despu√©s del lunes viene:", a: ["martes", "mi√©rcoles", "domingo", "viernes"], c: 0, cat: "vocabulario", exp: "Lunes, martes...", type: "multiple" },
                { q: "'Quince' es:", a: ["15", "50", "5", "25"], c: 0, cat: "vocabulario", exp: "Quince = 15.", type: "multiple" },
                { q: "Color del cielo:", a: ["azul", "verde", "rojo", "amarillo"], c: 0, cat: "vocabulario", exp: "El cielo es azul.", type: "multiple" },
                { q: "Capital de Espa√±a:", a: ["Madrid", "Barcelona", "Sevilla", "Valencia"], c: 0, cat: "cultura", exp: "Madrid es la capital.", type: "multiple" },
                { q: "En M√©xico se habla:", a: ["espa√±ol", "portugu√©s", "italiano", "franc√©s"], c: 0, cat: "cultura", exp: "Se habla espa√±ol.", type: "multiple" },
                { q: "Completa: 'Yo ___ espa√±ol.'", a: "hablo", cat: "gramatica", exp: "Hablar - yo hablo.", type: "fill" },
                { q: "Escucha y elige:", a: ["Hola", "Adi√≥s", "Gracias", "Perd√≥n"], c: 0, cat: "vocabulario", exp: "'Hola' es un saludo.", type: "audio", audio: "hola" }
            ],
            A2: [
                { q: "'Hoy yo ___ un caf√©.'", a: ["he tomado", "ha tomado", "has tomado", "hemos tomado"], c: 0, cat: "gramatica", exp: "Yo + he + participio.", type: "multiple" },
                { q: "'Ella nunca ___ a Espa√±a.'", a: ["ha viajado", "he viajado", "has viajado", "han viajado"], c: 0, cat: "gramatica", exp: "Ella + ha.", type: "multiple" },
                { q: "'Nosotros ___ la pel√≠cula.'", a: ["hemos visto", "he visto", "han visto", "ha visto"], c: 0, cat: "gramatica", exp: "Nosotros + hemos.", type: "multiple" },
                { q: "'Mi hermana ___ cansada.'", a: ["est√°", "es", "son", "est√°n"], c: 0, cat: "gramatica", exp: "Estados temporales = estar.", type: "multiple" },
                { q: "'Barcelona ___ bonita.'", a: ["es", "est√°", "son", "est√°n"], c: 0, cat: "gramatica", exp: "Caracter√≠sticas = ser.", type: "multiple" },
                { q: "'¬øD√≥nde ___ el banco?'", a: ["est√°", "es", "son", "est√°n"], c: 0, cat: "gramatica", exp: "Ubicaci√≥n = estar.", type: "multiple" },
                { q: "'La sopa ___ caliente.'", a: ["est√°", "es", "son", "est√°n"], c: 0, cat: "gramatica", exp: "Temperatura = estar.", type: "multiple" },
                { q: "'Los chicos ___ de Francia.'", a: ["son", "est√°n", "es", "est√°"], c: 0, cat: "gramatica", exp: "Origen = ser.", type: "multiple" },
                { q: "'Desayuno' significa:", a: ["primera comida", "almuerzo", "cena", "merienda"], c: 0, cat: "vocabulario", exp: "Primera comida.", type: "multiple" },
                { q: "Opuesto de 'grande':", a: ["peque√±o", "alto", "largo", "ancho"], c: 0, cat: "vocabulario", exp: "Grande ‚Üî peque√±o.", type: "multiple" },
                { q: "'A m√≠ ___ el chocolate.'", a: ["me gusta", "me gustan", "te gusta", "le gusta"], c: 0, cat: "gramatica", exp: "'Gusta' singular.", type: "multiple" },
                { q: "'A ellos ___ las pel√≠culas.'", a: ["les gustan", "les gusta", "le gustan", "nos gustan"], c: 0, cat: "gramatica", exp: "'Gustan' plural.", type: "multiple" },
                { q: "'Hace fr√≠o' = ", a: ["It's cold", "It's hot", "It's raining", "It's sunny"], c: 0, cat: "vocabulario", exp: "Hace fr√≠o = It's cold.", type: "multiple" },
                { q: "'Las tres y media' = ", a: ["3:30", "3:15", "3:45", "3:00"], c: 0, cat: "vocabulario", exp: "Y media = :30.", type: "multiple" },
                { q: "La moneda de Espa√±a:", a: ["el euro", "el peso", "el d√≥lar", "la libra"], c: 0, cat: "cultura", exp: "Espa√±a usa el euro.", type: "multiple" },
                { q: "La paella es de:", a: ["Espa√±a", "M√©xico", "Argentina", "Per√∫"], c: 0, cat: "cultura", exp: "De Valencia, Espa√±a.", type: "multiple" },
                { q: "El tango es de:", a: ["Argentina", "Espa√±a", "Cuba", "Colombia"], c: 0, cat: "cultura", exp: "De Buenos Aires.", type: "multiple" },
                { q: "Completa: 'Ayer ___ al cine.'", a: "fui", cat: "gramatica", exp: "Ir - yo fui (pasado).", type: "fill" }
            ],
            B1: [
                { q: "'Espero que t√∫ ___ bien.'", a: ["est√©s", "est√°s", "estar", "estar√°s"], c: 0, cat: "gramatica", exp: "'Espero que' + subjuntivo.", type: "multiple" },
                { q: "'Quiero que ella ___.'", a: ["venga", "viene", "venir", "vendr√°"], c: 0, cat: "gramatica", exp: "'Querer que' + subjuntivo.", type: "multiple" },
                { q: "'Es importante que ___.'", a: ["estudiemos", "estudiamos", "estudiar", "estudiaremos"], c: 0, cat: "gramatica", exp: "'Es importante que' + subj.", type: "multiple" },
                { q: "'Si tuviera dinero, ___.'", a: ["comprar√≠a", "compro", "compr√©", "he comprado"], c: 0, cat: "gramatica", exp: "Si + subj. ‚Üí condicional.", type: "multiple" },
                { q: "'Me ___ ir de vacaciones.'", a: ["gustar√≠a", "gusta", "gust√≥", "gustaba"], c: 0, cat: "gramatica", exp: "Condicional para deseos.", type: "multiple" },
                { q: "'Cuando era ni√±o, ___ al parque.'", a: ["iba", "fui", "voy", "ir√©"], c: 0, cat: "gramatica", exp: "Imperfecto para h√°bitos.", type: "multiple" },
                { q: "'Ayer ___ a Mar√≠a.'", a: ["vi", "ve√≠a", "veo", "he visto"], c: 0, cat: "gramatica", exp: "Indefinido para acciones puntuales.", type: "multiple" },
                { q: "'Mientras yo ___, ella cocinaba.'", a: ["estudiaba", "estudi√©", "estudio", "estudiar√©"], c: 0, cat: "gramatica", exp: "'Mientras' + imperfecto.", type: "multiple" },
                { q: "'La chica ___ conoc√≠...'", a: ["que", "quien", "cual", "cuyo"], c: 0, cat: "gramatica", exp: "'Que' es el m√°s com√∫n.", type: "multiple" },
                { q: "'Echar de menos' = ", a: ["extra√±ar", "tirar", "perder", "olvidar"], c: 0, cat: "vocabulario", exp: "Echar de menos = to miss.", type: "multiple" },
                { q: "'Tener ganas de' = ", a: ["querer hacer", "tener miedo", "tener hambre", "estar cansado"], c: 0, cat: "vocabulario", exp: "= feel like doing.", type: "multiple" },
                { q: "'Este regalo es ___ ti.'", a: ["para", "por", "a", "de"], c: 0, cat: "gramatica", exp: "'Para' = destinatario.", type: "multiple" },
                { q: "'Gracias ___ tu ayuda.'", a: ["por", "para", "a", "de"], c: 0, cat: "gramatica", exp: "'Por' = causa.", type: "multiple" },
                { q: "'La siesta' es:", a: ["descanso despu√©s de comer", "fiesta", "comida", "baile"], c: 0, cat: "cultura", exp: "Descanso despu√©s de comer.", type: "multiple" },
                { q: "D√≠a de Muertos es de:", a: ["M√©xico", "Espa√±a", "Argentina", "Chile"], c: 0, cat: "cultura", exp: "Se celebra en M√©xico.", type: "multiple" }
            ]
        };

        const flashcards = [
            { front: "Ser vs Estar", back: "SER: identidad, origen. ESTAR: ubicaci√≥n, temporal.", cat: "Gram√°tica" },
            { front: "Pret√©rito Perfecto", back: "He/Has/Ha + participio (-ado/-ido)", cat: "Gram√°tica" },
            { front: "Gustar", back: "A m√≠ ME gusta, A ti TE gusta...", cat: "Gram√°tica" },
            { front: "Por vs Para", back: "POR: causa. PARA: destino.", cat: "Gram√°tica" },
            { front: "Subjuntivo", back: "Despu√©s de: querer que, esperar que...", cat: "Gram√°tica" },
            { front: "Buenos d√≠as", back: "Good morning", cat: "Saludos" },
            { front: "¬øCu√°nto cuesta?", back: "How much?", cat: "Frases" },
            { front: "Echar de menos", back: "To miss someone", cat: "Expresiones" },
            { front: "Tener ganas de", back: "To feel like", cat: "Expresiones" },
            { front: "Hace fr√≠o/calor", back: "It's cold/hot", cat: "Clima" }
        ];

        const achievements = [
            { id: 'first', name: 'Primera', desc: 'Completa 1 misi√≥n', icon: 'üéØ', unlocked: false },
            { id: 'perfect', name: 'Perfecto', desc: '5/5 correctas', icon: 'üíØ', unlocked: false },
            { id: 'speed', name: 'Rayo', desc: 'Responde en <5s', icon: '‚ö°', unlocked: false },
            { id: 'explorer', name: 'Explorador', desc: '5 pa√≠ses', icon: 'üß≠', unlocked: false },
            { id: 'traveler', name: 'Viajero', desc: '10 pa√≠ses', icon: 'üåç', unlocked: false },
            { id: 'grammar', name: 'Gram√°tico', desc: '20 gram√°tica', icon: 'üìù', unlocked: false },
            { id: 'culture', name: 'Cultural', desc: '10 cultura', icon: 'üé≠', unlocked: false },
            { id: 'vocab', name: 'Vocabulario', desc: '20 vocab', icon: 'üìö', unlocked: false },
            { id: 'story', name: 'Narrador', desc: 'Completa historia', icon: 'üìñ', unlocked: false },
            { id: 'battle', name: 'Campe√≥n', desc: 'Gana batalla', icon: '‚öîÔ∏è', unlocked: false },
            { id: 'level5', name: 'Nivel 5', desc: 'Alcanza nivel 5', icon: 'üåü', unlocked: false },
            { id: 'level10', name: 'Nivel 10', desc: 'Alcanza nivel 10', icon: 'üëë', unlocked: false }
        ];

        const levels = [
            { name: 'üå± Novato', xp: 0 }, { name: 'üìö Aprendiz', xp: 100 }, { name: '‚úèÔ∏è Estudiante', xp: 250 },
            { name: 'üìñ Lector', xp: 500 }, { name: 'üéØ Practicante', xp: 800 }, { name: '‚≠ê Competente', xp: 1200 },
            { name: 'üí´ Avanzado', xp: 1700 }, { name: 'üî• Experto', xp: 2300 }, { name: 'üëë Maestro', xp: 3000 },
            { name: 'üèÜ Leyenda', xp: 4000 }
        ];

        const storyChapters = [
            {
                title: "El Viaje Comienza",
                scenes: [
                    { char: "üë®‚Äçüè´", name: "Profesor Garc√≠a", text: "¬°Bienvenido, aventurero! Soy el Profesor Garc√≠a. Tu misi√≥n es viajar por el mundo hispanohablante.", narrative: "El sol brilla sobre la academia de idiomas..." },
                    { char: "ü¶ú", name: "Paco", text: "¬°Hola! Soy Paco, tu gu√≠a. ¬°Vamos a aprender espa√±ol juntos!", narrative: "Un colorido loro aparece volando..." },
                    { quiz: true, question: { q: "¬øC√≥mo se dice 'hello' en espa√±ol?", a: ["Hola", "Adi√≥s", "Gracias", "Por favor"], c: 0, exp: "'Hola' es el saludo b√°sico." } },
                    { char: "üë®‚Äçüè´", name: "Profesor Garc√≠a", text: "¬°Excelente! Ahora est√°s listo para tu primera aventura.", narrative: "El profesor te entrega un mapa del mundo hispano..." }
                ]
            },
            {
                title: "Aventura en Espa√±a",
                scenes: [
                    { char: "üíÉ", name: "Mar√≠a", text: "¬°Hola! Bienvenido a Espa√±a. ¬øTe gusta el flamenco?", narrative: "Llegas a Sevilla, ciudad del flamenco..." },
                    { quiz: true, question: { q: "La capital de Espa√±a es:", a: ["Madrid", "Barcelona", "Sevilla", "Valencia"], c: 0, exp: "Madrid es la capital de Espa√±a." } },
                    { char: "üç≥", name: "Chef Antonio", text: "¬øQuieres probar una paella? Es el plato t√≠pico de Valencia.", narrative: "El delicioso aroma de paella llena el aire..." },
                    { quiz: true, question: { q: "'La paella est√° muy ___'", a: ["rica", "rico", "ricas", "ricos"], c: 0, exp: "'Rica' concuerda con 'paella' (femenino)." } }
                ]
            },
            {
                title: "Misterio en M√©xico",
                scenes: [
                    { char: "üé∏", name: "Carlos", text: "¬°Hola amigo! Bienvenido a M√©xico. ¬øTe gustan los tacos?", narrative: "Llegas a la vibrante Ciudad de M√©xico..." },
                    { quiz: true, question: { q: "M√©xico introdujo al mundo:", a: ["el chocolate", "el caf√©", "el arroz", "el trigo"], c: 0, exp: "El chocolate viene de M√©xico." } },
                    { char: "ü¶ã", name: "Mariposa", text: "Cada a√±o, millones de mariposas monarca viajan a M√©xico.", narrative: "En el bosque, ves miles de mariposas naranjas..." },
                    { quiz: true, question: { q: "'Ayer ___ muchos tacos.'", a: ["com√≠", "como", "comer√©", "com√≠a"], c: 0, exp: "Pret√©rito indefinido para acciones pasadas." } }
                ]
            }
        ];

        // =====================================================
        // GAME STATE
        // =====================================================
        let gameState = {
            playerName: '', avatar: 'ü¶ä', difficulty: 'A2', totalScore: 0, totalStars: 0, xp: 0, level: 1,
            completedCountries: {}, selectedCategory: 'all', soundEnabled: true, musicEnabled: false, theme: 'dark',
            achievements: JSON.parse(JSON.stringify(achievements)), categoryStats: { gramatica: 0, vocabulario: 0, cultura: 0 },
            customQuestions: [], correctAnswerIndex: 0,
            // Quiz state
            currentCountry: null, currentQuestions: [], currentQuestionIndex: 0,
            correctAnswers: 0, wrongAnswers: [], currentQuizScore: 0, hintsRemaining: 2,
            timer: 30, timerInterval: null, answerStartTime: null,
            // Classroom
            isTeacher: false, isStudent: false, classroomId: null, studentId: null, studentAvatar: 'ü¶ä',
            classQuestions: [], classQuestionIndex: 0, liveTimer: null, gameMode: 'individual', selectedTeam: null,
            // Story
            storyChapter: 0, storyScene: 0,
            // Battle
            battleId: null, isBattleHost: false, battleQuestions: [], battleQuestionIndex: 0, battleScore: 0
        };

        // =====================================================
        // AUDIO SYSTEM
        // =====================================================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null, masterVolume = 0.5, musicPlaying = false, musicInterval = null;
        
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); }
        function setVolume(v) { masterVolume = v / 100; }
        
        function playSound(type) {
            if (!gameState.soundEnabled) return;
            initAudio();
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const sounds = {
                correct: () => { osc.frequency.setValueAtTime(523, audioCtx.currentTime); osc.frequency.setValueAtTime(659, audioCtx.currentTime+0.1); gain.gain.setValueAtTime(0.3*masterVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.3); osc.start(); osc.stop(audioCtx.currentTime+0.3); },
                wrong: () => { osc.frequency.setValueAtTime(200, audioCtx.currentTime); gain.gain.setValueAtTime(0.3*masterVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.2); osc.start(); osc.stop(audioCtx.currentTime+0.2); },
                tick: () => { osc.frequency.setValueAtTime(800, audioCtx.currentTime); gain.gain.setValueAtTime(0.1*masterVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.05); osc.start(); osc.stop(audioCtx.currentTime+0.05); },
                click: () => { osc.frequency.setValueAtTime(600, audioCtx.currentTime); gain.gain.setValueAtTime(0.15*masterVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.08); osc.start(); osc.stop(audioCtx.currentTime+0.08); },
                levelup: () => { [523, 659, 784, 1047].forEach((f, i) => { const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; g.gain.setValueAtTime(0.2*masterVolume, audioCtx.currentTime + i*0.15); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i*0.15 + 0.3); o.start(audioCtx.currentTime + i*0.15); o.stop(audioCtx.currentTime + i*0.15 + 0.3); }); },
                victory: () => { [392, 523, 659, 784].forEach((f, i) => { const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; g.gain.setValueAtTime(0.25*masterVolume, audioCtx.currentTime + i*0.12); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i*0.12 + 0.4); o.start(audioCtx.currentTime + i*0.12); o.stop(audioCtx.currentTime + i*0.12 + 0.4); }); }
            };
            if (sounds[type]) sounds[type]();
        }

        function playMusic() {
            if (!audioCtx) initAudio();
            const melody = [330, 392, 440, 392, 330, 294, 330, 392];
            let i = 0;
            musicInterval = setInterval(() => {
                if (!gameState.musicEnabled) return;
                const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.frequency.value = melody[i % melody.length];
                gain.gain.setValueAtTime(0.08 * masterVolume, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
                i++;
            }, 400);
        }

        function toggleMusic() {
            gameState.musicEnabled = !gameState.musicEnabled;
            const btn = document.getElementById('musicToggle');
            btn.classList.toggle('playing', gameState.musicEnabled);
            if (gameState.musicEnabled) playMusic();
            else if (musicInterval) clearInterval(musicInterval);
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('soundToggle').textContent = gameState.soundEnabled ? 'üîä' : 'üîá';
            if (gameState.soundEnabled) playSound('click');
        }

        function playQuestionAudio() {
            playSound('click');
            // Simplified audio - just play a tone for demo
            const btn = document.getElementById('playAudioBtn');
            btn.classList.add('playing');
            setTimeout(() => btn.classList.remove('playing'), 1000);
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================
        function init() {
            initFirebase();
            loadGameState();
            createStars();
            updateStats();
            updateLevelDisplay();
            generateCountryButtons();
            document.body.dataset.theme = gameState.theme;
            document.getElementById('themeToggle').textContent = gameState.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            if (gameState.playerName) document.getElementById('playerName').value = gameState.playerName;
            selectAvatar(gameState.avatar);
            document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.toggle('selected', b.dataset.level === gameState.difficulty));
            
            // Check URL for join code
            const params = new URLSearchParams(window.location.search);
            if (params.get('join')) { document.getElementById('classCodeInput').value = params.get('join'); showJoinClass(); }
            if (params.get('battle')) { document.getElementById('battleCodeInput').value = params.get('battle'); showBattleSetup(); showJoinBattle(); }
        }

        function createStars() {
            const c = document.getElementById('stars'); c.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const s = document.createElement('div'); s.className = 'star';
                s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;animation-delay:${Math.random()*3}s`;
                c.appendChild(s);
            }
        }

        function saveGameState() {
            localStorage.setItem('spanishQuestUltimate', JSON.stringify({
                playerName: gameState.playerName, avatar: gameState.avatar, difficulty: gameState.difficulty,
                totalScore: gameState.totalScore, totalStars: gameState.totalStars, xp: gameState.xp, level: gameState.level,
                completedCountries: gameState.completedCountries, soundEnabled: gameState.soundEnabled,
                theme: gameState.theme, achievements: gameState.achievements, categoryStats: gameState.categoryStats,
                customQuestions: gameState.customQuestions, storyChapter: gameState.storyChapter
            }));
            updateLeaderboard();
        }

        function loadGameState() {
            const saved = localStorage.getItem('spanishQuestUltimate');
            if (saved) Object.assign(gameState, JSON.parse(saved));
        }

        // =====================================================
        // XP & LEVELING SYSTEM
        // =====================================================
        function addXP(amount) {
            const oldLevel = gameState.level;
            gameState.xp += amount;
            
            // Calculate new level
            for (let i = levels.length - 1; i >= 0; i--) {
                if (gameState.xp >= levels[i].xp) { gameState.level = i + 1; break; }
            }
            
            updateLevelDisplay();
            saveGameState();
            
            if (gameState.level > oldLevel) {
                playSound('levelup');
                document.getElementById('newLevelName').textContent = levels[gameState.level - 1].name;
                document.getElementById('levelUpModal').classList.add('active');
                if (gameState.level >= 5) checkAchievement('level5');
                if (gameState.level >= 10) checkAchievement('level10');
            }
        }

        function updateLevelDisplay() {
            const currentLevel = levels[gameState.level - 1] || levels[0];
            const nextLevel = levels[gameState.level] || levels[levels.length - 1];
            const xpForCurrent = currentLevel.xp;
            const xpForNext = nextLevel.xp;
            const progress = ((gameState.xp - xpForCurrent) / (xpForNext - xpForCurrent)) * 100;
            
            document.getElementById('displayRank').textContent = currentLevel.name;
            document.getElementById('displayXp').textContent = `${gameState.xp} / ${xpForNext} XP`;
            document.getElementById('displayXpFill').style.width = Math.min(progress, 100) + '%';
            
            const profile = document.getElementById('playerProfile');
            if (gameState.playerName) {
                profile.style.display = 'flex';
                document.getElementById('headerAvatar').textContent = gameState.avatar;
                document.getElementById('headerName').textContent = gameState.playerName;
                document.getElementById('headerLevel').textContent = `Nivel ${gameState.level}`;
                document.getElementById('headerXpFill').style.width = Math.min(progress, 100) + '%';
            }
        }

        function closeLevelUp() { document.getElementById('levelUpModal').classList.remove('active'); }

        // =====================================================
        // NAVIGATION & UI
        // =====================================================
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goHome() {
            playSound('click');
            if (gameState.classroomId && gameState.isTeacher) endClassroom();
            if (gameState.classroomId && gameState.isStudent) leaveClassroom();
            if (gameState.battleId) leaveBattle();
            showScreen('welcomeScreen');
        }

        function selectAvatar(avatar) {
            playSound('click');
            gameState.avatar = avatar;
            document.querySelectorAll('#avatarGrid .avatar-option').forEach(o => o.classList.toggle('selected', o.dataset.avatar === avatar));
            saveGameState();
        }

        function selectStudentAvatar(avatar) {
            playSound('click');
            gameState.studentAvatar = avatar;
            document.querySelectorAll('#joinClassScreen .avatar-option').forEach(o => o.classList.toggle('selected', o.dataset.avatar === avatar));
        }

        function selectDifficulty(level) {
            playSound('click');
            gameState.difficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.toggle('selected', b.dataset.level === level));
            saveGameState();
        }

        function toggleTheme() {
            playSound('click');
            gameState.theme = gameState.theme === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = gameState.theme;
            document.getElementById('themeToggle').textContent = gameState.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            saveGameState();
        }

        function updateStats() {
            document.getElementById('totalScore').textContent = gameState.totalScore;
            document.getElementById('totalStars').textContent = gameState.totalStars;
        }

        function createConfetti() {
            const c = document.getElementById('confettiContainer'), colors = ['#FF6B35','#F7C948','#2ECC71','#9B59B6','#3498DB','#FF6B9D'];
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div'); p.className = 'confetti';
                p.style.cssText = `left:${Math.random()*100}%;background:${colors[Math.floor(Math.random()*colors.length)]};animation-delay:${Math.random()*0.5}s`;
                c.appendChild(p); setTimeout(() => p.remove(), 3000);
            }
        }

        // =====================================================
        // MASCOT
        // =====================================================
        const mascotPhrases = { wave: ['¬°Hola!','¬øListo?'], happy: ['¬°Genial!','¬°Bravo!'], sad: ['¬°√Ånimo!','Sigue'], thinking: ['Hmm...'] };
        function updateMascot(state, msg = null) {
            const m = document.getElementById('mascot'), s = document.getElementById('mascotSpeech');
            m.className = 'mascot ' + state;
            s.textContent = msg || mascotPhrases[state][Math.floor(Math.random()*mascotPhrases[state].length)];
            s.classList.add('show'); setTimeout(() => s.classList.remove('show'), 2000);
        }
        function mascotSpeak() { updateMascot('wave'); }

        // =====================================================
        // SOLO GAME - MAP
        // =====================================================
        function startGame() {
            playSound('click');
            gameState.playerName = document.getElementById('playerName').value.trim() || 'Jugador';
            saveGameState();
            showScreen('mapScreen');
            generateCountryButtons();
            updateMascot('wave', '¬°Elige pa√≠s!');
        }

        function filterCategory(cat) {
            playSound('click');
            gameState.selectedCategory = cat;
            document.querySelectorAll('.category-btn').forEach(b => b.classList.toggle('selected', b.dataset.category === cat));
        }

        function generateCountryButtons() {
            const m = document.getElementById('worldMap'); m.innerHTML = '';
            countries.forEach(c => {
                const b = document.createElement('button'); b.className = `country-btn ${c.class}`;
                const d = gameState.completedCountries[c.id];
                if (d) { b.classList.add('completed'); if (d.stars === 3) b.classList.add('perfect'); }
                b.innerHTML = `<div class="country-content"><span class="country-flag">${c.flag}</span><span class="country-name">${c.name}</span><span class="country-stars">${d ? '‚≠ê'.repeat(d.stars) : ''}</span></div>`;
                b.onclick = () => startQuiz(c);
                m.appendChild(b);
            });
        }

        function shuffleArray(a) { const s=[...a]; for(let i=s.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[s[i],s[j]]=[s[j],s[i]];} return s; }

        function getRandomQuestions(difficulty, category, count = 5) {
            let pool = questionBank[difficulty] || questionBank.A2;
            // Add custom questions
            pool = [...pool, ...gameState.customQuestions.filter(q => !difficulty || q.difficulty === difficulty)];
            if (category && category !== 'all') pool = pool.filter(q => q.cat === category);
            return shuffleArray(pool).slice(0, count).map(q => {
                if (q.type === 'fill') return { ...q };
                const corr = q.a[q.c], shuf = shuffleArray([...q.a]);
                return { ...q, a: shuf, c: shuf.indexOf(corr) };
            });
        }
Juega para estar aqu√≠!</li>' : lb.map((p, i) => `<li class="leaderboard-item ${p.name === gameState.playerName ? 'current-player' : ''}"><span class="leaderboard-rank ${i===0?'gold':i===1?'silver':i===2?'bronze':''}">${i+1}</span><span class="leaderboard-avatar">${p.avatar}</span><div class="leaderboard-info"><div class="leaderboard-name">${p.name}</div><div class="leaderboard-level">Nivel ${p.level}</div></div><span class="leaderboard-score">${p.score}</span></li>`).join('');
            document.getElementById('leaderboardModal').classList.add('active');
        }
        function closeLeaderboard() { document.getElementById('leaderboardModal').classList.remove('active'); }

        // =====================================================
        // FLASHCARDS
        // =====================================================
        let flashcardIndex = 0;
        function showFlashcards() {
            playSound('click');
            flashcardIndex = 0;
            updateFlashcard();
            showScreen('flashcardScreen');
        }
        function updateFlashcard() {
            const f = flashcards[flashcardIndex];
            document.getElementById('flashcardFront').textContent = f.front;
            document.getElementById('flashcardHint').textContent = f.cat;
            document.getElementById('flashcardBack').textContent = f.back;
            document.getElementById('flashcardProgress').textContent = `${flashcardIndex+1}/${flashcards.length}`;
            document.getElementById('flashcard').classList.remove('flipped');
        }
        function flipFlashcard() { playSound('click'); document.getElementById('flashcard').classList.toggle('flipped'); }
        function nextFlashcard() { playSound('click'); flashcardIndex = (flashcardIndex + 1) % flashcards.length; updateFlashcard(); }
        function prevFlashcard() { playSound('click'); flashcardIndex = (flashcardIndex - 1 + flashcards.length) % flashcards.length; updateFlashcard(); }

        // =====================================================
        // STORY MODE
        // =====================================================
        function startStoryMode() {
            playSound('click');
            showScreen('storyScreen');
            loadStoryScene();
        }

        function loadStoryScene() {
            const chapter = storyChapters[gameState.storyChapter];
            if (!chapter) { gameState.storyChapter = 0; loadStoryScene(); return; }
            document.getElementById('storyChapter').textContent = `Cap√≠tulo ${gameState.storyChapter + 1}`;
            document.getElementById('storyTitle').textContent = chapter.title;
            
            const scene = chapter.scenes[gameState.storyScene];
            const quizC = document.getElementById('storyQuizContainer');
            const sceneE = document.getElementById('storyScene');
            
            if (scene.quiz) {
                sceneE.style.display = 'none';
                quizC.style.display = 'block';
                document.getElementById('storyQuestionText').textContent = scene.question.q;
                const g = document.getElementById('storyAnswersGrid'); g.innerHTML = '';
                scene.question.a.forEach((a, i) => {
                    const b = document.createElement('button'); b.className = 'answer-btn'; b.textContent = a;
                    b.onclick = () => selectStoryAnswer(i, scene.question);
                    g.appendChild(b);
                });
                document.getElementById('storyContinueBtn').style.display = 'none';
            } else {
                quizC.style.display = 'none';
                sceneE.style.display = 'block';
                document.getElementById('storyCharAvatar').textContent = scene.char;
                document.getElementById('storyCharName').textContent = scene.name;
                document.getElementById('storyDialogue').textContent = scene.text;
                document.getElementById('storyNarrative').textContent = scene.narrative;
                document.getElementById('storyContinueBtn').style.display = 'inline-flex';
            }
            
            // Progress dots
            const prog = document.getElementById('storyProgress'); prog.innerHTML = '';
            chapter.scenes.forEach((_, i) => {
                const d = document.createElement('div');
                d.className = 'story-dot' + (i < gameState.storyScene ? ' completed' : i === gameState.storyScene ? ' active' : '');
                prog.appendChild(d);
            });
        }

        function selectStoryAnswer(idx, q) {
            const btns = document.querySelectorAll('#storyAnswersGrid .answer-btn');
            btns.forEach((b, i) => { b.disabled = true; if (i === q.c) b.classList.add('correct'); });
            if (idx === q.c) { playSound('correct'); addXP(10); } else { btns[idx].classList.add('incorrect'); playSound('wrong'); }
            document.getElementById('storyContinueBtn').style.display = 'inline-flex';
        }

        function continueStory() {
            playSound('click');
            const chapter = storyChapters[gameState.storyChapter];
            gameState.storyScene++;
            if (gameState.storyScene >= chapter.scenes.length) {
                gameState.storyChapter++;
                gameState.storyScene = 0;
                addXP(30);
                if (gameState.storyChapter >= storyChapters.length) {
                    checkAchievement('story');
                    alert('¬°Has completado la historia! M√°s cap√≠tulos pronto...');
                    goHome();
                    return;
                }
            }
            saveGameState();
            loadStoryScene();
        }

        // =====================================================
        // BATTLE MODE (1v1)
        // =====================================================
        function showBattleSetup() { playSound('click'); showScreen('battleSetupScreen'); document.getElementById('battleCodeDisplay').style.display = 'none'; document.getElementById('joinBattleForm').style.display = 'none'; document.getElementById('battlePlayers').style.display = 'none'; document.getElementById('startBattleBtn').style.display = 'none'; }
        function showJoinBattle() { playSound('click'); document.getElementById('joinBattleForm').style.display = 'block'; document.getElementById('battleCodeDisplay').style.display = 'none'; document.getElementById('battleError').style.display = 'none'; }

        function createBattle() {
            if (!firebaseInitialized) { alert('Firebase no configurado'); return; }
            playSound('click');
            gameState.playerName = document.getElementById('playerName').value.trim() || 'Jugador';
            const pin = Math.floor(1000 + Math.random() * 9000).toString();
            gameState.battleId = pin;
            gameState.isBattleHost = true;
            gameState.battleQuestions = getRandomQuestions(gameState.difficulty, 'all', 5);
            
            db.ref('battles/' + pin).set({
                host: gameState.playerName,
                hostAvatar: gameState.avatar,
                difficulty: gameState.difficulty,
                questions: gameState.battleQuestions,
                status: 'waiting',
                players: { host: { name: gameState.playerName, avatar: gameState.avatar, score: 0, answered: false } },
                currentQuestion: -1,
                created: Date.now()
            });
            
            document.getElementById('battleCode').textContent = pin;
            document.getElementById('battleCodeDisplay').style.display = 'block';
            document.getElementById('joinBattleForm').style.display = 'none';
            document.getElementById('battlePlayers').style.display = 'block';
            listenBattlePlayers(pin);
        }

        function joinBattle() {
            if (!firebaseInitialized) { alert('Firebase no configurado'); return; }
            playSound('click');
            const pin = document.getElementById('battleCodeInput').value.trim();
            if (pin.length !== 4) { document.getElementById('battleError').style.display = 'block'; return; }
            
            db.ref('battles/' + pin).once('value', snap => {
                if (!snap.exists() || snap.val().status !== 'waiting') {
                    document.getElementById('battleError').style.display = 'block';
                    return;
                }
                gameState.playerName = document.getElementById('playerName').value.trim() || 'Retador';
                gameState.battleId = pin;
                gameState.isBattleHost = false;
                
                db.ref('battles/' + pin + '/players/guest').set({
                    name: gameState.playerName,
                    avatar: gameState.avatar,
                    score: 0,
                    answered: false
                });
                
                document.getElementById('joinBattleForm').style.display = 'none';
                document.getElementById('battlePlayers').style.display = 'block';
                listenBattlePlayers(pin);
                listenBattleStatus(pin);
            });
        }

        function listenBattlePlayers(pin) {
            db.ref('battles/' + pin + '/players').on('value', snap => {
                const players = snap.val() || {};
                const grid = document.getElementById('battlePlayersGrid');
                grid.innerHTML = Object.entries(players).map(([k, p]) => `<div class="student-card"><span class="student-avatar">${p.avatar}</span><span class="student-name">${p.name}</span></div>`).join('');
                document.getElementById('battlePlayerCount').textContent = `${Object.keys(players).length}/2`;
                if (gameState.isBattleHost && Object.keys(players).length >= 2) {
                    document.getElementById('startBattleBtn').style.display = 'inline-flex';
                }
            });
        }

        function listenBattleStatus(pin) {
            db.ref('battles/' + pin).on('value', snap => {
                const data = snap.val();
                if (!data) return;
                if (data.status === 'playing' && data.currentQuestion >= 0) {
                    gameState.battleQuestions = data.questions;
                    gameState.battleQuestionIndex = data.currentQuestion;
                    showBattleQuestion();
                }
                if (data.status === 'finished') showBattleResults();
            });
        }

        function startBattle() {
            if (!gameState.isBattleHost) return;
            playSound('click');
            db.ref('battles/' + gameState.battleId).update({ status: 'playing', currentQuestion: 0, questionStartTime: Date.now() });
            gameState.battleQuestionIndex = 0;
            showBattleQuestion();
        }

        function showBattleQuestion() {
            showScreen('battleGameScreen');
            const q = gameState.battleQuestions[gameState.battleQuestionIndex];
            document.getElementById('battleQuestionCounter').textContent = `Pregunta ${gameState.battleQuestionIndex + 1} de ${gameState.battleQuestions.length}`;
            document.getElementById('battleQuestionText').textContent = q.q;
            document.getElementById('battleExplanation').classList.remove('show');
            
            const g = document.getElementById('battleAnswersGrid'); g.innerHTML = '';
            q.a.forEach((a, i) => {
                const b = document.createElement('button'); b.className = 'answer-btn'; b.textContent = a;
                b.onclick = () => submitBattleAnswer(i);
                g.appendChild(b);
            });
            
            // Listen for score updates
            db.ref('battles/' + gameState.battleId + '/players').on('value', snap => {
                const p = snap.val() || {};
                if (p.host) { document.getElementById('battleName1').textContent = p.host.name; document.getElementById('battleAvatar1').textContent = p.host.avatar; document.getElementById('battleScore1').textContent = p.host.score; }
                if (p.guest) { document.getElementById('battleName2').textContent = p.guest.name; document.getElementById('battleAvatar2').textContent = p.guest.avatar; document.getElementById('battleScore2').textContent = p.guest.score; }
            });
            
            startBattleTimer();
        }

        function startBattleTimer() {
            let time = 20;
            document.getElementById('battleTimer').textContent = time;
            document.getElementById('battleTimer').classList.remove('urgent');
            if (gameState.liveTimer) clearInterval(gameState.liveTimer);
            gameState.liveTimer = setInterval(() => {
                time--;
                document.getElementById('battleTimer').textContent = time;
                if (time <= 5) document.getElementById('battleTimer').classList.add('urgent');
                if (time <= 0) { clearInterval(gameState.liveTimer); battleTimeUp(); }
            }, 1000);
        }

        function submitBattleAnswer(idx) {
            clearInterval(gameState.liveTimer);
            const q = gameState.battleQuestions[gameState.battleQuestionIndex];
            const btns = document.querySelectorAll('#battleAnswersGrid .answer-btn');
            const playerKey = gameState.isBattleHost ? 'host' : 'guest';
            
            btns.forEach((b, i) => { b.disabled = true; if (i === q.c) b.classList.add('correct'); });
            
            if (idx === q.c) {
                gameState.battleScore += 100;
                btns[idx].classList.add('correct');
                playSound('correct');
                db.ref('battles/' + gameState.battleId + '/players/' + playerKey + '/score').transaction(s => (s || 0) + 100);
            } else {
                btns[idx].classList.add('incorrect');
                playSound('wrong');
            }
            
            document.getElementById('battleExplanationText').textContent = q.exp;
            document.getElementById('battleExplanation').classList.add('show');
            
            setTimeout(() => {
                if (gameState.isBattleHost) {
                    gameState.battleQuestionIndex++;
                    if (gameState.battleQuestionIndex < gameState.battleQuestions.length) {
                        db.ref('battles/' + gameState.battleId).update({ currentQuestion: gameState.battleQuestionIndex, questionStartTime: Date.now() });
                    } else {
                        db.ref('battles/' + gameState.battleId).update({ status: 'finished' });
                    }
                }
            }, 2500);
        }

        function battleTimeUp() { submitBattleAnswer(-1); }

        function showBattleResults() {
            showScreen('battleResultsScreen');
            db.ref('battles/' + gameState.battleId + '/players').once('value', snap => {
                const p = snap.val() || {};
                document.getElementById('finalName1').textContent = p.host?.name || 'Host';
                document.getElementById('finalAvatar1').textContent = p.host?.avatar || 'ü¶ä';
                document.getElementById('finalScore1').textContent = p.host?.score || 0;
                document.getElementById('finalName2').textContent = p.guest?.name || 'Guest';
                document.getElementById('finalAvatar2').textContent = p.guest?.avatar || 'üêº';
                document.getElementById('finalScore2').textContent = p.guest?.score || 0;
                
                const myKey = gameState.isBattleHost ? 'host' : 'guest';
                const oppKey = gameState.isBattleHost ? 'guest' : 'host';
                const myScore = p[myKey]?.score || 0;
                const oppScore = p[oppKey]?.score || 0;
                
                if (myScore > oppScore) {
                    document.getElementById('battleResultIcon').textContent = 'üèÜ';
                    document.getElementById('battleResultTitle').textContent = '¬°Victoria!';
                    document.getElementById('battleXpEarned').textContent = '+75 XP';
                    addXP(75);
                    checkAchievement('battle');
                    playSound('victory');
                    createConfetti();
                } else if (myScore < oppScore) {
                    document.getElementById('battleResultIcon').textContent = 'üò¢';
                    document.getElementById('battleResultTitle').textContent = 'Derrota';
                    document.getElementById('battleXpEarned').textContent = '+25 XP';
                    addXP(25);
                } else {
                    document.getElementById('battleResultIcon').textContent = 'ü§ù';
                    document.getElementById('battleResultTitle').textContent = '¬°Empate!';
                    document.getElementById('battleXpEarned').textContent = '+50 XP';
                    addXP(50);
                }
            });
        }

        function leaveBattle() {
            if (gameState.battleId) {
                db.ref('battles/' + gameState.battleId).off();
                if (gameState.isBattleHost) db.ref('battles/' + gameState.battleId).remove();
                gameState.battleId = null;
            }
        }

        // =====================================================
        // TEACHER - CLASSROOM MODE
        // =====================================================
        function showTeacherSetup() { playSound('click'); showScreen('teacherSetupScreen'); }
        function showJoinClass() { playSound('click'); showScreen('joinClassScreen'); document.getElementById('joinError').style.display = 'none'; }

        function createClassroom() {
            if (!firebaseInitialized) { alert('Firebase no configurado'); return; }
            playSound('click');
            const teacherName = document.getElementById('teacherName').value.trim() || 'Profesor';
            const difficulty = document.getElementById('teacherDifficulty').value;
            const questionCount = parseInt(document.getElementById('teacherQuestionCount').value);
            const gameMode = document.getElementById('teacherGameMode').value;
            
            const pin = Math.floor(1000 + Math.random() * 9000).toString();
            const country = countries[Math.floor(Math.random() * countries.length)];
            let questions = getRandomQuestions(difficulty, 'all', questionCount);
            if (gameState.customQuestions.length > 0) {
                questions = [...gameState.customQuestions.slice(0, questionCount)];
                if (questions.length < questionCount) questions = [...questions, ...getRandomQuestions(difficulty, 'all', questionCount - questions.length)];
            }
            
            gameState.isTeacher = true; gameState.classroomId = pin; gameState.classQuestions = questions; gameState.gameMode = gameMode;
            
            db.ref('classrooms/' + pin).set({
                teacher: teacherName, difficulty, country, questions,
                questionCount, gameMode, currentQuestion: -1,
                status: 'waiting', created: Date.now(),
                students: {}, teamScores: { red: 0, blue: 0, green: 0, yellow: 0 }
            });
            
            document.getElementById('classPin').textContent = pin;
            const qr = document.getElementById('qrcode'); qr.innerHTML = '';
            new QRCode(qr, { text: window.location.href.split('?')[0] + '?join=' + pin, width: 100, height: 100 });
            document.getElementById('teamModeSection').style.display = gameMode === 'teams' ? 'block' : 'none';
            
            showScreen('teacherLobbyScreen');
            listenToStudents(pin);
        }

        function listenToStudents(pin) {
            db.ref('classrooms/' + pin + '/students').on('value', snap => {
                const students = snap.val() || {};
                const grid = document.getElementById('studentsGrid');
                const count = Object.keys(students).length;
                document.getElementById('studentCount').textContent = count;
                document.getElementById('startClassBtn').disabled = count === 0;
                
                if (count === 0) { grid.innerHTML = '<div class="no-students">Esperando...</div>'; return; }
                
                grid.innerHTML = Object.entries(students).map(([id, s]) => {
                    const status = s.status || 'waiting';
                    return `<div class="student-card"><span class="student-avatar">${s.avatar || 'ü¶ä'}</span><span class="student-name">${s.name}</span>${s.team ? `<span style="font-size:0.7rem;">${{red:'üî¥',blue:'üîµ',green:'üü¢',yellow:'üü°'}[s.team]}</span>` : ''}<span class="student-score">${s.score || 0}</span></div>`;
                }).join('');
            });
        }

        function joinClassroom() {
            if (!firebaseInitialized) { alert('Firebase no configurado'); return; }
            playSound('click');
            const pin = document.getElementById('classCodeInput').value.trim();
            const name = document.getElementById('studentName').value.trim() || 'Estudiante';
            
            db.ref('classrooms/' + pin).once('value', snap => {
                if (!snap.exists()) { document.getElementById('joinError').style.display = 'block'; return; }
                const data = snap.val();
                
                gameState.isStudent = true; gameState.classroomId = pin; gameState.playerName = name;
                gameState.studentId = db.ref('classrooms/' + pin + '/students').push().key;
                
                db.ref('classrooms/' + pin + '/students/' + gameState.studentId).set({
                    name, avatar: gameState.studentAvatar, score: 0, status: 'waiting', joined: Date.now()
                });
                
                document.getElementById('teacherNameDisplay').textContent = data.teacher;
                document.getElementById('studentTeamSelection').style.display = data.gameMode === 'teams' ? 'block' : 'none';
                
                showScreen('studentWaitingScreen');
                listenToClassStatus(pin);
            });
        }

        function selectTeam(team) {
            playSound('click');
            gameState.selectedTeam = team;
            document.querySelectorAll('.team-card').forEach(c => c.classList.toggle('selected', c.classList.contains(team)));
            db.ref('classrooms/' + gameState.classroomId + '/students/' + gameState.studentId + '/team').set(team);
        }

        function listenToClassStatus(pin) {
            db.ref('classrooms/' + pin).on('value', snap => {
                const data = snap.val();
                if (!data) { goHome(); return; }
                if (data.status === 'playing' && data.currentQuestion >= 0) {
                    gameState.classQuestions = data.questions;
                    gameState.classQuestionIndex = data.currentQuestion;
                    showStudentQuestion(data);
                }
                if (data.status === 'finished') showStudentFinal();
            });
        }

        function startClassQuiz() {
            playSound('click');
            gameState.classQuestionIndex = 0;
            db.ref('classrooms/' + gameState.classroomId).update({ status: 'playing', currentQuestion: 0, questionStartTime: Date.now() });
            showTeacherQuestion();
        }

        function showTeacherQuestion() {
            showScreen('teacherQuizScreen');
            const q = gameState.classQuestions[gameState.classQuestionIndex];
            document.getElementById('liveQuestionNumber').textContent = `Pregunta ${gameState.classQuestionIndex + 1} de ${gameState.classQuestions.length}`;
            document.getElementById('liveQuestionText').textContent = q.q;
            document.getElementById('liveAnswerA').textContent = q.a[0];
            document.getElementById('liveAnswerB').textContent = q.a[1];
            document.getElementById('liveAnswerC').textContent = q.a[2];
            document.getElementById('liveAnswerD').textContent = q.a[3];
            
            document.querySelectorAll('.live-answer').forEach(a => a.classList.remove('correct'));
            document.getElementById('showResultsBtn').style.display = 'none';
            document.getElementById('nextQuestionBtn').style.display = 'none';
            document.getElementById('showFinalBtn').style.display = 'none';
            document.getElementById('teamScoresLive').style.display = gameState.gameMode === 'teams' ? 'block' : 'none';
            
            startLiveTimer();
            listenToResponses();
        }

        function startLiveTimer() {
            let time = 30;
            document.getElementById('liveTimer').textContent = time;
            document.getElementById('liveTimer').classList.remove('warning');
            if (gameState.liveTimer) clearInterval(gameState.liveTimer);
            gameState.liveTimer = setInterval(() => {
                time--;
                document.getElementById('liveTimer').textContent = time;
                if (time <= 10) document.getElementById('liveTimer').classList.add('warning');
                if (time <= 0) { clearInterval(gameState.liveTimer); document.getElementById('showResultsBtn').style.display = 'inline-flex'; }
            }, 1000);
        }

        function listenToResponses() {
            db.ref('classrooms/' + gameState.classroomId + '/students').on('value', snap => {
                const students = snap.val() || {};
                const total = Object.keys(students).length;
                const answered = Object.values(students).filter(s => s.answers && s.answers[gameState.classQuestionIndex] !== undefined).length;
                document.getElementById('responseCount').textContent = answered;
                document.getElementById('totalStudents').textContent = total;
                
                if (answered >= total && total > 0) {
                    clearInterval(gameState.liveTimer);
                    document.getElementById('showResultsBtn').style.display = 'inline-flex';
                }
            });
        }

        function showQuestionResults() {
            playSound('click');
            const q = gameState.classQuestions[gameState.classQuestionIndex];
            document.querySelectorAll('.live-answer').forEach((a, i) => { if (i === q.c) a.classList.add('correct'); });
            document.getElementById('showResultsBtn').style.display = 'none';
            
            db.ref('classrooms/' + gameState.classroomId).update({ showingResults: gameState.classQuestionIndex });
            
            if (gameState.classQuestionIndex < gameState.classQuestions.length - 1) {
                document.getElementById('nextQuestionBtn').style.display = 'inline-flex';
            } else {
                document.getElementById('showFinalBtn').style.display = 'inline-flex';
            }
        }

        function nextLiveQuestion() {
            playSound('click');
            gameState.classQuestionIndex++;
            db.ref('classrooms/' + gameState.classroomId).update({ currentQuestion: gameState.classQuestionIndex, questionStartTime: Date.now(), showingResults: -1 });
            showTeacherQuestion();
        }

        function showStudentQuestion(data) {
            showScreen('studentQuizScreen');
            const q = data.questions[data.currentQuestion];
            document.getElementById('studentQuestionNumber').textContent = `Pregunta ${data.currentQuestion + 1} de ${data.questions.length}`;
            document.getElementById('studentQuestionText').textContent = q.q;
            document.getElementById('studentFeedback').style.display = 'none';
            document.getElementById('waitingNext').style.display = 'none';
            
            const g = document.getElementById('studentAnswersGrid'); g.innerHTML = '';
            q.a.forEach((a, i) => {
                const b = document.createElement('button'); b.className = 'answer-btn'; b.textContent = a;
                b.onclick = () => submitStudentAnswer(i, q);
                g.appendChild(b);
            });
            
            // Timer sync
            const elapsed = Math.floor((Date.now() - data.questionStartTime) / 1000);
            let remaining = Math.max(0, 30 - elapsed);
            document.getElementById('studentTimer').textContent = remaining;
            if (gameState.liveTimer) clearInterval(gameState.liveTimer);
            gameState.liveTimer = setInterval(() => {
                remaining--;
                document.getElementById('studentTimer').textContent = remaining;
                if (remaining <= 0) clearInterval(gameState.liveTimer);
            }, 1000);
        }

        function submitStudentAnswer(idx, q) {
            clearInterval(gameState.liveTimer);
            const btns = document.querySelectorAll('#studentAnswersGrid .answer-btn');
            btns.forEach((b, i) => { b.disabled = true; if (i === q.c) b.classList.add('correct'); });
            
            let points = 0;
            if (idx === q.c) {
                points = 100;
                btns[idx].classList.add('correct');
                playSound('correct');
                document.getElementById('feedbackIcon').textContent = '‚úÖ';
                document.getElementById('feedbackText').textContent = '¬°Correcto!';
            } else {
                btns[idx].classList.add('incorrect');
                playSound('wrong');
                document.getElementById('feedbackIcon').textContent = '‚ùå';
                document.getElementById('feedbackText').textContent = `Respuesta: ${q.a[q.c]}`;
            }
            
            document.getElementById('studentFeedback').style.display = 'block';
            document.getElementById('waitingNext').style.display = 'block';
            
            // Save answer
            db.ref('classrooms/' + gameState.classroomId + '/students/' + gameState.studentId + '/answers/' + gameState.classQuestionIndex).set(idx);
            db.ref('classrooms/' + gameState.classroomId + '/students/' + gameState.studentId + '/score').transaction(s => (s || 0) + points);
            
            // Team score
            if (gameState.selectedTeam) {
                db.ref('classrooms/' + gameState.classroomId + '/teamScores/' + gameState.selectedTeam).transaction(s => (s || 0) + points);
            }
        }

        function showStudentFinal() {
            showScreen('studentFinalScreen');
            db.ref('classrooms/' + gameState.classroomId + '/students/' + gameState.studentId).once('value', snap => {
                const s = snap.val();
                document.getElementById('studentFinalScore').textContent = s.score || 0;
                const answers = s.answers || {};
                const correct = Object.keys(answers).filter(k => answers[k] === gameState.classQuestions[k]?.c).length;
                document.getElementById('studentCorrectCount').textContent = correct;
                document.getElementById('studentTotalCount').textContent = gameState.classQuestions.length;
                const xp = Math.floor((s.score || 0) / 10);
                document.getElementById('studentXpEarned').textContent = `+${xp} XP`;
                addXP(xp);
            });
            createConfetti();
        }

        function showFinalLeaderboard() {
            playSound('click');
            showScreen('teacherFinalScreen');
            db.ref('classrooms/' + gameState.classroomId + '/students').once('value', snap => {
                const students = snap.val() || {};
                const sorted = Object.entries(students).map(([id, s]) => ({ ...s, id })).sort((a, b) => (b.score || 0) - (a.score || 0));
                
                // Podium
                const podium = document.getElementById('podium');
                podium.innerHTML = sorted.slice(0, 3).map((s, i) => `<div class="podium-place ${['second','first','third'][[1,0,2][i]]}"><div class="podium-avatar">${s.avatar || 'ü¶ä'}</div><div class="podium-name">${s.name}</div><div class="podium-block">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â'}</div><div class="podium-score">${s.score || 0}</div></div>`).join('');
                
                // List
                document.getElementById('finalLeaderboard').innerHTML = `<h3 class="leaderboard-title">Todos</h3><ul class="leaderboard-list">${sorted.map((s, i) => `<li class="leaderboard-item"><span class="leaderboard-rank ${i===0?'gold':i===1?'silver':i===2?'bronze':''}">${i+1}</span><span class="leaderboard-avatar">${s.avatar || 'ü¶ä'}</span><div class="leaderboard-info"><div class="leaderboard-name">${s.name}</div></div><span class="leaderboard-score">${s.score || 0}</span></li>`).join('')}</ul>`;
                
                createConfetti();
                playSound('victory');
            });
            
            db.ref('classrooms/' + gameState.classroomId).update({ status: 'finished' });
        }

        function restartClass() {
            playSound('click');
            gameState.classQuestionIndex = 0;
            gameState.classQuestions = getRandomQuestions(document.getElementById('teacherDifficulty').value, 'all', gameState.classQuestions.length);
            db.ref('classrooms/' + gameState.classroomId).update({
                questions: gameState.classQuestions,
                currentQuestion: -1,
                status: 'waiting',
                showingResults: -1
            });
            db.ref('classrooms/' + gameState.classroomId + '/students').once('value', snap => {
                const updates = {};
                Object.keys(snap.val() || {}).forEach(k => { updates[k + '/score'] = 0; updates[k + '/answers'] = null; });
                db.ref('classrooms/' + gameState.classroomId + '/students').update(updates);
            });
            showScreen('teacherLobbyScreen');
        }

        function endClassroom() {
            if (gameState.classroomId) { db.ref('classrooms/' + gameState.classroomId).off(); db.ref('classrooms/' + gameState.classroomId).remove(); }
            gameState.classroomId = null; gameState.isTeacher = false;
            if (gameState.liveTimer) clearInterval(gameState.liveTimer);
            goHome();
        }

        function leaveClassroom() {
            if (gameState.classroomId && gameState.studentId) {
                db.ref('classrooms/' + gameState.classroomId).off();
                db.ref('classrooms/' + gameState.classroomId + '/students/' + gameState.studentId).remove();
            }
            gameState.classroomId = null; gameState.studentId = null; gameState.isStudent = false;
            if (gameState.liveTimer) clearInterval(gameState.liveTimer);
        }

        // =====================================================
        // CUSTOM QUESTIONS
        // =====================================================
        function showCustomQuestions() {
            playSound('click');
            showScreen('customQuestionsScreen');
            updateSavedQuestionsList();
        }

        function selectCorrectAnswer(idx) {
            playSound('click');
            gameState.correctAnswerIndex = idx;
            document.querySelectorAll('.correct-marker').forEach((m, i) => m.classList.toggle('selected', i === idx));
        }

        function saveCustomQuestion() {
            const text = document.getElementById('customQuestionText').value.trim();
            const answers = Array.from(document.querySelectorAll('.custom-answer')).map(i => i.value.trim());
            const category = document.getElementById('customCategory').value;
            const explanation = document.getElementById('customExplanation').value.trim();
            
            if (!text || answers.some(a => !a)) { alert('Completa todos los campos'); return; }
            
            gameState.customQuestions.push({
                q: text, a: answers, c: gameState.correctAnswerIndex,
                cat: category, exp: explanation || 'Sin explicaci√≥n', type: 'multiple'
            });
            
            saveGameState();
            playSound('correct');
            
            // Clear form
            document.getElementById('customQuestionText').value = '';
            document.querySelectorAll('.custom-answer').forEach(i => i.value = '');
            document.getElementById('customExplanation').value = '';
            selectCorrectAnswer(0);
            
            updateSavedQuestionsList();
        }

        function updateSavedQuestionsList() {
            document.getElementById('customQuestionCount').textContent = gameState.customQuestions.length;
            document.getElementById('savedQuestionsList').innerHTML = gameState.customQuestions.length === 0 
                ? '<p style="color:rgba(255,255,255,0.5);text-align:center;">No hay preguntas guardadas</p>'
                : gameState.customQuestions.map((q, i) => `<div class="saved-question-item"><span class="saved-question-text">${q.q.substring(0, 40)}...</span><div class="saved-question-actions"><button class="saved-question-btn delete" onclick="deleteCustomQuestion(${i})">üóëÔ∏è</button></div></div>`).join('');
        }

        function deleteCustomQuestion(idx) {
            playSound('click');
            gameState.customQuestions.splice(idx, 1);
            saveGameState();
            updateSavedQuestionsList();
        }

        // Initialize
        window.onload = init;
    </script>
</body>
</html>
