<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Quest - Aprende Espa√±ol Jugando üåé</title>
    <meta name="description" content="Juego educativo interactivo para aprender espa√±ol nivel A1-B1. Modo profesor con sincronizaci√≥n en tiempo real.">
    <meta name="author" content="ShieldStack Technologies">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #FF6B35;
            --secondary: #004E89;
            --accent: #F7C948;
            --success: #2ECC71;
            --danger: #E74C3C;
            --dark: #1A1A2E;
            --darker: #12121f;
            --light: #FFF8F0;
            --purple: #9B59B6;
        }
        [data-theme="light"] {
            --dark: #F5F5F5;
            --darker: #E8E8E8;
            --light: #1A1A2E;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--dark);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s;
        }
        .bg-pattern {
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255,107,53,0.12) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0,78,137,0.12) 0%, transparent 50%);
            z-index: 0;
            pointer-events: none;
        }
        .stars { position: fixed; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .star {
            position: absolute;
            width: 3px; height: 3px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.3); }
        }
        .confetti-container {
            position: fixed; inset: 0; pointer-events: none; z-index: 1000; overflow: hidden;
        }
        .confetti {
            position: absolute; width: 10px; height: 10px; top: -10px;
            animation: confetti-fall 3s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        header {
            position: relative; z-index: 10; padding: 15px 25px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(26,26,46,0.95); backdrop-filter: blur(10px);
            border-bottom: 3px solid var(--accent); flex-wrap: wrap; gap: 15px;
        }
        .logo {
            font-family: 'Fredoka One', cursive; font-size: 1.8rem;
            background: linear-gradient(135deg, #FF6B35, #F7C948);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            cursor: pointer; display: flex; align-items: center; gap: 10px;
        }
        .header-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .stats-bar { display: flex; gap: 15px; flex-wrap: wrap; }
        .stat {
            display: flex; align-items: center; gap: 6px; color: var(--light);
            font-weight: 600; font-size: 0.9rem; background: rgba(255,255,255,0.05);
            padding: 8px 12px; border-radius: 25px; cursor: pointer; transition: 0.3s;
        }
        .stat:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        .stat-value { color: var(--accent); font-weight: 800; }
        .toggle-btn {
            background: rgba(255,255,255,0.1); border: none; width: 42px; height: 42px;
            border-radius: 50%; cursor: pointer; font-size: 1.2rem; transition: 0.3s;
        }
        .toggle-btn:hover { background: rgba(255,255,255,0.2); }
        .toggle-btn.playing { animation: pulse-glow 1s infinite; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px var(--accent); } 50% { box-shadow: 0 0 20px var(--accent); } }
        .volume-control { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 20px; }
        .volume-slider { width: 60px; height: 5px; -webkit-appearance: none; background: rgba(255,255,255,0.2); border-radius: 3px; cursor: pointer; }
        .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--accent); border-radius: 50%; }
        .avatar-section { margin-bottom: 20px; }
        .avatar-section h3 { color: var(--light); margin-bottom: 10px; font-size: 0.95rem; }
        .avatar-grid { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .avatar-option { font-size: 2.2rem; padding: 10px; background: rgba(255,255,255,0.05); border: 3px solid transparent; border-radius: 15px; cursor: pointer; transition: 0.3s; }
        .avatar-option:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }
        .avatar-option.selected { border-color: var(--accent); background: rgba(247,201,72,0.2); }
        .player-avatar-display { font-size: 1.8rem; animation: avatar-bounce 2s infinite; }
        @keyframes avatar-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        .xp-display { background: linear-gradient(135deg, rgba(155,89,182,0.2), rgba(0,217,255,0.2)); border: 2px solid var(--purple); border-radius: 15px; padding: 15px 20px; margin-bottom: 20px; text-align: center; max-width: 320px; margin-left: auto; margin-right: auto; }
        .xp-title { color: var(--light); font-weight: 600; margin-bottom: 8px; }
        .xp-rank { font-family: 'Fredoka One', cursive; font-size: 1.4rem; color: var(--accent); }
        .xp-progress { width: 100%; height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, var(--purple), #00D9FF); transition: width 0.5s; }
        .xp-text { color: rgba(255,255,255,0.6); font-size: 0.8rem; margin-top: 5px; }
        .xp-earned { font-family: 'Fredoka One', cursive; font-size: 1.4rem; color: #00D9FF; margin: 15px 0; animation: xp-pulse 1s infinite; }
        @keyframes xp-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .game-modes { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 25px 0; }
        .mode-card { background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1); border-radius: 18px; padding: 22px 15px; text-align: center; cursor: pointer; transition: 0.3s; }
        .mode-card:hover { border-color: var(--accent); transform: translateY(-5px); background: rgba(255,255,255,0.08); }
        .mode-card-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .mode-card-title { color: var(--light); font-weight: 800; font-size: 1.1rem; margin-bottom: 5px; }
        .mode-card-desc { color: rgba(255,255,255,0.6); font-size: 0.8rem; }
        .mode-badge { display: inline-block; padding: 3px 10px; background: var(--success); color: white; border-radius: 10px; font-size: 0.7rem; font-weight: 700; margin-top: 8px; }
        .story-container { max-width: 750px; margin: 0 auto; background: linear-gradient(180deg, rgba(155,89,182,0.15) 0%, rgba(26,26,46,0.9) 100%); border-radius: 25px; border: 3px solid var(--purple); padding: 30px; }
        .story-chapter { color: var(--purple); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 3px; margin-bottom: 8px; text-align: center; }
        .story-title { font-family: 'Fredoka One', cursive; font-size: 1.8rem; color: var(--light); text-align: center; margin-bottom: 25px; }
        .story-scene { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .story-character { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px; }
        .story-char-avatar { font-size: 3rem; }
        .story-bubble { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; color: var(--light); line-height: 1.6; position: relative; }
        .story-bubble::before { content: ''; position: absolute; left: -10px; top: 15px; border: 10px solid transparent; border-right-color: rgba(255,255,255,0.1); }
        .story-char-name { font-weight: 700; color: var(--accent); margin-bottom: 5px; }
        .story-narrative { color: rgba(255,255,255,0.75); font-style: italic; text-align: center; margin: 20px 0; line-height: 1.7; }
        .story-progress { display: flex; justify-content: center; gap: 8px; margin: 20px 0; }
        .story-dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255,255,255,0.2); }
        .story-dot.active { background: var(--purple); }
        .story-dot.done { background: var(--success); }
        .battle-container { max-width: 850px; margin: 0 auto; background: linear-gradient(180deg, rgba(231,76,60,0.15) 0%, rgba(26,26,46,0.9) 100%); border-radius: 25px; border: 3px solid var(--danger); padding: 30px; }
        .battle-vs { font-family: 'Fredoka One', cursive; font-size: 3rem; color: var(--danger); text-align: center; margin: 15px 0; }
        .battle-players { display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 20px; }
        .battle-player { text-align: center; }
        .battle-player-avatar { font-size: 4rem; margin-bottom: 10px; }
        .battle-player-name { color: var(--light); font-weight: 700; font-size: 1.2rem; }
        .battle-player-score { font-family: 'Fredoka One', cursive; font-size: 2.5rem; color: var(--accent); }
        .battle-player.winner .battle-player-avatar { animation: winner-glow 1s infinite; }
        @keyframes winner-glow { 0%, 100% { filter: drop-shadow(0 0 10px var(--accent)); } 50% { filter: drop-shadow(0 0 30px var(--accent)); } }
        .battle-timer { font-family: 'Fredoka One', cursive; font-size: 4rem; color: var(--light); text-align: center; margin: 20px 0; }
        .battle-timer.urgent { color: var(--danger); animation: pulse 0.5s infinite; }
        .team-selection { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .team-card { padding: 25px; border-radius: 15px; text-align: center; cursor: pointer; transition: 0.3s; border: 3px solid transparent; }
        .team-card:hover { transform: translateY(-5px); }
        .team-card.selected { border-color: white; }
        .team-card.red { background: linear-gradient(135deg, #E74C3C, #C0392B); }
        .team-card.blue { background: linear-gradient(135deg, #3498DB, #2980B9); }
        .team-card.green { background: linear-gradient(135deg, #2ECC71, #27AE60); }
        .team-card.yellow { background: linear-gradient(135deg, #F7C948, #F39C12); }
        .team-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .team-name { color: white; font-weight: 800; font-size: 1.1rem; }
        .team-scores { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px; margin: 20px 0; }
        .team-score { text-align: center; }
        .team-score-label { font-weight: 700; margin-bottom: 5px; }
        .team-score-value { font-family: 'Fredoka One', cursive; font-size: 2rem; }
        .custom-q-form { background: rgba(0,0,0,0.2); border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; color: var(--light); font-weight: 600; margin-bottom: 6px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 16px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--light); font-family: 'Nunito', sans-serif; font-size: 1rem; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
        .form-select option { background: var(--dark); }
        .form-textarea { min-height: 80px; resize: vertical; }
        .answers-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .answer-input-wrap { position: relative; }
        .answer-input-wrap input { width: 100%; padding-right: 40px; }
        .correct-mark { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .correct-mark:hover { border-color: var(--success); }
        .correct-mark.selected { background: var(--success); border-color: var(--success); }
        .saved-q-item { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .saved-q-text { color: var(--light); font-weight: 600; flex: 1; }
        .saved-q-del { background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
        .mascot {
            position: fixed; bottom: 20px; left: 20px; z-index: 50;
            font-size: 3.5rem; cursor: pointer; transition: 0.3s;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
        }
        .mascot:hover { transform: scale(1.1) rotate(-5deg); }
        .mascot-speech {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: white; color: var(--dark); padding: 10px 15px;
            border-radius: 15px; font-size: 0.85rem; font-weight: 600;
            white-space: nowrap; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            opacity: 0; transition: 0.3s; pointer-events: none;
        }
        .mascot-speech.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        .container {
            position: relative; z-index: 5; max-width: 1400px; margin: 0 auto; padding: 25px;
        }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .welcome-container {
            text-align: center; padding: 50px 35px;
            background: linear-gradient(180deg, rgba(0,78,137,0.2) 0%, rgba(26,26,46,0.8) 100%);
            border-radius: 25px; border: 3px solid var(--accent); max-width: 850px; margin: 0 auto;
        }
        .welcome-icon { font-size: 4.5rem; margin-bottom: 15px; animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        .welcome-title {
            font-family: 'Fredoka One', cursive; font-size: 2.8rem;
            background: linear-gradient(135deg, #FF6B35, #F7C948);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 15px;
        }
        .welcome-desc {
            color: rgba(255,255,255,0.85); font-size: 1.1rem;
            max-width: 550px; margin: 0 auto 25px; line-height: 1.7;
        }
        .player-input-section { margin-bottom: 25px; }
        .player-input-section label {
            display: block; color: var(--light); margin-bottom: 8px; font-weight: 600;
        }
        .player-input {
            padding: 14px 25px; font-size: 1rem; border: 3px solid rgba(255,255,255,0.2);
            border-radius: 50px; background: rgba(255,255,255,0.05); color: var(--light);
            width: 100%; max-width: 320px; text-align: center; font-family: 'Nunito', sans-serif;
            transition: 0.3s;
        }
        .player-input:focus { outline: none; border-color: var(--accent); background: rgba(255,255,255,0.1); }
        .player-input::placeholder { color: rgba(255,255,255,0.4); }
        .difficulty-section { margin-bottom: 25px; }
        .difficulty-section h3 { color: var(--light); margin-bottom: 12px; font-size: 1rem; }
        .difficulty-buttons { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .difficulty-btn {
            padding: 10px 25px; border: 3px solid rgba(255,255,255,0.2); border-radius: 50px;
            background: rgba(255,255,255,0.05); color: var(--light); font-size: 0.95rem;
            font-family: 'Nunito', sans-serif; font-weight: 700; cursor: pointer; transition: 0.3s;
        }
        .difficulty-btn:hover { border-color: var(--accent); transform: translateY(-3px); }
        .difficulty-btn.selected {
            background: linear-gradient(135deg, #FF6B35, #F7C948); border-color: transparent; color: white;
        }
        .difficulty-btn .level-badge { display: block; font-size: 0.7rem; opacity: 0.8; margin-top: 2px; }
        .feature-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px; margin-bottom: 25px; text-align: left;
        }
        .feature-item {
            display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.8);
            font-size: 0.9rem; padding: 10px 12px; background: rgba(255,255,255,0.03); border-radius: 10px;
        }
        .btn {
            padding: 14px 35px; border: none; border-radius: 50px; font-family: 'Nunito', sans-serif;
            font-size: 1rem; font-weight: 800; cursor: pointer; transition: 0.3s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #FF6B35, #F7C948); color: white;
            box-shadow: 0 5px 25px rgba(255,107,53,0.4);
        }
        .btn-secondary { background: transparent; border: 3px solid var(--accent); color: var(--accent); }
        .btn-success { background: linear-gradient(135deg, #2ECC71, #27AE60); color: white; }
        .btn-purple { background: linear-gradient(135deg, #9B59B6, #8E44AD); color: white; }
        .btn-teacher { background: linear-gradient(135deg, #E74C3C, #C0392B); color: white; }
        .btn-danger { background: linear-gradient(135deg, #E74C3C, #C0392B); color: white; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 35px rgba(0,0,0,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-small { padding: 10px 22px; font-size: 0.9rem; }
        /* Map styles */
        .map-container {
            background: linear-gradient(180deg, #0077B6 0%, #004E89 50%, #003566 100%);
            border-radius: 25px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        .map-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
        }
        .map-title { color: white; font-family: 'Fredoka One', cursive; font-size: 1.8rem; }
        .map-subtitle { color: rgba(255,255,255,0.8); font-size: 0.95rem; }
        .category-filter { display: flex; gap: 8px; flex-wrap: wrap; }
        .category-btn {
            padding: 6px 14px; border: 2px solid rgba(255,255,255,0.3); border-radius: 20px;
            background: rgba(255,255,255,0.1); color: white; font-size: 0.8rem;
            font-family: 'Nunito', sans-serif; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .category-btn:hover { background: rgba(255,255,255,0.2); }
        .category-btn.selected { background: var(--accent); border-color: var(--accent); color: var(--dark); }
        .world-map {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px;
            max-width: 1000px; margin: 0 auto;
        }
        .country-btn {
            position: relative; aspect-ratio: 1; border: none; border-radius: 18px;
            cursor: pointer; transition: 0.3s; overflow: hidden; font-family: 'Nunito', sans-serif;
        }
        .country-btn::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, transparent 50%); z-index: 1;
        }
        .country-btn:hover { transform: translateY(-8px) scale(1.05); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .country-btn.completed::after {
            content: '‚úì'; position: absolute; top: 8px; right: 8px;
            width: 26px; height: 26px; background: var(--success); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 0.85rem; z-index: 5;
        }
        .country-btn.perfect::after { content: '‚òÖ'; background: var(--accent); }
        .country-flag { font-size: 2.5rem; display: block; margin-bottom: 4px; }
        .country-name { font-weight: 700; font-size: 0.85rem; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .country-stars { margin-top: 4px; font-size: 0.75rem; }
        .country-content {
            position: relative; z-index: 2; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 100%; padding: 10px;
        }
        .country-spain { background: linear-gradient(135deg, #C60B1E, #FFC400); }
        .country-mexico { background: linear-gradient(135deg, #006341, #CE1126); }
        .country-argentina { background: linear-gradient(135deg, #74ACDF, #F6B40E); }
        .country-colombia { background: linear-gradient(135deg, #FCD116, #003893); }
        .country-peru { background: linear-gradient(135deg, #D91023, #fff); }
        .country-chile { background: linear-gradient(135deg, #0039A6, #D52B1E); }
        .country-ecuador { background: linear-gradient(135deg, #FFD100, #0033A0); }
        .country-venezuela { background: linear-gradient(135deg, #FFCC00, #00247D); }
        .country-cuba { background: linear-gradient(135deg, #002A8F, #CB1515); }
        .country-costarica { background: linear-gradient(135deg, #002B7F, #CE1126); }
        /* Modal styles */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 100; align-items: center; justify-content: center;
            padding: 20px; overflow-y: auto;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .quiz-modal {
            background: var(--dark); border-radius: 22px; padding: 30px;
            max-width: 700px; width: 100%; position: relative;
            border: 3px solid var(--accent); box-shadow: 0 0 80px rgba(247,201,72,0.2);
            max-height: 90vh; overflow-y: auto;
        }
        .close-btn {
            position: absolute; top: 12px; right: 12px; width: 38px; height: 38px;
            border: none; border-radius: 50%; background: rgba(255,255,255,0.1);
            color: var(--light); font-size: 1.4rem; cursor: pointer; transition: 0.3s; z-index: 10;
        }
        .close-btn:hover { background: var(--danger); transform: rotate(90deg); }
        .country-info-card {
            background: rgba(255,255,255,0.05); border-radius: 15px; padding: 18px;
            margin-bottom: 20px; display: flex; align-items: center; gap: 18px;
        }
        .country-info-flag { font-size: 3.5rem; }
        .country-info-details h2 {
            color: var(--light); font-family: 'Fredoka One', cursive; font-size: 1.5rem; margin-bottom: 4px;
        }
        .country-info-details p { color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 2px; }
        .country-fun-fact {
            background: rgba(247,201,72,0.1); border-left: 4px solid var(--accent);
            padding: 10px 12px; margin-top: 8px; border-radius: 0 8px 8px 0;
            font-size: 0.85rem; color: rgba(255,255,255,0.9);
        }
        .quiz-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 18px; flex-wrap: wrap; gap: 12px;
        }
        .quiz-stats { display: flex; gap: 12px; }
        .quiz-stat {
            text-align: center; padding: 8px 16px; background: rgba(255,255,255,0.05); border-radius: 10px;
        }
        .quiz-stat-value { font-family: 'Fredoka One', cursive; font-size: 1.6rem; color: var(--accent); }
        .quiz-stat-value.timer-warning { color: var(--danger); animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .quiz-stat-label { font-size: 0.7rem; color: rgba(255,255,255,0.6); text-transform: uppercase; }
        .hint-btn {
            padding: 8px 16px; border: 2px solid var(--purple); border-radius: 20px;
            background: rgba(155,89,182,0.1); color: var(--purple); font-family: 'Nunito', sans-serif;
            font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 0.9rem;
        }
        .hint-btn:hover:not(:disabled) { background: var(--purple); color: white; }
        .hint-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .progress-bar {
            height: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;
            margin-bottom: 20px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(135deg, #FF6B35, #F7C948);
            border-radius: 8px; transition: width 0.4s;
        }
        .question-category {
            text-align: center; color: var(--accent); font-size: 0.8rem;
            font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px;
        }
        .question-counter { text-align: center; color: rgba(255,255,255,0.5); margin-bottom: 6px; font-size: 0.85rem; }
        .question-text {
            font-size: 1.3rem; color: var(--light); text-align: center;
            margin-bottom: 25px; line-height: 1.6; font-weight: 600;
        }
        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .answer-btn {
            padding: 16px 18px; border: 3px solid rgba(255,255,255,0.15); border-radius: 12px;
            background: rgba(255,255,255,0.03); color: var(--light); font-size: 1rem;
            font-family: 'Nunito', sans-serif; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .answer-btn:hover:not(:disabled) { border-color: var(--accent); background: rgba(247,201,72,0.1); }
        .answer-btn:disabled { cursor: not-allowed; }
        .answer-btn.correct { border-color: var(--success); background: rgba(46,204,113,0.25); }
        .answer-btn.incorrect { border-color: var(--danger); background: rgba(231,76,60,0.25); animation: shake 0.5s; }
        .answer-btn.eliminated { opacity: 0.3; text-decoration: line-through; pointer-events: none; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
        .explanation-box {
            margin-top: 20px; padding: 16px; background: rgba(255,255,255,0.05);
            border-radius: 12px; border-left: 4px solid var(--accent); display: none;
        }
        .explanation-box.show { display: block; animation: fadeIn 0.4s; }
        .explanation-title { color: var(--accent); font-weight: 700; margin-bottom: 6px; }
        .explanation-text { color: rgba(255,255,255,0.9); line-height: 1.6; font-size: 0.9rem; }
        .results-container { text-align: center; padding: 15px; }
        .results-icon { font-size: 4.5rem; margin-bottom: 12px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
        .results-title { font-family: 'Fredoka One', cursive; font-size: 2rem; color: var(--light); margin-bottom: 8px; }
        .results-score { font-size: 1.1rem; color: rgba(255,255,255,0.8); margin-bottom: 20px; }
        .results-score span { color: var(--accent); font-weight: 800; }
        .stars-earned { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .star-icon { font-size: 2.2rem; color: rgba(255,255,255,0.2); }
        .star-icon.earned { color: var(--accent); animation: star-pop 0.5s backwards; }
        @keyframes star-pop { 0% { transform: scale(0) rotate(-180deg); } 100% { transform: scale(1) rotate(0); } }
        .review-section { margin-top: 20px; text-align: left; }
        .review-title { color: var(--light); font-weight: 700; margin-bottom: 12px; }
        .review-item {
            background: rgba(231,76,60,0.1); border: 2px solid rgba(231,76,60,0.3);
            border-radius: 10px; padding: 12px; margin-bottom: 10px;
        }
        .review-question { color: var(--light); font-weight: 600; margin-bottom: 6px; }
        .review-answer .wrong { color: var(--danger); text-decoration: line-through; }
        .review-answer .correct { color: var(--success); font-weight: 700; }
        .review-explanation { margin-top: 6px; font-size: 0.8rem; color: rgba(255,255,255,0.7); font-style: italic; }
        .result-buttons { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        /* Leaderboard */
        .leaderboard-modal {
            background: var(--dark); border-radius: 22px; padding: 30px;
            max-width: 500px; width: 100%; border: 3px solid var(--accent);
        }
        .leaderboard-title {
            font-family: 'Fredoka One', cursive; font-size: 1.8rem; color: var(--light);
            text-align: center; margin-bottom: 20px;
        }
        .leaderboard-list { list-style: none; }
        .leaderboard-item {
            display: flex; align-items: center; padding: 12px;
            background: rgba(255,255,255,0.03); border-radius: 10px; margin-bottom: 8px;
        }
        .leaderboard-item.current-player { border: 2px solid var(--accent); background: rgba(247,201,72,0.1); }
        .leaderboard-rank { font-family: 'Fredoka One', cursive; font-size: 1.3rem; width: 45px; color: var(--accent); }
        .leaderboard-rank.gold { color: #FFD700; }
        .leaderboard-rank.silver { color: #C0C0C0; }
        .leaderboard-rank.bronze { color: #CD7F32; }
        .leaderboard-info { flex: 1; }
        .leaderboard-name { color: var(--light); font-weight: 700; }
        .leaderboard-stats { font-size: 0.8rem; color: rgba(255,255,255,0.6); }
        .leaderboard-score { font-family: 'Fredoka One', cursive; font-size: 1.2rem; color: var(--accent); }
        /* Teacher Mode */
        .teacher-container {
            text-align: center; padding: 40px 30px;
            background: linear-gradient(180deg, rgba(231,76,60,0.1) 0%, rgba(26,26,46,0.9) 100%);
            border-radius: 25px; border: 3px solid var(--danger); max-width: 900px; margin: 0 auto;
        }
        .teacher-title {
            font-family: 'Fredoka One', cursive; font-size: 2.5rem; color: var(--light); margin-bottom: 10px;
        }
        .teacher-subtitle { color: rgba(255,255,255,0.7); margin-bottom: 30px; }
        .pin-qr-container {
            display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; margin-bottom: 30px;
        }
        .pin-display {
            background: linear-gradient(135deg, #E74C3C, #C0392B); border-radius: 20px;
            padding: 25px 40px; text-align: center;
        }
        .pin-label { color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 2px; }
        .pin-code { font-family: 'Fredoka One', cursive; font-size: 4rem; color: white; letter-spacing: 12px; }
        .pin-hint { color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-top: 8px; }
        .qr-display {
            background: white; border-radius: 20px; padding: 20px; text-align: center;
        }
        .qr-display p { color: #333; font-size: 0.85rem; margin-top: 10px; font-weight: 600; }
        #qrcode { display: inline-block; }
        .students-section {
            background: rgba(255,255,255,0.03); border-radius: 15px; padding: 20px; margin-bottom: 25px;
        }
        .students-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .students-title { color: var(--light); font-weight: 700; font-size: 1.1rem; }
        .students-count {
            background: var(--accent); color: var(--dark); padding: 5px 15px;
            border-radius: 20px; font-weight: 800;
        }
        .students-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;
        }
        .student-card {
            background: rgba(255,255,255,0.05); border-radius: 10px; padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .student-name { color: var(--light); font-weight: 600; }
        .student-score { color: var(--accent); font-family: 'Fredoka One', cursive; }
        .student-status {
            padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;
        }
        .student-status.waiting { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); }
        .student-status.playing { background: rgba(46,204,113,0.2); color: var(--success); }
        .student-status.finished { background: rgba(247,201,72,0.2); color: var(--accent); }
        .teacher-controls { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .no-students { color: rgba(255,255,255,0.5); text-align: center; padding: 30px; }
        /* Student Waiting Room */
        .waiting-container {
            text-align: center; padding: 60px 40px;
            background: linear-gradient(180deg, rgba(155,89,182,0.1) 0%, rgba(26,26,46,0.9) 100%);
            border-radius: 25px; border: 3px solid var(--purple); max-width: 600px; margin: 0 auto;
        }
        .waiting-spinner { font-size: 5rem; animation: spin 2s linear infinite; margin-bottom: 20px; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .waiting-title { font-family: 'Fredoka One', cursive; font-size: 2rem; color: var(--light); margin-bottom: 10px; }
        .waiting-message { color: rgba(255,255,255,0.7); font-size: 1.1rem; margin-bottom: 20px; }
        .waiting-teacher { color: var(--accent); font-size: 1.2rem; }
        .waiting-teacher strong { color: var(--light); }
        /* Live Quiz (Teacher View) */
        .live-quiz-container {
            text-align: center; max-width: 1000px; margin: 0 auto;
        }
        .live-question-display {
            background: rgba(255,255,255,0.05); border-radius: 20px; padding: 40px;
            margin-bottom: 30px; border: 3px solid var(--accent);
        }
        .live-question-number {
            color: var(--accent); font-size: 0.9rem; text-transform: uppercase;
            letter-spacing: 3px; margin-bottom: 15px;
        }
        .live-question-text {
            font-family: 'Fredoka One', cursive; font-size: 2rem; color: var(--light);
            margin-bottom: 30px; line-height: 1.4;
        }
        .live-timer {
            font-family: 'Fredoka One', cursive; font-size: 5rem; color: var(--accent);
            margin-bottom: 20px;
        }
        .live-timer.warning { color: var(--danger); animation: pulse 0.5s infinite; }
        .live-answers-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 800px; margin: 0 auto 30px;
        }
        .live-answer {
            padding: 25px; border-radius: 15px; font-size: 1.2rem; font-weight: 700; color: white;
            display: flex; align-items: center; justify-content: center; min-height: 80px;
        }
        .live-answer.a { background: #E74C3C; }
        .live-answer.b { background: #3498DB; }
        .live-answer.c { background: #F7C948; }
        .live-answer.d { background: #2ECC71; }
        .live-answer.correct { box-shadow: 0 0 0 5px white, 0 0 30px rgba(46,204,113,0.5); }
        .live-responses {
            background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px;
        }
        .live-responses-title { color: var(--light); margin-bottom: 15px; }
        .responses-bar {
            height: 30px; background: rgba(255,255,255,0.1); border-radius: 15px;
            overflow: hidden; display: flex;
        }
        .response-segment { height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.85rem; }
        /* Live Leaderboard */
        .live-leaderboard {
            background: rgba(255,255,255,0.05); border-radius: 20px; padding: 30px;
            max-width: 600px; margin: 0 auto;
        }
        .podium { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin-bottom: 30px; }
        .podium-place { text-align: center; }
        .podium-place.first .podium-block { height: 120px; background: linear-gradient(135deg, #FFD700, #FFA500); }
        .podium-place.second .podium-block { height: 90px; background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
        .podium-place.third .podium-block { height: 70px; background: linear-gradient(135deg, #CD7F32, #8B4513); }
        .podium-block {
            width: 100px; border-radius: 10px 10px 0 0; display: flex; align-items: center;
            justify-content: center; font-family: 'Fredoka One', cursive; font-size: 2rem; color: white;
        }
        .podium-name { color: var(--light); font-weight: 700; margin-top: 10px; }
        .podium-score { color: var(--accent); font-family: 'Fredoka One', cursive; }
        /* Flashcards */
        .flashcard-container { max-width: 550px; margin: 0 auto; }
        .flashcard {
            background: linear-gradient(135deg, var(--secondary), #0077B6); border-radius: 22px;
            padding: 50px 35px; text-align: center; cursor: pointer; transition: transform 0.6s;
            transform-style: preserve-3d; min-height: 260px; position: relative;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { backface-visibility: hidden; }
        .flashcard-back {
            transform: rotateY(180deg); position: absolute; inset: 0;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 35px;
        }
        .flashcard-word { font-family: 'Fredoka One', cursive; font-size: 2.2rem; color: white; margin-bottom: 12px; }
        .flashcard-hint { color: rgba(255,255,255,0.7); font-size: 0.95rem; }
        .flashcard-nav { display: flex; justify-content: center; gap: 12px; margin-top: 22px; }
        /* Join Class Input */
        .join-input {
            font-family: 'Fredoka One', cursive; font-size: 2.5rem; text-align: center;
            letter-spacing: 10px; padding: 15px 30px; border: 3px solid rgba(255,255,255,0.2);
            border-radius: 15px; background: rgba(255,255,255,0.05); color: var(--light);
            width: 200px; text-transform: uppercase;
        }
        .join-input:focus { outline: none; border-color: var(--accent); }
        .join-error { color: var(--danger); margin-top: 15px; display: none; }
        /* Achievements */
        .achievements-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 18px;
        }
        .achievement-card {
            background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 16px; text-align: center; transition: 0.3s;
        }
        .achievement-card.unlocked { border-color: var(--purple); background: rgba(155,89,182,0.1); }
        .achievement-card.locked { opacity: 0.5; filter: grayscale(1); }
        .achievement-card-icon { font-size: 2rem; margin-bottom: 8px; }
        .achievement-card-name { color: var(--light); font-weight: 700; font-size: 0.9rem; }
        .achievement-card-desc { font-size: 0.7rem; color: rgba(255,255,255,0.6); }
        /* Teacher Setup */
        .teacher-setup {
            max-width: 500px; margin: 0 auto 30px; background: rgba(255,255,255,0.03);
            border-radius: 15px; padding: 25px;
        }
        .setup-group { margin-bottom: 20px; }
        .setup-label { color: var(--light); font-weight: 600; margin-bottom: 10px; display: block; }
        .setup-select {
            width: 100%; padding: 12px 20px; border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--light);
            font-family: 'Nunito', sans-serif; font-size: 1rem; cursor: pointer;
        }
        .setup-select:focus { outline: none; border-color: var(--accent); }
        .setup-select option { background: var(--dark); color: var(--light); }
        /* Responsive */
        @media (max-width: 900px) { .world-map { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) {
            header { padding: 12px 18px; }
            .logo { font-size: 1.4rem; }
            .world-map { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .quiz-modal { padding: 22px 18px; }
            .answers-grid { grid-template-columns: 1fr; }
            .welcome-title { font-size: 2rem; }
            .mascot { font-size: 2.8rem; bottom: 10px; left: 10px; }
            .pin-qr-container { flex-direction: column; align-items: center; }
            .pin-code { font-size: 3rem; letter-spacing: 8px; }
            .live-question-text { font-size: 1.5rem; }
            .live-timer { font-size: 4rem; }
            .live-answers-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="bg-pattern"></div>
    <div class="stars" id="stars"></div>
    <div class="confetti-container" id="confettiContainer"></div>
    <div class="mascot" id="mascot" onclick="mascotSpeak()">ü¶ú<div class="mascot-speech" id="mascotSpeech">¬°Hola!</div></div>
    
    <header>
        <div class="logo" onclick="goHome()"><span>üåé</span> Spanish Quest</div>
        <div class="header-controls">
            <div class="stats-bar" id="playerStats">
                <div class="stat"><span>üèÜ</span><span class="stat-value" id="totalScore">0</span></div>
                <div class="stat"><span>‚≠ê</span><span class="stat-value" id="totalStars">0</span></div>
                <div class="stat" onclick="showLeaderboard()"><span>üìä</span><span>Ranking</span></div>
                <div class="stat" onclick="showAchievements()"><span>üèÖ</span><span>Logros</span></div>
            </div>
            <button class="toggle-btn" id="soundToggle" onclick="toggleSound()">üîä</button>
            <button class="toggle-btn" id="musicToggle" onclick="toggleMusic()">üéµ</button>
            <div class="volume-control">
                <span style="font-size:0.8rem;">üîä</span>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50" onchange="setVolume(this.value)">
            </div>
            <button class="toggle-btn" id="themeToggle" onclick="toggleTheme()">üåô</button>
        </div>
    </header>

    <div class="container">
        <!-- Welcome Screen -->
        <div class="screen active" id="welcomeScreen">
            <div class="welcome-container">
                <div class="welcome-icon">üéÆ</div>
                <h1 class="welcome-title">¬°Spanish Quest Ultimate!</h1>
                <p class="welcome-desc">Aprende espa√±ol explorando pa√≠ses, batallando con amigos y viviendo historias √©picas.</p>
                
                <!-- XP Display -->
                <div class="xp-display" id="xpDisplay">
                    <div class="xp-title">Tu Nivel</div>
                    <div class="xp-rank" id="xpRank">üå± Novato</div>
                    <div class="xp-text" id="xpText">0 / 100 XP</div>
                    <div class="xp-progress"><div class="xp-fill" id="xpFill" style="width:0%"></div></div>
                </div>
                
                <div class="player-input-section">
                    <label for="playerName">Tu nombre:</label>
                    <input type="text" id="playerName" class="player-input" placeholder="Escribe tu nombre..." maxlength="20">
                </div>
                
                <!-- Avatar Selection -->
                <div class="avatar-section">
                    <h3>Elige tu avatar:</h3>
                    <div class="avatar-grid" id="avatarGrid">
                        <div class="avatar-option selected" data-avatar="ü¶ä" onclick="selectAvatar('ü¶ä')">ü¶ä</div>
                        <div class="avatar-option" data-avatar="üêº" onclick="selectAvatar('üêº')">üêº</div>
                        <div class="avatar-option" data-avatar="ü¶Å" onclick="selectAvatar('ü¶Å')">ü¶Å</div>
                        <div class="avatar-option" data-avatar="üê∏" onclick="selectAvatar('üê∏')">üê∏</div>
                        <div class="avatar-option" data-avatar="ü¶ã" onclick="selectAvatar('ü¶ã')">ü¶ã</div>
                        <div class="avatar-option" data-avatar="üê¢" onclick="selectAvatar('üê¢')">üê¢</div>
                        <div class="avatar-option" data-avatar="ü¶Ñ" onclick="selectAvatar('ü¶Ñ')">ü¶Ñ</div>
                        <div class="avatar-option" data-avatar="üêô" onclick="selectAvatar('üêô')">üêô</div>
                    </div>
                </div>
                
                <div class="difficulty-section">
                    <h3>Nivel de espa√±ol:</h3>
                    <div class="difficulty-buttons">
                        <button class="difficulty-btn" data-level="A1" onclick="selectDifficulty('A1')">Principiante<span class="level-badge">A1</span></button>
                        <button class="difficulty-btn selected" data-level="A2" onclick="selectDifficulty('A2')">Elemental<span class="level-badge">A2</span></button>
                        <button class="difficulty-btn" data-level="B1" onclick="selectDifficulty('B1')">Intermedio<span class="level-badge">B1</span></button>
                    </div>
                </div>
                
                <!-- Game Modes -->
                <div class="game-modes">
                    <div class="mode-card" onclick="startGame()">
                        <div class="mode-card-icon">üó∫Ô∏è</div>
                        <div class="mode-card-title">Aventura</div>
                        <div class="mode-card-desc">Explora pa√≠ses</div>
                    </div>
                    <div class="mode-card" onclick="startStoryMode()">
                        <div class="mode-card-icon">üìñ</div>
                        <div class="mode-card-title">Historia</div>
                        <div class="mode-card-desc">Modo narrativo</div>
                        <span class="mode-badge">NUEVO</span>
                    </div>
                    <div class="mode-card" onclick="showBattleSetup()">
                        <div class="mode-card-icon">‚öîÔ∏è</div>
                        <div class="mode-card-title">Batalla 1v1</div>
                        <div class="mode-card-desc">Reta amigos</div>
                        <span class="mode-badge">NUEVO</span>
                    </div>
                    <div class="mode-card" onclick="showFlashcards()">
                        <div class="mode-card-icon">üìö</div>
                        <div class="mode-card-title">Estudiar</div>
                        <div class="mode-card-desc">Flashcards</div>
                    </div>
                </div>
                
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                    <button class="btn btn-small btn-teacher" onclick="showTeacherSetup()">üë©‚Äçüè´ Modo Profesor</button>
                    <button class="btn btn-small btn-purple" onclick="showJoinClass()">üéì Unirse a Clase</button>
                </div>
            </div>
        </div>

        <!-- Story Mode Screen -->
        <div class="screen" id="storyScreen">
            <div class="story-container">
                <div class="story-chapter" id="storyChapter">Cap√≠tulo 1</div>
                <h1 class="story-title" id="storyTitle">El Viaje Comienza</h1>
                <div class="story-scene" id="storyScene">
                    <div class="story-character">
                        <div class="story-char-avatar" id="storyCharAvatar">üë®‚Äçüè´</div>
                        <div class="story-bubble">
                            <div class="story-char-name" id="storyCharName">Profesor Garc√≠a</div>
                            <div id="storyDialogue">¬°Bienvenido, aventurero!</div>
                        </div>
                    </div>
                    <div class="story-narrative" id="storyNarrative">El sol brilla mientras comienzas tu aventura...</div>
                </div>
                <div class="story-progress" id="storyProgress"></div>
                <div id="storyQuizBox" style="display:none;">
                    <div class="question-text" id="storyQuestion"></div>
                    <div class="answers-grid" id="storyAnswers"></div>
                </div>
                <div style="text-align:center;margin-top:20px;">
                    <button class="btn btn-primary" id="storyContinue" onclick="continueStory()">Continuar ‚Üí</button>
                    <button class="btn btn-secondary btn-small" onclick="goHome()" style="margin-left:10px;">‚Üê Salir</button>
                </div>
            </div>
        </div>

        <!-- Battle Setup Screen -->
        <div class="screen" id="battleSetupScreen">
            <div class="battle-container">
                <h1 class="welcome-title">‚öîÔ∏è Batalla 1v1</h1>
                <p class="welcome-desc">¬°Reta a un amigo y compitan en tiempo real!</p>
                
                <div style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap;margin:30px 0;">
                    <button class="btn btn-primary" onclick="createBattle()">üéØ Crear Batalla</button>
                    <button class="btn btn-secondary" onclick="showJoinBattle()">ü§ù Unirse</button>
                </div>
                
                <div id="battleCodeBox" style="display:none;text-align:center;margin:20px 0;">
                    <p style="color:var(--light);margin-bottom:10px;">Comparte este c√≥digo:</p>
                    <div class="pin-display" style="display:inline-block;">
                        <div class="pin-code" id="battleCode">----</div>
                    </div>
                </div>
                
                <div id="joinBattleBox" style="display:none;text-align:center;margin:20px 0;">
                    <p style="color:var(--light);margin-bottom:15px;">C√≥digo de batalla:</p>
                    <input type="text" class="join-input" id="battleCodeInput" maxlength="4" placeholder="----">
                    <p class="join-error" id="battleError">Batalla no encontrada</p>
                    <div style="margin-top:15px;">
                        <button class="btn btn-primary" onclick="joinBattle()">¬°Unirse!</button>
                    </div>
                </div>
                
                <div class="students-section" id="battlePlayersBox" style="display:none;">
                    <div class="students-header">
                        <span class="students-title">‚öîÔ∏è Jugadores</span>
                        <span class="students-count" id="battlePlayerCount">0/2</span>
                    </div>
                    <div class="students-grid" id="battlePlayersGrid"></div>
                </div>
                
                <div style="text-align:center;margin-top:20px;">
                    <button class="btn btn-success" id="startBattleBtn" onclick="startBattleGame()" style="display:none;">‚öîÔ∏è ¬°Comenzar!</button>
                    <button class="btn btn-secondary btn-small" onclick="goHome()">‚Üê Volver</button>
                </div>
            </div>
        </div>

        <!-- Battle Game Screen -->
        <div class="screen" id="battleGameScreen">
            <div class="battle-container">
                <div class="battle-players">
                    <div class="battle-player" id="battleP1">
                        <div class="battle-player-avatar" id="battleAvatar1">ü¶ä</div>
                        <div class="battle-player-name" id="battleName1">Jugador 1</div>
                        <div class="battle-player-score" id="battleScore1">0</div>
                    </div>
                    <div class="battle-vs">VS</div>
                    <div class="battle-player" id="battleP2">
                        <div class="battle-player-avatar" id="battleAvatar2">üêº</div>
                        <div class="battle-player-name" id="battleName2">Jugador 2</div>
                        <div class="battle-player-score" id="battleScore2">0</div>
                    </div>
                </div>
                <div class="battle-timer" id="battleTimer">20</div>
                <div style="background:rgba(0,0,0,0.3);border-radius:15px;padding:25px;margin:20px 0;">
                    <div class="question-counter" id="battleQCounter">Pregunta 1 de 5</div>
                    <div class="question-text" id="battleQText">Cargando...</div>
                    <div class="answers-grid" id="battleAnswersGrid"></div>
                </div>
                <div class="explanation-box" id="battleExplain">
                    <div class="explanation-title">üí° Explicaci√≥n</div>
                    <div class="explanation-text" id="battleExplainText"></div>
                </div>
            </div>
        </div>

        <!-- Battle Results Screen -->
        <div class="screen" id="battleResultsScreen">
            <div class="battle-container" style="text-align:center;">
                <div style="font-size:5rem;margin-bottom:15px;" id="battleResultIcon">üèÜ</div>
                <h1 class="welcome-title" id="battleResultTitle">¬°Victoria!</h1>
                <div class="battle-players" style="margin:30px 0;">
                    <div class="battle-player">
                        <div class="battle-player-avatar" id="finalAvatar1">ü¶ä</div>
                        <div class="battle-player-name" id="finalName1">Jugador 1</div>
                        <div class="battle-player-score" id="finalScore1">0</div>
                    </div>
                    <div class="battle-vs">VS</div>
                    <div class="battle-player">
                        <div class="battle-player-avatar" id="finalAvatar2">üêº</div>
                        <div class="battle-player-name" id="finalName2">Jugador 2</div>
                        <div class="battle-player-score" id="finalScore2">0</div>
                    </div>
                </div>
                <div class="xp-earned" id="battleXP">+50 XP</div>
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="showBattleSetup()">üîÑ Nueva</button>
                    <button class="btn btn-secondary" onclick="goHome()">‚Üê Men√∫</button>
                </div>
            </div>
        </div>

        <!-- Teacher Setup Screen -->
        <div class="screen" id="teacherSetupScreen">
            <div class="welcome-container" style="border-color: var(--danger);">
                <h1 class="welcome-title">üë©‚Äçüè´ Configurar Clase</h1>
                <p class="welcome-desc">Configura tu sesi√≥n de clase antes de comenzar.</p>
                
                <div class="teacher-setup">
                    <div class="setup-group">
                        <label class="setup-label">Tu nombre:</label>
                        <input type="text" id="teacherName" class="player-input" placeholder="Profesor Garc√≠a" maxlength="20" style="max-width:100%;">
                    </div>
                    
                    <div class="setup-group">
                        <label class="setup-label">Nivel de dificultad:</label>
                        <select id="teacherDifficulty" class="setup-select">
                            <option value="A1">A1 - Principiante</option>
                            <option value="A2" selected>A2 - Elemental</option>
                            <option value="B1">B1 - Intermedio</option>
                        </select>
                    </div>
                    
                    <div class="setup-group">
                        <label class="setup-label">Pa√≠s para jugar:</label>
                        <select id="teacherCountry" class="setup-select">
                            <option value="random">üé≤ Aleatorio</option>
                            <option value="spain">üá™üá∏ Espa√±a</option>
                            <option value="mexico">üá≤üáΩ M√©xico</option>
                            <option value="argentina">üá¶üá∑ Argentina</option>
                            <option value="colombia">üá®üá¥ Colombia</option>
                            <option value="peru">üáµüá™ Per√∫</option>
                            <option value="chile">üá®üá± Chile</option>
                            <option value="ecuador">üá™üá® Ecuador</option>
                            <option value="venezuela">üáªüá™ Venezuela</option>
                            <option value="cuba">üá®üá∫ Cuba</option>
                            <option value="costarica">üá®üá∑ Costa Rica</option>
                        </select>
                    </div>
                    
                    <div class="setup-group">
                        <label class="setup-label">N√∫mero de preguntas:</label>
                        <select id="teacherQuestionCount" class="setup-select">
                            <option value="5" selected>5 preguntas</option>
                            <option value="10">10 preguntas</option>
                            <option value="15">15 preguntas</option>
                            <option value="20">20 preguntas</option>
                        </select>
                    </div>
                </div>
                
                <div style="display:flex;gap:12px;justify-content:center;">
                    <button class="btn btn-secondary" onclick="goHome()">‚Üê Volver</button>
                    <button class="btn btn-teacher" onclick="createClassroom()">üéØ Crear Clase</button>
                </div>
            </div>
        </div>

        <!-- Teacher Lobby Screen -->
        <div class="screen" id="teacherLobbyScreen">
            <div class="teacher-container">
                <h1 class="teacher-title">üë©‚Äçüè´ Modo Profesor</h1>
                <p class="teacher-subtitle">Los estudiantes pueden unirse con el PIN o escaneando el c√≥digo QR</p>
                
                <div class="pin-qr-container">
                    <div class="pin-display">
                        <div class="pin-label">C√≥digo de Clase</div>
                        <div class="pin-code" id="classPin">----</div>
                        <div class="pin-hint">Los estudiantes hacen clic en "Unirse a Clase"</div>
                    </div>
                    <div class="qr-display">
                        <div id="qrcode"></div>
                        <p>Escanear para unirse</p>
                    </div>
                </div>
                
                <div class="students-section">
                    <div class="students-header">
                        <span class="students-title">üìã Estudiantes conectados</span>
                        <span class="students-count" id="studentCount">0</span>
                    </div>
                    <div class="students-grid" id="studentsGrid">
                        <div class="no-students">Esperando estudiantes...</div>
                    </div>
                </div>
                
                <div class="teacher-controls">
                    <button class="btn btn-success" onclick="startClassQuiz()" id="startClassBtn" disabled>
                        ‚ñ∂Ô∏è Iniciar Juego
                    </button>
                    <button class="btn btn-danger" onclick="endClassroom()">‚ùå Terminar Clase</button>
                </div>
            </div>
        </div>

        <!-- Teacher Live Quiz Screen -->
        <div class="screen" id="teacherQuizScreen">
            <div class="live-quiz-container">
                <div class="live-question-display">
                    <div class="live-question-number" id="liveQuestionNumber">Pregunta 1 de 5</div>
                    <div class="live-question-text" id="liveQuestionText">Cargando pregunta...</div>
                    <div class="live-timer" id="liveTimer">30</div>
                </div>
                
                <div class="live-answers-grid" id="liveAnswersGrid">
                    <div class="live-answer a" id="liveAnswerA">A</div>
                    <div class="live-answer b" id="liveAnswerB">B</div>
                    <div class="live-answer c" id="liveAnswerC">C</div>
                    <div class="live-answer d" id="liveAnswerD">D</div>
                </div>
                
                <div class="live-responses">
                    <div class="live-responses-title">Respuestas: <span id="responseCount">0</span> / <span id="totalStudents">0</span></div>
                    <div class="responses-bar" id="responsesBar"></div>
                </div>
                
                <div style="margin-top:20px;">
                    <button class="btn btn-primary" onclick="showQuestionResults()" id="showResultsBtn" style="display:none;">Ver Resultados</button>
                    <button class="btn btn-primary" onclick="nextLiveQuestion()" id="nextQuestionBtn" style="display:none;">Siguiente Pregunta ‚Üí</button>
                    <button class="btn btn-success" onclick="showFinalLeaderboard()" id="showFinalBtn" style="display:none;">üèÜ Ver Clasificaci√≥n Final</button>
                </div>
            </div>
        </div>

        <!-- Teacher Final Leaderboard -->
        <div class="screen" id="teacherFinalScreen">
            <div class="live-quiz-container">
                <h1 style="font-family:'Fredoka One',cursive;font-size:2.5rem;color:var(--light);margin-bottom:30px;">üèÜ Clasificaci√≥n Final</h1>
                
                <div class="podium" id="podium"></div>
                
                <div class="live-leaderboard" id="finalLeaderboard"></div>
                
                <div style="margin-top:30px;">
                    <button class="btn btn-secondary" onclick="endClassroom()">Terminar Clase</button>
                    <button class="btn btn-primary" onclick="restartClass()">üîÑ Nueva Partida</button>
                </div>
            </div>
        </div>

        <!-- Student Join Screen -->
        <div class="screen" id="joinClassScreen">
            <div class="welcome-container" style="border-color: var(--purple);">
                <h1 class="welcome-title">üéì Unirse a una Clase</h1>
                <p class="welcome-desc">Introduce el PIN que muestra tu profesor.</p>
                
                <div class="player-input-section">
                    <label>Tu nombre:</label>
                    <input type="text" id="studentName" class="player-input" placeholder="Tu nombre..." maxlength="20">
                </div>
                
                <div class="player-input-section">
                    <label>PIN de la clase:</label>
                    <input type="text" id="classCodeInput" class="join-input" maxlength="4" placeholder="----">
                </div>
                
                <p class="join-error" id="joinError">Clase no encontrada. Verifica el PIN.</p>
                
                <div style="display:flex;gap:12px;justify-content:center;margin-top:20px;">
                    <button class="btn btn-secondary" onclick="goHome()">‚Üê Volver</button>
                    <button class="btn btn-purple" onclick="joinClassroom()">Unirse ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Student Waiting Room -->
        <div class="screen" id="studentWaitingScreen">
            <div class="waiting-container">
                <div class="waiting-spinner">‚è≥</div>
                <h1 class="waiting-title">¬°Est√°s conectado!</h1>
                <p class="waiting-message" id="waitingMessage">Esperando a que el profesor inicie el juego...</p>
                <p class="waiting-teacher">Clase de: <strong id="teacherNameDisplay">Profesor</strong></p>
                <p style="color:rgba(255,255,255,0.5);margin-top:20px;font-size:0.9rem;">Nivel: <span id="classLevel">A2</span></p>
            </div>
        </div>

        <!-- Student Quiz Screen -->
        <div class="screen" id="studentQuizScreen">
            <div class="quiz-modal" style="position:relative;max-width:600px;margin:0 auto;border-color:var(--purple);">
                <div class="question-counter" id="studentQuestionNumber">Pregunta 1 de 5</div>
                <div class="live-timer" id="studentTimer" style="font-size:3rem;">30</div>
                <div class="question-text" id="studentQuestionText">Cargando...</div>
                
                <div class="answers-grid" id="studentAnswersGrid"></div>
                
                <div id="studentFeedback" style="display:none;text-align:center;margin-top:20px;">
                    <div id="feedbackIcon" style="font-size:4rem;"></div>
                    <div id="feedbackText" style="color:var(--light);font-size:1.2rem;margin-top:10px;"></div>
                    <div id="feedbackExplanation" style="color:rgba(255,255,255,0.7);margin-top:10px;"></div>
                </div>
                
                <div id="waitingNext" style="display:none;text-align:center;margin-top:20px;color:rgba(255,255,255,0.6);">
                    Esperando siguiente pregunta...
                </div>
            </div>
        </div>

        <!-- Student Final Score -->
        <div class="screen" id="studentFinalScreen">
            <div class="waiting-container" style="border-color:var(--accent);">
                <div style="font-size:5rem;margin-bottom:20px;">üéâ</div>
                <h1 class="waiting-title">¬°Juego Terminado!</h1>
                <p style="color:var(--accent);font-family:'Fredoka One',cursive;font-size:3rem;" id="studentFinalScore">0</p>
                <p style="color:rgba(255,255,255,0.7);">puntos</p>
                <p style="color:var(--light);margin-top:20px;font-size:1.2rem;">Correctas: <span id="studentCorrectCount">0</span> / <span id="studentTotalCount">0</span></p>
                <p style="color:rgba(255,255,255,0.6);margin-top:30px;">Mira la pantalla del profesor para ver la clasificaci√≥n final.</p>
            </div>
        </div>

        <!-- Solo Play Map Screen -->
        <div class="screen" id="mapScreen">
            <div class="map-container">
                <div class="map-header">
                    <div>
                        <h1 class="map-title">üó∫Ô∏è Mapa del Mundo Hispano</h1>
                        <p class="map-subtitle">Haz clic en un pa√≠s para comenzar</p>
                    </div>
                    <div class="category-filter">
                        <button class="category-btn selected" data-category="all" onclick="filterCategory('all')">Todas</button>
                        <button class="category-btn" data-category="gramatica" onclick="filterCategory('gramatica')">Gram√°tica</button>
                        <button class="category-btn" data-category="vocabulario" onclick="filterCategory('vocabulario')">Vocabulario</button>
                        <button class="category-btn" data-category="cultura" onclick="filterCategory('cultura')">Cultura</button>
                    </div>
                </div>
                <div class="world-map" id="worldMap"></div>
            </div>
        </div>

        <!-- Flashcard Screen -->
        <div class="screen" id="flashcardScreen">
            <div class="flashcard-container">
                <h2 style="color:var(--light);text-align:center;margin-bottom:20px;font-family:'Fredoka One',cursive;">üìñ Modo Estudio</h2>
                <div class="flashcard" id="flashcard" onclick="flipFlashcard()">
                    <div class="flashcard-front">
                        <div class="flashcard-word" id="flashcardFront">Cargando...</div>
                        <div class="flashcard-hint" id="flashcardHint">Categor√≠a</div>
                    </div>
                    <div class="flashcard-back">
                        <div class="flashcard-word" id="flashcardBack" style="font-size:1.3rem;">Respuesta</div>
                    </div>
                </div>
                <div class="flashcard-nav">
                    <button class="btn btn-secondary" onclick="prevFlashcard()">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="nextFlashcard()">Siguiente ‚Üí</button>
                </div>
                <div style="text-align:center;margin-top:15px;color:rgba(255,255,255,0.6);" id="flashcardProgress">1 / 10</div>
                <div style="text-align:center;margin-top:20px;">
                    <button class="btn btn-success" onclick="startGame()">¬°Listo para Jugar! üéÆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Modal (Solo Play) -->
    <div class="modal-overlay" id="quizModal">
        <div class="quiz-modal">
            <button class="close-btn" onclick="closeQuiz()">√ó</button>
            <div id="quizContent">
                <div class="country-info-card">
                    <span class="country-info-flag" id="countryFlag">üá™üá∏</span>
                    <div class="country-info-details">
                        <h2 id="countryName">Espa√±a</h2>
                        <p id="countryCapital">Capital: Madrid</p>
                        <p id="countryPopulation">Poblaci√≥n: 47M</p>
                        <div class="country-fun-fact" id="countryFunFact"></div>
                    </div>
                </div>
                <div class="quiz-header">
                    <div class="quiz-stats">
                        <div class="quiz-stat"><div class="quiz-stat-value" id="timerDisplay">30</div><div class="quiz-stat-label">Segundos</div></div>
                        <div class="quiz-stat"><div class="quiz-stat-value" id="scoreDisplay">0</div><div class="quiz-stat-label">Puntos</div></div>
                    </div>
                    <button class="hint-btn" id="hintBtn" onclick="useHint()">üí° Pista (<span id="hintsRemaining">2</span>)</button>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="question-category" id="questionCategory">Gram√°tica</div>
                <div class="question-counter" id="questionCounter">Pregunta 1 de 5</div>
                <div class="question-text" id="questionText">Cargando...</div>
                <div class="answers-grid" id="answersGrid"></div>
                <div class="explanation-box" id="explanationBox">
                    <div class="explanation-title">üí° Explicaci√≥n</div>
                    <div class="explanation-text" id="explanationText"></div>
                </div>
            </div>
            <div id="resultsContent" style="display:none;">
                <div class="results-container">
                    <div class="results-icon" id="resultsIcon">üéâ</div>
                    <h2 class="results-title" id="resultsTitle">¬°Excelente!</h2>
                    <p class="results-score" id="resultsScore"></p>
                    <div class="stars-earned" id="starsEarned"></div>
                    <div class="review-section" id="reviewSection" style="display:none;">
                        <div class="review-title">üìù Repaso de errores:</div>
                        <div id="reviewList"></div>
                    </div>
                    <div class="result-buttons">
                        <button class="btn btn-secondary" onclick="closeQuiz()">üó∫Ô∏è Volver</button>
                        <button class="btn btn-primary" onclick="retryQuiz()">üîÑ Reintentar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div class="modal-overlay" id="leaderboardModal">
        <div class="leaderboard-modal">
            <button class="close-btn" onclick="closeLeaderboard()">√ó</button>
            <h2 class="leaderboard-title">üèÜ Clasificaci√≥n</h2>
            <ul class="leaderboard-list" id="leaderboardList"></ul>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div class="modal-overlay" id="achievementsModal">
        <div class="quiz-modal" style="max-width:600px;">
            <button class="close-btn" onclick="closeAchievements()">√ó</button>
            <h2 style="color:var(--light);text-align:center;font-family:'Fredoka One',cursive;">üèÖ Logros</h2>
            <p style="color:rgba(255,255,255,0.6);text-align:center;" id="achievementProgress">0 de 12</p>
            <div class="achievements-grid" id="achievementsGrid"></div>
        </div>
    </div>

    <script>
        // =====================================================
        // üî• FIREBASE CONFIGURATION - REPLACE WITH YOUR CONFIG
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCyjx25i8U6tP0jxGBpyzmKI1cAKjnsiNc",
            authDomain: "spanish-quest-fa18f.firebaseapp.com",
            databaseURL: "https://spanish-quest-fa18f-default-rtdb.firebaseio.com",
            projectId: "spanish-quest-fa18f",
            storageBucket: "spanish-quest-fa18f.firebasestorage.app",
            messagingSenderId: "113801000060",
            appId: "1:113801000060:web:89432cbbab4406900785f9"
        };
        
        // Initialize Firebase
        let db = null;
        let firebaseInitialized = false;
        
        function initFirebase() {
            try {
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.warn("Firebase not configured - using local mode");
                    return false;
                }
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                firebaseInitialized = true;
                console.log("Firebase initialized!");
                return true;
            } catch (e) {
                console.error("Firebase init error:", e);
                return false;
            }
        }

        // ==================== GAME DATA ====================
        const countries = [
            { id: 'spain', name: 'Espa√±a', flag: 'üá™üá∏', capital: 'Madrid', population: '47M', class: 'country-spain', funFact: 'Espa√±a tiene m√°s bares por habitante que cualquier otro pa√≠s de la UE.' },
            { id: 'mexico', name: 'M√©xico', flag: 'üá≤üáΩ', capital: 'Ciudad de M√©xico', population: '128M', class: 'country-mexico', funFact: 'M√©xico introdujo el chocolate, el chile y el ma√≠z al mundo.' },
            { id: 'argentina', name: 'Argentina', flag: 'üá¶üá∑', capital: 'Buenos Aires', population: '45M', class: 'country-argentina', funFact: 'Argentina tiene m√°s psic√≥logos per c√°pita que cualquier otro pa√≠s.' },
            { id: 'colombia', name: 'Colombia', flag: 'üá®üá¥', capital: 'Bogot√°', population: '51M', class: 'country-colombia', funFact: 'Colombia es el segundo pa√≠s con mayor biodiversidad.' },
            { id: 'peru', name: 'Per√∫', flag: 'üáµüá™', capital: 'Lima', population: '33M', class: 'country-peru', funFact: 'Per√∫ tiene m√°s de 3,000 variedades de papas.' },
            { id: 'chile', name: 'Chile', flag: 'üá®üá±', capital: 'Santiago', population: '19M', class: 'country-chile', funFact: 'Chile tiene el desierto m√°s seco: el Atacama.' },
            { id: 'ecuador', name: 'Ecuador', flag: 'üá™üá®', capital: 'Quito', population: '18M', class: 'country-ecuador', funFact: 'Gal√°pagos inspir√≥ la teor√≠a de la evoluci√≥n.' },
            { id: 'venezuela', name: 'Venezuela', flag: 'üáªüá™', capital: 'Caracas', population: '28M', class: 'country-venezuela', funFact: 'Venezuela tiene la cascada m√°s alta: Salto √Ångel.' },
            { id: 'cuba', name: 'Cuba', flag: 'üá®üá∫', capital: 'La Habana', population: '11M', class: 'country-cuba', funFact: 'Cuba tiene excelente sistema de salud.' },
            { id: 'costarica', name: 'Costa Rica', flag: 'üá®üá∑', capital: 'San Jos√©', population: '5M', class: 'country-costarica', funFact: 'Costa Rica no tiene ej√©rcito desde 1948.' }
        ];

        const questionBank = {
            A1: [
                { question: "¬øCu√°l es el art√≠culo? '___ libro'", answers: ["El", "La", "Los", "Las"], correct: 0, category: "gramatica", explanation: "'Libro' es masculino singular." },
                { question: "Completa: 'Yo ___ estudiante.'", answers: ["soy", "eres", "es", "somos"], correct: 0, category: "gramatica", explanation: "Con 'yo' usamos 'soy'." },
                { question: "'I have' en espa√±ol es...", answers: ["Yo tengo", "Yo soy", "Yo estoy", "Yo hago"], correct: 0, category: "gramatica", explanation: "'Tener' = to have." },
                { question: "Completa: 'Ella ___ de M√©xico.'", answers: ["es", "est√°", "son", "est√°n"], correct: 0, category: "gramatica", explanation: "'Ser' para origen." },
                { question: "El plural de 'casa' es...", answers: ["casas", "casaes", "casis", "casa"], correct: 0, category: "gramatica", explanation: "A√±adimos -s." },
                { question: "'Buenos d√≠as' se usa por la...", answers: ["ma√±ana", "noche", "tarde", "siempre"], correct: 0, category: "vocabulario", explanation: "Por la ma√±ana." },
                { question: "'Water' en espa√±ol es...", answers: ["agua", "leche", "jugo", "caf√©"], correct: 0, category: "vocabulario", explanation: "Agua = water." },
                { question: "Despu√©s del lunes viene...", answers: ["martes", "mi√©rcoles", "domingo", "viernes"], correct: 0, category: "vocabulario", explanation: "Lunes, martes, mi√©rcoles..." },
                { question: "'Quince' es el n√∫mero...", answers: ["15", "50", "5", "25"], correct: 0, category: "vocabulario", explanation: "Quince = 15." },
                { question: "El cielo es de color...", answers: ["azul", "verde", "rojo", "amarillo"], correct: 0, category: "vocabulario", explanation: "El cielo es azul." },
                { question: "La capital de Espa√±a es...", answers: ["Madrid", "Barcelona", "Sevilla", "Valencia"], correct: 0, category: "cultura", explanation: "Madrid es la capital." },
                { question: "En M√©xico se habla...", answers: ["espa√±ol", "portugu√©s", "italiano", "franc√©s"], correct: 0, category: "cultura", explanation: "Se habla espa√±ol." }
            ],
            A2: [
                { question: "Completa: 'Hoy yo ___ un caf√©.'", answers: ["he tomado", "ha tomado", "has tomado", "hemos tomado"], correct: 0, category: "gramatica", explanation: "Yo + he + participio." },
                { question: "'Ella nunca ___ a Espa√±a.'", answers: ["ha viajado", "he viajado", "has viajado", "han viajado"], correct: 0, category: "gramatica", explanation: "Ella + ha + participio." },
                { question: "'Nosotros ___ la pel√≠cula.'", answers: ["hemos visto", "he visto", "han visto", "ha visto"], correct: 0, category: "gramatica", explanation: "Nosotros + hemos." },
                { question: "'Mi hermana ___ cansada.'", answers: ["est√°", "es", "son", "est√°n"], correct: 0, category: "gramatica", explanation: "'Estar' para estados temporales." },
                { question: "'Barcelona ___ bonita.'", answers: ["es", "est√°", "son", "est√°n"], correct: 0, category: "gramatica", explanation: "'Ser' para caracter√≠sticas." },
                { question: "'¬øD√≥nde ___ el banco?'", answers: ["est√°", "es", "son", "est√°n"], correct: 0, category: "gramatica", explanation: "'Estar' para ubicaci√≥n." },
                { question: "'La sopa ___ caliente.'", answers: ["est√°", "es", "son", "est√°n"], correct: 0, category: "gramatica", explanation: "Temperatura = estar." },
                { question: "'Los chicos ___ de Francia.'", answers: ["son", "est√°n", "es", "est√°"], correct: 0, category: "gramatica", explanation: "Origen = ser." },
                { question: "'Desayuno' significa...", answers: ["primera comida", "almuerzo", "cena", "merienda"], correct: 0, category: "vocabulario", explanation: "Primera comida del d√≠a." },
                { question: "Opuesto de 'grande':", answers: ["peque√±o", "alto", "largo", "ancho"], correct: 0, category: "vocabulario", explanation: "Grande ‚Üî peque√±o." },
                { question: "¬øD√≥nde duermes?", answers: ["en la cama", "en la cocina", "en el jard√≠n", "en el garaje"], correct: 0, category: "vocabulario", explanation: "En la cama." },
                { question: "'A m√≠ ___ el chocolate.'", answers: ["me gusta", "me gustan", "te gusta", "le gusta"], correct: 0, category: "gramatica", explanation: "'Gusta' singular." },
                { question: "'A ellos ___ las pel√≠culas.'", answers: ["les gustan", "les gusta", "le gustan", "nos gustan"], correct: 0, category: "gramatica", explanation: "'Gustan' plural." },
                { question: "'Hace fr√≠o' = ...", answers: ["It's cold", "It's hot", "It's raining", "It's sunny"], correct: 0, category: "vocabulario", explanation: "Hace fr√≠o = It's cold." },
                { question: "'Las tres y media' = ...", answers: ["3:30", "3:15", "3:45", "3:00"], correct: 0, category: "vocabulario", explanation: "Y media = :30." },
                { question: "'¬ø___ vives?' - 'En Madrid.'", answers: ["D√≥nde", "Cu√°ndo", "Qui√©n", "Qu√©"], correct: 0, category: "gramatica", explanation: "D√≥nde = where." },
                { question: "'¬ø___ cuesta?'", answers: ["Cu√°nto", "Cu√°ndo", "C√≥mo", "D√≥nde"], correct: 0, category: "gramatica", explanation: "Cu√°nto = how much." },
                { question: "La moneda de Espa√±a es...", answers: ["el euro", "el peso", "el d√≥lar", "la libra"], correct: 0, category: "cultura", explanation: "Espa√±a usa el euro." },
                { question: "La paella es de...", answers: ["Espa√±a", "M√©xico", "Argentina", "Per√∫"], correct: 0, category: "cultura", explanation: "De Valencia, Espa√±a." },
                { question: "El tango es de...", answers: ["Argentina", "Espa√±a", "Cuba", "Colombia"], correct: 0, category: "cultura", explanation: "De Buenos Aires." }
            ],
            B1: [
                { question: "'Espero que t√∫ ___ bien.'", answers: ["est√©s", "est√°s", "estar", "estar√°s"], correct: 0, category: "gramatica", explanation: "'Espero que' + subjuntivo." },
                { question: "'Quiero que ella ___.'", answers: ["venga", "viene", "venir", "vendr√°"], correct: 0, category: "gramatica", explanation: "'Querer que' + subjuntivo." },
                { question: "'Es importante que ___.'", answers: ["estudiemos", "estudiamos", "estudiar", "estudiaremos"], correct: 0, category: "gramatica", explanation: "'Es importante que' + subj." },
                { question: "'Si tuviera dinero, ___.'", answers: ["comprar√≠a", "compro", "compr√©", "he comprado"], correct: 0, category: "gramatica", explanation: "Si + subj. ‚Üí condicional." },
                { question: "'Me ___ ir de vacaciones.'", answers: ["gustar√≠a", "gusta", "gust√≥", "gustaba"], correct: 0, category: "gramatica", explanation: "Condicional para deseos." },
                { question: "'Cuando era ni√±o, ___ al parque.'", answers: ["iba", "fui", "voy", "ir√©"], correct: 0, category: "gramatica", explanation: "Imperfecto para h√°bitos." },
                { question: "'Ayer ___ a Mar√≠a.'", answers: ["vi", "ve√≠a", "veo", "he visto"], correct: 0, category: "gramatica", explanation: "Indefinido para acciones puntuales." },
                { question: "'Mientras yo ___, ella cocinaba.'", answers: ["estudiaba", "estudi√©", "estudio", "estudiar√©"], correct: 0, category: "gramatica", explanation: "'Mientras' + imperfecto." },
                { question: "'La chica ___ conoc√≠...'", answers: ["que", "quien", "cual", "cuyo"], correct: 0, category: "gramatica", explanation: "'Que' es el m√°s com√∫n." },
                { question: "'Echar de menos' = ...", answers: ["extra√±ar", "tirar", "perder", "olvidar"], correct: 0, category: "vocabulario", explanation: "Echar de menos = to miss." },
                { question: "'Tener ganas de' = ...", answers: ["querer hacer", "tener miedo", "tener hambre", "estar cansado"], correct: 0, category: "vocabulario", explanation: "= feel like doing." },
                { question: "'Este regalo es ___ ti.'", answers: ["para", "por", "a", "de"], correct: 0, category: "gramatica", explanation: "'Para' = destinatario." },
                { question: "'Gracias ___ tu ayuda.'", answers: ["por", "para", "a", "de"], correct: 0, category: "gramatica", explanation: "'Por' = causa." },
                { question: "'La siesta' es...", answers: ["descanso despu√©s de comer", "fiesta", "comida", "baile"], correct: 0, category: "cultura", explanation: "Descanso despu√©s de comer." },
                { question: "D√≠a de los Muertos es de...", answers: ["M√©xico", "Espa√±a", "Argentina", "Chile"], correct: 0, category: "cultura", explanation: "Se celebra en M√©xico." },
                { question: "'El mate' es...", answers: ["infusi√≥n argentina", "baile espa√±ol", "comida mexicana", "instrumento"], correct: 0, category: "cultura", explanation: "Infusi√≥n de yerba mate." }
            ]
        };

        const flashcards = [
            { front: "Ser vs Estar", back: "SER: identidad, origen. ESTAR: ubicaci√≥n, temporal.", category: "Gram√°tica" },
            { front: "Pret√©rito Perfecto", back: "He/Has/Ha/Hemos/Han + participio", category: "Gram√°tica" },
            { front: "Gustar", back: "A m√≠ ME gusta, A ti TE gusta...", category: "Gram√°tica" },
            { front: "Por vs Para", back: "POR: causa. PARA: destino.", category: "Gram√°tica" },
            { front: "Subjuntivo", back: "Despu√©s de: querer que, esperar que...", category: "Gram√°tica" },
            { front: "Buenos d√≠as", back: "Good morning", category: "Saludos" },
            { front: "¬øCu√°nto cuesta?", back: "How much?", category: "Frases" },
            { front: "Echar de menos", back: "To miss someone", category: "Expresiones" },
            { front: "Tener ganas de", back: "To feel like", category: "Expresiones" },
            { front: "Hace fr√≠o/calor", back: "It's cold/hot", category: "Clima" }
        ];

        const achievements = [
            { id: 'first', name: 'Primera Misi√≥n', desc: 'Completa una misi√≥n', icon: 'üéØ', unlocked: false },
            { id: 'perfect', name: 'Perfeccionista', desc: '5/5 correctas', icon: 'üíØ', unlocked: false },
            { id: 'speed', name: 'Rayo', desc: 'Responde en <5s', icon: '‚ö°', unlocked: false },
            { id: 'explorer', name: 'Explorador', desc: '5 pa√≠ses', icon: 'üß≠', unlocked: false },
            { id: 'traveler', name: 'Viajero', desc: '10 pa√≠ses', icon: 'üåç', unlocked: false },
            { id: 'grammar', name: 'Gram√°tico', desc: '20 gram√°tica', icon: 'üìù', unlocked: false },
            { id: 'culture', name: 'Cultural', desc: '10 cultura', icon: 'üé≠', unlocked: false },
            { id: 'vocab', name: 'Vocabulario', desc: '20 vocabulario', icon: 'üìö', unlocked: false }
        ];

        // ==================== GAME STATE ====================
        const levels = [
            { name: 'üå± Novato', xp: 0 }, { name: 'üìö Aprendiz', xp: 100 }, { name: '‚úèÔ∏è Estudiante', xp: 250 },
            { name: 'üìñ Lector', xp: 500 }, { name: 'üéØ Practicante', xp: 800 }, { name: '‚≠ê Competente', xp: 1200 },
            { name: 'üí´ Avanzado', xp: 1700 }, { name: 'üî• Experto', xp: 2300 }, { name: 'üëë Maestro', xp: 3000 },
            { name: 'üèÜ Leyenda', xp: 4000 }
        ];
        
        const storyChapters = [
            { title: "El Viaje Comienza", scenes: [
                { char: "üë®‚Äçüè´", name: "Profesor Garc√≠a", text: "¬°Bienvenido! Soy el Profesor Garc√≠a. Tu misi√≥n es viajar por el mundo hispanohablante.", narrative: "El sol brilla sobre la academia..." },
                { char: "ü¶ú", name: "Paco", text: "¬°Hola! Soy Paco, tu gu√≠a. ¬°Vamos a aprender espa√±ol juntos!", narrative: "Un colorido loro aparece volando..." },
                { quiz: true, q: { question: "¬øC√≥mo se dice 'hello'?", answers: ["Hola", "Adi√≥s", "Gracias", "Por favor"], correct: 0, explanation: "'Hola' es el saludo b√°sico." } },
                { char: "üë®‚Äçüè´", name: "Profesor Garc√≠a", text: "¬°Excelente! Ahora est√°s listo para tu primera aventura.", narrative: "El profesor te entrega un mapa..." }
            ]},
            { title: "Aventura en Espa√±a", scenes: [
                { char: "üíÉ", name: "Mar√≠a", text: "¬°Hola! Bienvenido a Espa√±a. ¬øTe gusta el flamenco?", narrative: "Llegas a Sevilla, ciudad del flamenco..." },
                { quiz: true, q: { question: "La capital de Espa√±a es:", answers: ["Madrid", "Barcelona", "Sevilla", "Valencia"], correct: 0, explanation: "Madrid es la capital de Espa√±a." } },
                { char: "üç≥", name: "Chef Antonio", text: "¬øQuieres probar una paella?", narrative: "El aroma de paella llena el aire..." },
                { quiz: true, q: { question: "'La paella est√° muy ___'", answers: ["rica", "rico", "ricas", "ricos"], correct: 0, explanation: "'Rica' concuerda con 'paella' (femenino)." } }
            ]}
        ];

        let gameState = {
            playerName: '', avatar: 'ü¶ä', difficulty: 'A2', totalScore: 0, totalStars: 0, xp: 0, level: 1,
            completedCountries: {}, selectedCategory: 'all', soundEnabled: true, musicEnabled: false, theme: 'dark',
            achievements: JSON.parse(JSON.stringify(achievements)),
            categoryStats: { gramatica: 0, vocabulario: 0, cultura: 0 },
            customQuestions: [],
            // Quiz state
            currentCountry: null, currentQuestions: [], currentQuestionIndex: 0,
            correctAnswers: 0, wrongAnswers: [], currentQuizScore: 0, hintsRemaining: 2,
            timer: 30, timerInterval: null, answerStartTime: null,
            // Classroom state
            isTeacher: false, isStudent: false, classroomId: null, studentId: null,
            classQuestions: [], classQuestionIndex: 0, liveTimer: null,
            // Story state
            storyChapter: 0, storyScene: 0,
            // Battle state
            battleId: null, isBattleHost: false, battleQuestions: [], battleQuestionIndex: 0, battleScore: 0
        };

        // ==================== INITIALIZATION ====================
        function init() {
            initFirebase();
            loadGameState();
            createStars();
            updateStats();
            updateXPDisplay();
            generateCountryButtons();
            
            document.body.dataset.theme = gameState.theme;
            document.getElementById('themeToggle').textContent = gameState.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('soundToggle').textContent = gameState.soundEnabled ? 'üîä' : 'üîá';
            if (gameState.playerName) document.getElementById('playerName').value = gameState.playerName;
            selectAvatar(gameState.avatar);
            
            document.querySelectorAll('.difficulty-btn').forEach(b => 
                b.classList.toggle('selected', b.dataset.level === gameState.difficulty));
            
            // Check URL for join codes
            const params = new URLSearchParams(window.location.search);
            if (params.get('join')) { document.getElementById('classCodeInput').value = params.get('join'); showJoinClass(); }
            if (params.get('battle')) { document.getElementById('battleCodeInput').value = params.get('battle'); showBattleSetup(); showJoinBattle(); }
        }

        function createStars() {
            const c = document.getElementById('stars'); c.innerHTML = '';
            for (let i = 0; i < 60; i++) {
                const s = document.createElement('div'); s.className = 'star';
                s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;animation-delay:${Math.random()*3}s`;
                c.appendChild(s);
            }
        }

        function saveGameState() {
            localStorage.setItem('spanishQuestSave', JSON.stringify({
                playerName: gameState.playerName, avatar: gameState.avatar, difficulty: gameState.difficulty,
                totalScore: gameState.totalScore, totalStars: gameState.totalStars, xp: gameState.xp, level: gameState.level,
                completedCountries: gameState.completedCountries, soundEnabled: gameState.soundEnabled, musicEnabled: gameState.musicEnabled,
                theme: gameState.theme, achievements: gameState.achievements, categoryStats: gameState.categoryStats,
                customQuestions: gameState.customQuestions, storyChapter: gameState.storyChapter
            }));
        }

        function loadGameState() {
            const saved = localStorage.getItem('spanishQuestSave');
            if (saved) Object.assign(gameState, JSON.parse(saved));
        }
        
        // ==================== AVATAR ====================
        function selectAvatar(avatar) {
            playSound('click');
            gameState.avatar = avatar;
            document.querySelectorAll('#avatarGrid .avatar-option').forEach(o => o.classList.toggle('selected', o.dataset.avatar === avatar));
            saveGameState();
        }
        
        // ==================== XP & LEVELS ====================
        function addXP(amount) {
            const oldLevel = gameState.level;
            gameState.xp += amount;
            for (let i = levels.length - 1; i >= 0; i--) {
                if (gameState.xp >= levels[i].xp) { gameState.level = i + 1; break; }
            }
            updateXPDisplay();
            saveGameState();
            if (gameState.level > oldLevel) {
                playSound('correct'); playSound('correct');
                alert('¬°Subiste a nivel ' + gameState.level + ': ' + levels[gameState.level - 1].name + '!');
            }
        }
        
        function updateXPDisplay() {
            const curr = levels[gameState.level - 1] || levels[0];
            const next = levels[gameState.level] || levels[levels.length - 1];
            const progress = ((gameState.xp - curr.xp) / (next.xp - curr.xp)) * 100;
            document.getElementById('xpRank').textContent = curr.name;
            document.getElementById('xpText').textContent = `${gameState.xp} / ${next.xp} XP`;
            document.getElementById('xpFill').style.width = Math.min(progress, 100) + '%';
        }

        // ==================== AUDIO ====================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null, masterVolume = 0.5, musicInterval = null;
        
        function setVolume(v) { masterVolume = v / 100; }
        
        function playSound(type) {
            if (!gameState.soundEnabled) return;
            if (!audioCtx) audioCtx = new AudioContext();
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const vol = 0.3 * masterVolume;
            const sounds = {
                correct: () => { osc.frequency.setValueAtTime(523, audioCtx.currentTime); osc.frequency.setValueAtTime(659, audioCtx.currentTime+0.1); gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.3); osc.start(); osc.stop(audioCtx.currentTime+0.3); },
                wrong: () => { osc.frequency.setValueAtTime(200, audioCtx.currentTime); gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.2); osc.start(); osc.stop(audioCtx.currentTime+0.2); },
                tick: () => { osc.frequency.setValueAtTime(800, audioCtx.currentTime); gain.gain.setValueAtTime(0.1*masterVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.05); osc.start(); osc.stop(audioCtx.currentTime+0.05); },
                click: () => { osc.frequency.setValueAtTime(600, audioCtx.currentTime); gain.gain.setValueAtTime(0.15*masterVolume, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.08); osc.start(); osc.stop(audioCtx.currentTime+0.08); },
                victory: () => { [392, 523, 659, 784].forEach((f, i) => { const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; g.gain.setValueAtTime(0.2*masterVolume, audioCtx.currentTime + i*0.12); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i*0.12 + 0.4); o.start(audioCtx.currentTime + i*0.12); o.stop(audioCtx.currentTime + i*0.12 + 0.4); }); }
            };
            if (sounds[type]) sounds[type]();
        }
        
        function toggleMusic() {
            gameState.musicEnabled = !gameState.musicEnabled;
            document.getElementById('musicToggle').classList.toggle('playing', gameState.musicEnabled);
            if (gameState.musicEnabled) {
                if (!audioCtx) audioCtx = new AudioContext();
                const melody = [330, 392, 440, 392, 330, 294, 330, 392];
                let i = 0;
                musicInterval = setInterval(() => {
                    if (!gameState.musicEnabled) return;
                    const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.frequency.value = melody[i++ % melody.length];
                    gain.gain.setValueAtTime(0.08 * masterVolume, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.3);
                }, 400);
            } else if (musicInterval) { clearInterval(musicInterval); musicInterval = null; }
            saveGameState();
        }

        // ==================== NAVIGATION ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function goHome() {
            playSound('click');
            if (gameState.classroomId && gameState.isTeacher) endClassroom();
            if (gameState.classroomId && gameState.isStudent) leaveClassroom();
            showScreen('welcomeScreen');
        }

        function selectDifficulty(level) {
            playSound('click');
            gameState.difficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.toggle('selected', b.dataset.level === level));
        }

        function toggleTheme() {
            playSound('click');
            gameState.theme = gameState.theme === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = gameState.theme;
            document.getElementById('themeToggle').textContent = gameState.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            saveGameState();
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('soundToggle').textContent = gameState.soundEnabled ? 'üîä' : 'üîá';
            if (gameState.soundEnabled) playSound('click');
            saveGameState();
        }

        function updateStats() {
            document.getElementById('totalScore').textContent = gameState.totalScore;
            document.getElementById('totalStars').textContent = gameState.totalStars;
        }

        function createConfetti() {
            const c = document.getElementById('confettiContainer'), colors = ['#FF6B35','#F7C948','#2ECC71','#9B59B6','#3498DB'];
            for (let i = 0; i < 50; i++) {
                const p = document.createElement('div'); p.className = 'confetti';
                p.style.cssText = `left:${Math.random()*100}%;background:${colors[Math.floor(Math.random()*colors.length)]};animation-delay:${Math.random()*0.5}s`;
                c.appendChild(p); setTimeout(() => p.remove(), 3000);
            }
        }

        // ==================== MASCOT ====================
        const mascotPhrases = { wave: ['¬°Hola!','¬øListo?'], happy: ['¬°Excelente!','¬°Muy bien!'], sad: ['¬°√Ånimo!','Sigue as√≠'], thinking: ['Hmm...'] };
        function updateMascot(state, msg = null) {
            const m = document.getElementById('mascot'), s = document.getElementById('mascotSpeech');
            m.className = 'mascot ' + state;
            s.textContent = msg || mascotPhrases[state][Math.floor(Math.random()*mascotPhrases[state].length)];
            s.classList.add('show'); setTimeout(() => s.classList.remove('show'), 2500);
        }
        function mascotSpeak() { updateMascot('wave'); }

        // ==================== SOLO GAME ====================
        function startGame() {
            playSound('click');
            gameState.playerName = document.getElementById('playerName').value.trim() || 'Jugador';
            saveGameState();
            showScreen('mapScreen');
            generateCountryButtons();
            updateMascot('wave', '¬°Elige un pa√≠s!');
        }

        function filterCategory(cat) {
            playSound('click');
            gameState.selectedCategory = cat;
            document.querySelectorAll('.category-btn').forEach(b => b.classList.toggle('selected', b.dataset.category === cat));
        }

        function generateCountryButtons() {
            const m = document.getElementById('worldMap'); m.innerHTML = '';
            countries.forEach(c => {
                const b = document.createElement('button'); b.className = `country-btn ${c.class}`;
                const d = gameState.completedCountries[c.id];
                if (d) { b.classList.add('completed'); if (d.stars === 3) b.classList.add('perfect'); }
                b.innerHTML = `<div class="country-content"><span class="country-flag">${c.flag}</span><span class="country-name">${c.name}</span><span class="country-stars">${d ? '‚≠ê'.repeat(d.stars) : ''}</span></div>`;
                b.onclick = () => startQuiz(c);
                m.appendChild(b);
            });
        }

        function shuffleArray(a) { const s=[...a]; for(let i=s.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[s[i],s[j]]=[s[j],s[i]];} return s; }

        function getRandomQuestions(difficulty, category, count = 5) {
            let pool = questionBank[difficulty] || questionBank.A2;
            if (category && category !== 'all') pool = pool.filter(q => q.category === category);
            return shuffleArray(pool).slice(0, count).map(q => {
                const corr = q.answers[q.correct], shuf = shuffleArray([...q.answers]);
                return { ...q, answers: shuf, correct: shuf.indexOf(corr) };
            });
        }

        function startQuiz(country) {
            playSound('click');
            gameState.currentCountry = country;
            gameState.currentQuestions = getRandomQuestions(gameState.difficulty, gameState.selectedCategory, 5);
            gameState.currentQuestionIndex = 0;
            gameState.correctAnswers = 0;
            gameState.wrongAnswers = [];
            gameState.currentQuizScore = 0;
            gameState.hintsRemaining = 2;

            document.getElementById('countryFlag').textContent = country.flag;
            document.getElementById('countryName').textContent = country.name;
            document.getElementById('countryCapital').textContent = `Capital: ${country.capital}`;
            document.getElementById('countryPopulation').textContent = `Poblaci√≥n: ${country.population}`;
            document.getElementById('countryFunFact').innerHTML = `<strong>¬øSab√≠as que...?</strong> ${country.funFact}`;
            document.getElementById('quizContent').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
            document.getElementById('explanationBox').classList.remove('show');
            document.getElementById('hintsRemaining').textContent = '2';
            document.getElementById('hintBtn').disabled = false;
            document.getElementById('quizModal').classList.add('active');
            
            updateMascot('thinking', '¬°Vamos!');
            loadQuestion();
        }

        function loadQuestion() {
            const q = gameState.currentQuestions[gameState.currentQuestionIndex];
            document.getElementById('progressFill').style.width = (gameState.currentQuestionIndex / gameState.currentQuestions.length) * 100 + '%';
            document.getElementById('questionCounter').textContent = `Pregunta ${gameState.currentQuestionIndex + 1} de ${gameState.currentQuestions.length}`;
            document.getElementById('questionCategory').textContent = { gramatica: 'Gram√°tica', vocabulario: 'Vocabulario', cultura: 'Cultura' }[q.category] || q.category;
            document.getElementById('questionText').textContent = q.question;
            
            const g = document.getElementById('answersGrid'); g.innerHTML = '';
            q.answers.forEach((a, i) => {
                const b = document.createElement('button'); b.className = 'answer-btn'; b.textContent = a;
                b.onclick = () => selectAnswer(i); g.appendChild(b);
            });
            
            document.getElementById('explanationBox').classList.remove('show');
            document.getElementById('scoreDisplay').textContent = gameState.currentQuizScore;
            gameState.answerStartTime = Date.now();
            startTimer();
        }

        function startTimer() {
            gameState.timer = 30;
            document.getElementById('timerDisplay').textContent = gameState.timer;
            document.getElementById('timerDisplay').classList.remove('timer-warning');
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            gameState.timerInterval = setInterval(() => {
                gameState.timer--;
                document.getElementById('timerDisplay').textContent = gameState.timer;
                if (gameState.timer <= 10) document.getElementById('timerDisplay').classList.add('timer-warning');
                if (gameState.timer <= 5) playSound('tick');
                if (gameState.timer <= 0) { clearInterval(gameState.timerInterval); timeUp(); }
            }, 1000);
        }

        function timeUp() {
            const q = gameState.currentQuestions[gameState.currentQuestionIndex];
            document.querySelectorAll('.answer-btn').forEach((b, i) => { b.disabled = true; if (i === q.correct) b.classList.add('correct'); });
            gameState.wrongAnswers.push({ question: q.question, yourAnswer: 'Sin respuesta', correctAnswer: q.answers[q.correct], explanation: q.explanation });
            playSound('wrong'); updateMascot('sad');
            document.getElementById('explanationText').textContent = q.explanation;
            document.getElementById('explanationBox').classList.add('show');
            setTimeout(nextQuestion, 3000);
        }

        function selectAnswer(idx) {
            clearInterval(gameState.timerInterval);
            const q = gameState.currentQuestions[gameState.currentQuestionIndex];
            const btns = document.querySelectorAll('.answer-btn');
            const answerTime = (Date.now() - gameState.answerStartTime) / 1000;
            
            btns.forEach((b, i) => { b.disabled = true; if (i === q.correct) b.classList.add('correct'); });
            
            if (idx === q.correct) {
                gameState.correctAnswers++;
                gameState.categoryStats[q.category]++;
                gameState.currentQuizScore += 100 + Math.floor(gameState.timer * 2);
                btns[idx].classList.add('correct');
                playSound('correct'); updateMascot('happy');
                if (answerTime < 5) checkAchievement('speed');
            } else {
                btns[idx].classList.add('incorrect');
                playSound('wrong'); updateMascot('sad');
                gameState.wrongAnswers.push({ question: q.question, yourAnswer: q.answers[idx], correctAnswer: q.answers[q.correct], explanation: q.explanation });
            }
            
            document.getElementById('explanationText').textContent = q.explanation;
            document.getElementById('explanationBox').classList.add('show');
            document.getElementById('scoreDisplay').textContent = gameState.currentQuizScore;
            setTimeout(nextQuestion, 3000);
        }

        function useHint() {
            if (gameState.hintsRemaining <= 0) return;
            playSound('click');
            gameState.hintsRemaining--;
            document.getElementById('hintsRemaining').textContent = gameState.hintsRemaining;
            if (gameState.hintsRemaining <= 0) document.getElementById('hintBtn').disabled = true;
            
            const q = gameState.currentQuestions[gameState.currentQuestionIndex];
            const btns = document.querySelectorAll('.answer-btn');
            const wrong = []; q.answers.forEach((_, i) => { if (i !== q.correct) wrong.push(i); });
            shuffleArray(wrong).slice(0, 2).forEach(i => btns[i].classList.add('eliminated'));
        }

        function nextQuestion() {
            gameState.currentQuestionIndex++;
            if (gameState.currentQuestionIndex < gameState.currentQuestions.length) loadQuestion();
            else showResults();
        }

        function showResults() {
            document.getElementById('quizContent').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'block';
            
            const score = gameState.correctAnswers, total = gameState.currentQuestions.length;
            const pct = (score / total) * 100;
            let stars = pct >= 100 ? 3 : pct >= 80 ? 2 : pct >= 60 ? 1 : 0;
            
            const [icon, title] = pct >= 80 ? ['üéâ', '¬°Excelente!'] : pct >= 60 ? ['üòä', '¬°Muy bien!'] : pct >= 40 ? ['üí™', '¬°Sigue as√≠!'] : ['üìö', '¬°Practica m√°s!'];
            if (pct >= 80) createConfetti();
            
            document.getElementById('resultsIcon').textContent = icon;
            document.getElementById('resultsTitle').textContent = title;
            document.getElementById('resultsScore').innerHTML = `<span>${score}</span> de <span>${total}</span> correctas<br><small>${gameState.currentQuizScore} puntos</small>`;
            
            const starsC = document.getElementById('starsEarned'); starsC.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const sp = document.createElement('span');
                sp.className = 'star-icon' + (i < stars ? ' earned' : '');
                sp.textContent = '‚≠ê';
                starsC.appendChild(sp);
            }
            
            if (pct >= 60) {
                const cid = gameState.currentCountry.id;
                const existing = gameState.completedCountries[cid];
                if (!existing || stars > existing.stars) {
                    gameState.completedCountries[cid] = { stars, score: gameState.currentQuizScore };
                    gameState.totalStars += existing ? stars - existing.stars : stars;
                    gameState.totalScore += existing ? gameState.currentQuizScore - existing.score : gameState.currentQuizScore;
                    checkAchievement('first');
                    if (pct === 100) checkAchievement('perfect');
                    if (Object.keys(gameState.completedCountries).length >= 5) checkAchievement('explorer');
                    if (Object.keys(gameState.completedCountries).length >= 10) checkAchievement('traveler');
                    updateStats(); saveGameState(); generateCountryButtons();
                }
            }
            
            const rev = document.getElementById('reviewSection'), revList = document.getElementById('reviewList');
            if (gameState.wrongAnswers.length > 0) {
                rev.style.display = 'block';
                revList.innerHTML = gameState.wrongAnswers.map(w => `<div class="review-item"><div class="review-question">${w.question}</div><div class="review-answer"><span class="wrong">${w.yourAnswer}</span> ‚Üí <span class="correct">${w.correctAnswer}</span></div><div class="review-explanation">üí° ${w.explanation}</div></div>`).join('');
            } else rev.style.display = 'none';
        }

        function retryQuiz() { playSound('click'); startQuiz(gameState.currentCountry); }
        function closeQuiz() { playSound('click'); clearInterval(gameState.timerInterval); document.getElementById('quizModal').classList.remove('active'); }

        // ==================== ACHIEVEMENTS & LEADERBOARD ====================
        function checkAchievement(id) {
            const a = gameState.achievements.find(x => x.id === id);
            if (a && !a.unlocked) { a.unlocked = true; saveGameState(); }
        }

        function showAchievements() {
            playSound('click');
            const unlocked = gameState.achievements.filter(a => a.unlocked).length;
            document.getElementById('achievementProgress').textContent = `${unlocked} de ${gameState.achievements.length}`;
            document.getElementById('achievementsGrid').innerHTML = gameState.achievements.map(a => `<div class="achievement-card ${a.unlocked ? 'unlocked' : 'locked'}"><div class="achievement-card-icon">${a.icon}</div><div class="achievement-card-name">${a.name}</div><div class="achievement-card-desc">${a.desc}</div></div>`).join('');
            document.getElementById('achievementsModal').classList.add('active');
        }
        function closeAchievements() { document.getElementById('achievementsModal').classList.remove('active'); }

        function showLeaderboard() {
            playSound('click');
            const lb = JSON.parse(localStorage.getItem('spanishQuestLeaderboard') || '[]');
            document.getElementById('leaderboardList').innerHTML = lb.length === 0 ? '<li class="leaderboard-item" style="justify-content:center;opacity:0.6;">¬°S√© el primero!</li>' : lb.slice(0, 10).map((p, i) => `<li class="leaderboard-item ${p.name === gameState.playerName ? 'current-player' : ''}"><span class="leaderboard-rank ${['gold', 'silver', 'bronze'][i] || ''}">${i + 1}</span><div class="leaderboard-info"><div class="leaderboard-name">${p.name}</div><div class="leaderboard-stats">‚≠ê${p.stars}</div></div><span class="leaderboard-score">${p.score}</span></li>`).join('');
            document.getElementById('leaderboardModal').classList.add('active');
        }
        function closeLeaderboard() { document.getElementById('leaderboardModal').classList.remove('active'); }

        // ==================== FLASHCARDS ====================
        function showFlashcards() {
            playSound('click');
            showScreen('flashcardScreen');
            gameState.flashcardIndex = 0;
            updateFlashcard();
        }

        function updateFlashcard() {
            const f = flashcards[gameState.flashcardIndex];
            document.getElementById('flashcardFront').textContent = f.front;
            document.getElementById('flashcardHint').textContent = f.category;
            document.getElementById('flashcardBack').textContent = f.back;
            document.getElementById('flashcardProgress').textContent = `${gameState.flashcardIndex + 1} / ${flashcards.length}`;
            document.getElementById('flashcard').classList.remove('flipped');
        }

        function flipFlashcard() { playSound('click'); document.getElementById('flashcard').classList.toggle('flipped'); }
        function nextFlashcard() { playSound('click'); gameState.flashcardIndex = (gameState.flashcardIndex + 1) % flashcards.length; updateFlashcard(); }
        function prevFlashcard() { playSound('click'); gameState.flashcardIndex = (gameState.flashcardIndex - 1 + flashcards.length) % flashcards.length; updateFlashcard(); }

        // ==================== üî• FIREBASE CLASSROOM MODE ====================
        
        // Teacher Functions
        function showTeacherSetup() {
            playSound('click');
            document.getElementById('teacherName').value = gameState.playerName || '';
            showScreen('teacherSetupScreen');
        }

        function createClassroom() {
            playSound('click');
            
            if (!firebaseInitialized) {
                alert('Firebase no est√° configurado. Por favor, a√±ade tu configuraci√≥n de Firebase.');
                return;
            }
            
            const teacherName = document.getElementById('teacherName').value.trim() || 'Profesor';
            const difficulty = document.getElementById('teacherDifficulty').value;
            const countryId = document.getElementById('teacherCountry').value;
            const questionCount = parseInt(document.getElementById('teacherQuestionCount').value);
            
            // Generate PIN
            const pin = Math.floor(1000 + Math.random() * 9000).toString();
            
            // Get questions
            const questions = getRandomQuestions(difficulty, 'all', questionCount);
            
            // Get country info
            let country = countryId === 'random' ? countries[Math.floor(Math.random() * countries.length)] : countries.find(c => c.id === countryId);
            
            gameState.classroomId = pin;
            gameState.isTeacher = true;
            gameState.classQuestions = questions;
            gameState.classQuestionIndex = -1; // Not started
            
            // Create classroom in Firebase
            db.ref(`classrooms/${pin}`).set({
                teacher: teacherName,
                difficulty: difficulty,
                country: country,
                questionCount: questionCount,
                questions: questions,
                currentQuestion: -1,
                status: 'waiting', // waiting, playing, finished
                created: Date.now(),
                students: {}
            });
            
            // Show lobby
            document.getElementById('classPin').textContent = pin;
            showScreen('teacherLobbyScreen');
            
            // Generate QR Code
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            const gameUrl = window.location.href.split('?')[0] + '?join=' + pin;
            new QRCode(qrDiv, { text: gameUrl, width: 150, height: 150 });
            
            // Listen for students
            db.ref(`classrooms/${pin}/students`).on('value', (snapshot) => {
                const students = snapshot.val() || {};
                updateStudentsList(students);
            });
            
            updateMascot('wave', '¬°Clase creada!');
        }

        function updateStudentsList(students) {
            const grid = document.getElementById('studentsGrid');
            const studentArr = Object.entries(students);
            document.getElementById('studentCount').textContent = studentArr.length;
            document.getElementById('startClassBtn').disabled = studentArr.length === 0;
            
            if (studentArr.length === 0) {
                grid.innerHTML = '<div class="no-students">Esperando estudiantes...</div>';
            } else {
                grid.innerHTML = studentArr.map(([id, s]) => `
                    <div class="student-card">
                        <span class="student-name">${s.name}</span>
                        <span class="student-status ${s.status}">${s.status === 'waiting' ? '‚è≥' : s.status === 'playing' ? 'üéÆ' : '‚úÖ'}</span>
                        <span class="student-score">${s.score || 0}</span>
                    </div>
                `).join('');
            }
        }

        function startClassQuiz() {
            playSound('click');
            gameState.classQuestionIndex = 0;
            
            // Update Firebase
            db.ref(`classrooms/${gameState.classroomId}`).update({
                status: 'playing',
                currentQuestion: 0,
                questionStartTime: Date.now()
            });
            
            showScreen('teacherQuizScreen');
            showLiveQuestion();
            
            // Listen for answers
            db.ref(`classrooms/${gameState.classroomId}/students`).on('value', (snapshot) => {
                if (gameState.isTeacher) updateResponsesDisplay(snapshot.val() || {});
            });
        }

        function showLiveQuestion() {
            const q = gameState.classQuestions[gameState.classQuestionIndex];
            const total = gameState.classQuestions.length;
            
            document.getElementById('liveQuestionNumber').textContent = `Pregunta ${gameState.classQuestionIndex + 1} de ${total}`;
            document.getElementById('liveQuestionText').textContent = q.question;
            document.getElementById('liveAnswerA').textContent = q.answers[0];
            document.getElementById('liveAnswerB').textContent = q.answers[1];
            document.getElementById('liveAnswerC').textContent = q.answers[2];
            document.getElementById('liveAnswerD').textContent = q.answers[3];
            
            // Reset answer highlights
            document.querySelectorAll('.live-answer').forEach(a => a.classList.remove('correct'));
            
            // Hide buttons
            document.getElementById('showResultsBtn').style.display = 'none';
            document.getElementById('nextQuestionBtn').style.display = 'none';
            document.getElementById('showFinalBtn').style.display = 'none';
            
            // Start timer
            startLiveTimer();
        }

        function startLiveTimer() {
            let time = 30;
            const timerEl = document.getElementById('liveTimer');
            timerEl.textContent = time;
            timerEl.classList.remove('warning');
            
            if (gameState.liveTimer) clearInterval(gameState.liveTimer);
            
            gameState.liveTimer = setInterval(() => {
                time--;
                timerEl.textContent = time;
                if (time <= 10) timerEl.classList.add('warning');
                if (time <= 0) {
                    clearInterval(gameState.liveTimer);
                    document.getElementById('showResultsBtn').style.display = 'inline-flex';
                }
            }, 1000);
        }

        function updateResponsesDisplay(students) {
            const studentArr = Object.values(students);
            const total = studentArr.length;
            const currentQ = gameState.classQuestionIndex;
            
            let responses = [0, 0, 0, 0];
            let answered = 0;
            
            studentArr.forEach(s => {
                if (s.answers && s.answers[currentQ] !== undefined) {
                    answered++;
                    responses[s.answers[currentQ]]++;
                }
            });
            
            document.getElementById('responseCount').textContent = answered;
            document.getElementById('totalStudents').textContent = total;
            
            // Update bar
            const bar = document.getElementById('responsesBar');
            if (answered > 0) {
                const colors = ['#E74C3C', '#3498DB', '#F7C948', '#2ECC71'];
                bar.innerHTML = responses.map((r, i) => r > 0 ? `<div class="response-segment" style="width:${(r/answered)*100}%;background:${colors[i]}">${r}</div>` : '').join('');
            } else {
                bar.innerHTML = '';
            }
            
            // Auto-show results if all answered
            if (answered === total && total > 0) {
                clearInterval(gameState.liveTimer);
                document.getElementById('showResultsBtn').style.display = 'inline-flex';
            }
        }

        function showQuestionResults() {
            playSound('click');
            document.getElementById('showResultsBtn').style.display = 'none';
            
            const q = gameState.classQuestions[gameState.classQuestionIndex];
            const correctIdx = q.correct;
            
            // Highlight correct answer
            const letters = ['a', 'b', 'c', 'd'];
            document.getElementById(`liveAnswer${letters[correctIdx].toUpperCase()}`).classList.add('correct');
            
            // Show next button
            if (gameState.classQuestionIndex < gameState.classQuestions.length - 1) {
                document.getElementById('nextQuestionBtn').style.display = 'inline-flex';
            } else {
                document.getElementById('showFinalBtn').style.display = 'inline-flex';
            }
            
            // Update Firebase with results
            db.ref(`classrooms/${gameState.classroomId}`).update({
                showingResults: gameState.classQuestionIndex
            });
        }

        function nextLiveQuestion() {
            playSound('click');
            gameState.classQuestionIndex++;
            
            db.ref(`classrooms/${gameState.classroomId}`).update({
                currentQuestion: gameState.classQuestionIndex,
                questionStartTime: Date.now(),
                showingResults: -1
            });
            
            showLiveQuestion();
        }

        function showFinalLeaderboard() {
            playSound('click');
            clearInterval(gameState.liveTimer);
            
            db.ref(`classrooms/${gameState.classroomId}`).update({ status: 'finished' });
            
            // Get final scores
            db.ref(`classrooms/${gameState.classroomId}/students`).once('value', (snapshot) => {
                const students = snapshot.val() || {};
                const sorted = Object.entries(students)
                    .map(([id, s]) => ({ name: s.name, score: s.score || 0 }))
                    .sort((a, b) => b.score - a.score);
                
                // Show podium
                const podium = document.getElementById('podium');
                const podiumHTML = [];
                if (sorted[1]) podiumHTML.push(`<div class="podium-place second"><div class="podium-name">${sorted[1].name}</div><div class="podium-block">2</div><div class="podium-score">${sorted[1].score}</div></div>`);
                if (sorted[0]) podiumHTML.push(`<div class="podium-place first"><div class="podium-name">${sorted[0].name}</div><div class="podium-block">1</div><div class="podium-score">${sorted[0].score}</div></div>`);
                if (sorted[2]) podiumHTML.push(`<div class="podium-place third"><div class="podium-name">${sorted[2].name}</div><div class="podium-block">3</div><div class="podium-score">${sorted[2].score}</div></div>`);
                podium.innerHTML = podiumHTML.join('');
                
                // Show full list
                document.getElementById('finalLeaderboard').innerHTML = sorted.slice(3).map((s, i) => `<div class="student-card"><span>${i + 4}.</span><span class="student-name">${s.name}</span><span class="student-score">${s.score}</span></div>`).join('');
                
                showScreen('teacherFinalScreen');
                createConfetti();
            });
        }

        function restartClass() {
            playSound('click');
            // Reset questions
            gameState.classQuestions = getRandomQuestions(
                document.getElementById('teacherDifficulty').value,
                'all',
                parseInt(document.getElementById('teacherQuestionCount').value)
            );
            gameState.classQuestionIndex = -1;
            
            // Reset students
            db.ref(`classrooms/${gameState.classroomId}/students`).once('value', (snapshot) => {
                const students = snapshot.val() || {};
                Object.keys(students).forEach(id => {
                    db.ref(`classrooms/${gameState.classroomId}/students/${id}`).update({
                        score: 0,
                        answers: {},
                        status: 'waiting'
                    });
                });
            });
            
            // Update classroom
            db.ref(`classrooms/${gameState.classroomId}`).update({
                questions: gameState.classQuestions,
                currentQuestion: -1,
                status: 'waiting',
                showingResults: -1
            });
            
            showScreen('teacherLobbyScreen');
        }

        function endClassroom() {
            playSound('click');
            if (gameState.classroomId) {
                db.ref(`classrooms/${gameState.classroomId}`).remove();
                db.ref(`classrooms/${gameState.classroomId}/students`).off();
            }
            clearInterval(gameState.liveTimer);
            gameState.isTeacher = false;
            gameState.classroomId = null;
            goHome();
        }

        // Student Functions
        function showJoinClass() {
            playSound('click');
            document.getElementById('studentName').value = gameState.playerName || '';
            document.getElementById('classCodeInput').value = '';
            document.getElementById('joinError').style.display = 'none';
            showScreen('joinClassScreen');
            
            // Check URL for join code
            const params = new URLSearchParams(window.location.search);
            if (params.get('join')) {
                document.getElementById('classCodeInput').value = params.get('join');
            }
        }

        function joinClassroom() {
            playSound('click');
            
            if (!firebaseInitialized) {
                alert('Firebase no est√° configurado.');
                return;
            }
            
            const name = document.getElementById('studentName').value.trim() || 'Estudiante';
            const pin = document.getElementById('classCodeInput').value.trim();
            
            if (!pin || pin.length !== 4) {
                document.getElementById('joinError').style.display = 'block';
                document.getElementById('joinError').textContent = 'Introduce un PIN de 4 d√≠gitos.';
                return;
            }
            
            // Check if classroom exists
            db.ref(`classrooms/${pin}`).once('value', (snapshot) => {
                const classroom = snapshot.val();
                
                if (!classroom) {
                    document.getElementById('joinError').style.display = 'block';
                    document.getElementById('joinError').textContent = 'Clase no encontrada. Verifica el PIN.';
                    return;
                }
                
                // Join classroom
                gameState.classroomId = pin;
                gameState.isStudent = true;
                gameState.playerName = name;
                gameState.studentId = db.ref(`classrooms/${pin}/students`).push().key;
                
                db.ref(`classrooms/${pin}/students/${gameState.studentId}`).set({
                    name: name,
                    score: 0,
                    answers: {},
                    status: 'waiting',
                    joined: Date.now()
                });
                
                // Show waiting room
                document.getElementById('teacherNameDisplay').textContent = classroom.teacher;
                document.getElementById('classLevel').textContent = classroom.difficulty;
                showScreen('studentWaitingScreen');
                
                // Listen for game start
                db.ref(`classrooms/${pin}`).on('value', (snap) => {
                    const data = snap.val();
                    if (!data) {
                        // Classroom was deleted
                        alert('La clase ha terminado.');
                        leaveClassroom();
                        return;
                    }
                    
                    if (data.status === 'playing' && gameState.isStudent) {
                        gameState.classQuestions = data.questions;
                        handleStudentQuestionChange(data);
                    }
                    
                    if (data.status === 'finished' && gameState.isStudent) {
                        showStudentFinalScore();
                    }
                });
                
                updateMascot('wave', '¬°Conectado!');
            });
        }

        function handleStudentQuestionChange(data) {
            const qIdx = data.currentQuestion;
            
            if (qIdx < 0) return;
            
            // Show quiz screen if not already
            if (!document.getElementById('studentQuizScreen').classList.contains('active')) {
                showScreen('studentQuizScreen');
            }
            
            // Check if showing results
            if (data.showingResults === qIdx) {
                showStudentFeedback(qIdx);
                return;
            }
            
            // Check if already answered this question
            db.ref(`classrooms/${gameState.classroomId}/students/${gameState.studentId}/answers/${qIdx}`).once('value', (snap) => {
                if (snap.val() !== null) {
                    // Already answered, show waiting
                    document.getElementById('studentAnswersGrid').innerHTML = '';
                    document.getElementById('studentFeedback').style.display = 'none';
                    document.getElementById('waitingNext').style.display = 'block';
                    return;
                }
                
                // Show question
                showStudentQuestion(qIdx, data.questionStartTime);
            });
        }

        function showStudentQuestion(qIdx, startTime) {
            const q = gameState.classQuestions[qIdx];
            
            document.getElementById('studentQuestionNumber').textContent = `Pregunta ${qIdx + 1} de ${gameState.classQuestions.length}`;
            document.getElementById('studentQuestionText').textContent = q.question;
            document.getElementById('studentFeedback').style.display = 'none';
            document.getElementById('waitingNext').style.display = 'none';
            
            const grid = document.getElementById('studentAnswersGrid');
            grid.innerHTML = '';
            q.answers.forEach((a, i) => {
                const b = document.createElement('button');
                b.className = 'answer-btn';
                b.textContent = a;
                b.onclick = () => submitStudentAnswer(qIdx, i);
                grid.appendChild(b);
            });
            
            // Calculate remaining time
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            let remaining = Math.max(0, 30 - elapsed);
            
            const timerEl = document.getElementById('studentTimer');
            timerEl.textContent = remaining;
            timerEl.classList.remove('warning');
            
            if (gameState.liveTimer) clearInterval(gameState.liveTimer);
            gameState.liveTimer = setInterval(() => {
                remaining--;
                timerEl.textContent = Math.max(0, remaining);
                if (remaining <= 10) timerEl.classList.add('warning');
                if (remaining <= 0) {
                    clearInterval(gameState.liveTimer);
                    // Time's up - submit no answer
                    document.getElementById('studentAnswersGrid').innerHTML = '<p style="color:var(--danger);text-align:center;">¬°Tiempo agotado!</p>';
                }
            }, 1000);
        }

        function submitStudentAnswer(qIdx, answerIdx) {
            playSound('click');
            clearInterval(gameState.liveTimer);
            
            const q = gameState.classQuestions[qIdx];
            const isCorrect = answerIdx === q.correct;
            const points = isCorrect ? 100 : 0;
            
            // Save answer to Firebase
            db.ref(`classrooms/${gameState.classroomId}/students/${gameState.studentId}`).transaction((student) => {
                if (student) {
                    student.answers = student.answers || {};
                    student.answers[qIdx] = answerIdx;
                    student.score = (student.score || 0) + points;
                    student.status = 'playing';
                }
                return student;
            });
            
            // Show waiting
            document.getElementById('studentAnswersGrid').innerHTML = '';
            document.getElementById('waitingNext').style.display = 'block';
            
            if (isCorrect) {
                playSound('correct');
                updateMascot('happy');
            } else {
                playSound('wrong');
                updateMascot('sad');
            }
        }

        function showStudentFeedback(qIdx) {
            clearInterval(gameState.liveTimer);
            
            const q = gameState.classQuestions[qIdx];
            document.getElementById('waitingNext').style.display = 'none';
            document.getElementById('studentAnswersGrid').innerHTML = '';
            
            // Get student's answer
            db.ref(`classrooms/${gameState.classroomId}/students/${gameState.studentId}/answers/${qIdx}`).once('value', (snap) => {
                const studentAnswer = snap.val();
                const isCorrect = studentAnswer === q.correct;
                
                document.getElementById('feedbackIcon').textContent = isCorrect ? '‚úÖ' : '‚ùå';
                document.getElementById('feedbackText').textContent = isCorrect ? '¬°Correcto!' : `Incorrecto. Era: ${q.answers[q.correct]}`;
                document.getElementById('feedbackExplanation').textContent = q.explanation;
                document.getElementById('studentFeedback').style.display = 'block';
            });
        }

        function showStudentFinalScore() {
            clearInterval(gameState.liveTimer);
            
            db.ref(`classrooms/${gameState.classroomId}/students/${gameState.studentId}`).once('value', (snap) => {
                const student = snap.val();
                const answers = student.answers || {};
                const correctCount = Object.entries(answers).filter(([idx, ans]) => ans === gameState.classQuestions[idx].correct).length;
                
                document.getElementById('studentFinalScore').textContent = student.score || 0;
                document.getElementById('studentCorrectCount').textContent = correctCount;
                document.getElementById('studentTotalCount').textContent = gameState.classQuestions.length;
                
                showScreen('studentFinalScreen');
                createConfetti();
            });
        }

        function leaveClassroom() {
            if (gameState.classroomId && gameState.studentId) {
                db.ref(`classrooms/${gameState.classroomId}/students/${gameState.studentId}`).remove();
                db.ref(`classrooms/${gameState.classroomId}`).off();
            }
            clearInterval(gameState.liveTimer);
            gameState.isStudent = false;
            gameState.classroomId = null;
            gameState.studentId = null;
            goHome();
        }

        // ==================== STORY MODE ====================
        function startStoryMode() {
            playSound('click');
            showScreen('storyScreen');
            loadStoryScene();
        }

        function loadStoryScene() {
            const chapter = storyChapters[gameState.storyChapter];
            if (!chapter) { gameState.storyChapter = 0; loadStoryScene(); return; }
            document.getElementById('storyChapter').textContent = `Cap√≠tulo ${gameState.storyChapter + 1}`;
            document.getElementById('storyTitle').textContent = chapter.title;
            
            const scene = chapter.scenes[gameState.storyScene];
            const quizBox = document.getElementById('storyQuizBox');
            const sceneDiv = document.getElementById('storyScene');
            
            if (scene.quiz) {
                sceneDiv.style.display = 'none';
                quizBox.style.display = 'block';
                document.getElementById('storyQuestion').textContent = scene.q.question;
                const ans = document.getElementById('storyAnswers'); ans.innerHTML = '';
                scene.q.answers.forEach((a, i) => {
                    const b = document.createElement('button'); b.className = 'answer-btn'; b.textContent = a;
                    b.onclick = () => selectStoryAnswer(i, scene.q);
                    ans.appendChild(b);
                });
                document.getElementById('storyContinue').style.display = 'none';
            } else {
                quizBox.style.display = 'none';
                sceneDiv.style.display = 'block';
                document.getElementById('storyCharAvatar').textContent = scene.char;
                document.getElementById('storyCharName').textContent = scene.name;
                document.getElementById('storyDialogue').textContent = scene.text;
                document.getElementById('storyNarrative').textContent = scene.narrative;
                document.getElementById('storyContinue').style.display = 'inline-flex';
            }
            
            const prog = document.getElementById('storyProgress'); prog.innerHTML = '';
            chapter.scenes.forEach((_, i) => {
                const d = document.createElement('div');
                d.className = 'story-dot' + (i < gameState.storyScene ? ' done' : i === gameState.storyScene ? ' active' : '');
                prog.appendChild(d);
            });
        }

        function selectStoryAnswer(idx, q) {
            const btns = document.querySelectorAll('#storyAnswers .answer-btn');
            btns.forEach((b, i) => { b.disabled = true; if (i === q.correct) b.classList.add('correct'); });
            if (idx === q.correct) { playSound('correct'); addXP(15); } else { btns[idx].classList.add('incorrect'); playSound('wrong'); }
            document.getElementById('storyContinue').style.display = 'inline-flex';
        }

        function continueStory() {
            playSound('click');
            const chapter = storyChapters[gameState.storyChapter];
            gameState.storyScene++;
            if (gameState.storyScene >= chapter.scenes.length) {
                gameState.storyChapter++;
                gameState.storyScene = 0;
                addXP(50);
                if (gameState.storyChapter >= storyChapters.length) {
                    alert('¬°Has completado la historia! M√°s cap√≠tulos pronto...');
                    goHome();
                    return;
                }
            }
            saveGameState();
            loadStoryScene();
        }

        // ==================== BATTLE MODE ====================
        function showBattleSetup() {
            playSound('click');
            showScreen('battleSetupScreen');
            document.getElementById('battleCodeBox').style.display = 'none';
            document.getElementById('joinBattleBox').style.display = 'none';
            document.getElementById('battlePlayersBox').style.display = 'none';
            document.getElementById('startBattleBtn').style.display = 'none';
        }
        
        function showJoinBattle() {
            playSound('click');
            document.getElementById('joinBattleBox').style.display = 'block';
            document.getElementById('battleCodeBox').style.display = 'none';
            document.getElementById('battleError').style.display = 'none';
        }

        function createBattle() {
            if (!firebaseInitialized) { alert('Firebase no configurado'); return; }
            playSound('click');
            gameState.playerName = document.getElementById('playerName').value.trim() || 'Jugador';
            const pin = Math.floor(1000 + Math.random() * 9000).toString();
            gameState.battleId = pin;
            gameState.isBattleHost = true;
            gameState.battleQuestions = getRandomQuestions(gameState.difficulty, 'all', 5);
            
            db.ref('battles/' + pin).set({
                host: gameState.playerName, hostAvatar: gameState.avatar,
                difficulty: gameState.difficulty, questions: gameState.battleQuestions,
                status: 'waiting', players: { host: { name: gameState.playerName, avatar: gameState.avatar, score: 0 } },
                currentQuestion: -1, created: Date.now()
            });
            
            document.getElementById('battleCode').textContent = pin;
            document.getElementById('battleCodeBox').style.display = 'block';
            document.getElementById('joinBattleBox').style.display = 'none';
            document.getElementById('battlePlayersBox').style.display = 'block';
            listenBattlePlayers(pin);
        }

        function joinBattle() {
            if (!firebaseInitialized) { alert('Firebase no configurado'); return; }
            playSound('click');
            const pin = document.getElementById('battleCodeInput').value.trim();
            if (pin.length !== 4) { document.getElementById('battleError').style.display = 'block'; return; }
            
            db.ref('battles/' + pin).once('value', snap => {
                if (!snap.exists() || snap.val().status !== 'waiting') {
                    document.getElementById('battleError').style.display = 'block';
                    return;
                }
                gameState.playerName = document.getElementById('playerName').value.trim() || 'Retador';
                gameState.battleId = pin;
                gameState.isBattleHost = false;
                
                db.ref('battles/' + pin + '/players/guest').set({ name: gameState.playerName, avatar: gameState.avatar, score: 0 });
                
                document.getElementById('joinBattleBox').style.display = 'none';
                document.getElementById('battlePlayersBox').style.display = 'block';
                listenBattlePlayers(pin);
                listenBattleStatus(pin);
            });
        }

        function listenBattlePlayers(pin) {
            db.ref('battles/' + pin + '/players').on('value', snap => {
                const players = snap.val() || {};
                const grid = document.getElementById('battlePlayersGrid');
                grid.innerHTML = Object.values(players).map(p => `<div class="student-card"><span style="font-size:1.5rem;">${p.avatar}</span><span class="student-name">${p.name}</span></div>`).join('');
                document.getElementById('battlePlayerCount').textContent = `${Object.keys(players).length}/2`;
                if (gameState.isBattleHost && Object.keys(players).length >= 2) {
                    document.getElementById('startBattleBtn').style.display = 'inline-flex';
                }
            });
        }

        function listenBattleStatus(pin) {
            db.ref('battles/' + pin).on('value', snap => {
                const data = snap.val();
                if (!data) return;
                if (data.status === 'playing' && data.currentQuestion >= 0) {
                    gameState.battleQuestions = data.questions;
                    gameState.battleQuestionIndex = data.currentQuestion;
                    showBattleQuestion();
                }
                if (data.status === 'finished') showBattleResults();
            });
        }

        function startBattleGame() {
            if (!gameState.isBattleHost) return;
            playSound('click');
            db.ref('battles/' + gameState.battleId).update({ status: 'playing', currentQuestion: 0, questionStartTime: Date.now() });
            gameState.battleQuestionIndex = 0;
            showBattleQuestion();
        }

        function showBattleQuestion() {
            showScreen('battleGameScreen');
            const q = gameState.battleQuestions[gameState.battleQuestionIndex];
            document.getElementById('battleQCounter').textContent = `Pregunta ${gameState.battleQuestionIndex + 1} de ${gameState.battleQuestions.length}`;
            document.getElementById('battleQText').textContent = q.question;
            document.getElementById('battleExplain').classList.remove('show');
            
            const g = document.getElementById('battleAnswersGrid'); g.innerHTML = '';
            q.answers.forEach((a, i) => {
                const b = document.createElement('button'); b.className = 'answer-btn'; b.textContent = a;
                b.onclick = () => submitBattleAnswer(i);
                g.appendChild(b);
            });
            
            db.ref('battles/' + gameState.battleId + '/players').on('value', snap => {
                const p = snap.val() || {};
                if (p.host) { document.getElementById('battleName1').textContent = p.host.name; document.getElementById('battleAvatar1').textContent = p.host.avatar; document.getElementById('battleScore1').textContent = p.host.score; }
                if (p.guest) { document.getElementById('battleName2').textContent = p.guest.name; document.getElementById('battleAvatar2').textContent = p.guest.avatar; document.getElementById('battleScore2').textContent = p.guest.score; }
            });
            
            let time = 15;
            document.getElementById('battleTimer').textContent = time;
            document.getElementById('battleTimer').classList.remove('urgent');
            if (gameState.liveTimer) clearInterval(gameState.liveTimer);
            gameState.liveTimer = setInterval(() => {
                time--;
                document.getElementById('battleTimer').textContent = time;
                if (time <= 5) document.getElementById('battleTimer').classList.add('urgent');
                if (time <= 0) { clearInterval(gameState.liveTimer); submitBattleAnswer(-1); }
            }, 1000);
        }

        function submitBattleAnswer(idx) {
            clearInterval(gameState.liveTimer);
            const q = gameState.battleQuestions[gameState.battleQuestionIndex];
            const btns = document.querySelectorAll('#battleAnswersGrid .answer-btn');
            const playerKey = gameState.isBattleHost ? 'host' : 'guest';
            
            btns.forEach((b, i) => { b.disabled = true; if (i === q.correct) b.classList.add('correct'); });
            
            if (idx === q.correct) {
                gameState.battleScore += 100;
                if (idx >= 0) btns[idx].classList.add('correct');
                playSound('correct');
                db.ref('battles/' + gameState.battleId + '/players/' + playerKey + '/score').transaction(s => (s || 0) + 100);
            } else {
                if (idx >= 0) btns[idx].classList.add('incorrect');
                playSound('wrong');
            }
            
            document.getElementById('battleExplainText').textContent = q.explanation;
            document.getElementById('battleExplain').classList.add('show');
            
            setTimeout(() => {
                if (gameState.isBattleHost) {
                    gameState.battleQuestionIndex++;
                    if (gameState.battleQuestionIndex < gameState.battleQuestions.length) {
                        db.ref('battles/' + gameState.battleId).update({ currentQuestion: gameState.battleQuestionIndex, questionStartTime: Date.now() });
                    } else {
                        db.ref('battles/' + gameState.battleId).update({ status: 'finished' });
                    }
                }
            }, 2000);
        }

        function showBattleResults() {
            showScreen('battleResultsScreen');
            db.ref('battles/' + gameState.battleId + '/players').once('value', snap => {
                const p = snap.val() || {};
                document.getElementById('finalName1').textContent = p.host?.name || 'Host';
                document.getElementById('finalAvatar1').textContent = p.host?.avatar || 'ü¶ä';
                document.getElementById('finalScore1').textContent = p.host?.score || 0;
                document.getElementById('finalName2').textContent = p.guest?.name || 'Guest';
                document.getElementById('finalAvatar2').textContent = p.guest?.avatar || 'üêº';
                document.getElementById('finalScore2').textContent = p.guest?.score || 0;
                
                const myKey = gameState.isBattleHost ? 'host' : 'guest';
                const oppKey = gameState.isBattleHost ? 'guest' : 'host';
                const myScore = p[myKey]?.score || 0;
                const oppScore = p[oppKey]?.score || 0;
                
                if (myScore > oppScore) {
                    document.getElementById('battleResultIcon').textContent = 'üèÜ';
                    document.getElementById('battleResultTitle').textContent = '¬°Victoria!';
                    document.getElementById('battleXP').textContent = '+75 XP';
                    addXP(75);
                    playSound('victory');
                    createConfetti();
                } else if (myScore < oppScore) {
                    document.getElementById('battleResultIcon').textContent = 'üò¢';
                    document.getElementById('battleResultTitle').textContent = 'Derrota';
                    document.getElementById('battleXP').textContent = '+25 XP';
                    addXP(25);
                } else {
                    document.getElementById('battleResultIcon').textContent = 'ü§ù';
                    document.getElementById('battleResultTitle').textContent = '¬°Empate!';
                    document.getElementById('battleXP').textContent = '+50 XP';
                    addXP(50);
                }
            });
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
